<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>izesquad ‚Äî LIVE</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700;900&display=swap');

- { margin:0; padding:0; box-sizing:border-box; }

:root {
‚Äìbg: #0a0e1a;
‚Äìcard: #141929;
‚Äìcard-active: #1a2040;
‚Äìborder: #262d45;
‚Äìtext: #e8eaf0;
‚Äìtext-dim: #6b7394;
‚Äìblue: #4f7cff;
‚Äìgreen: #22c55e;
‚Äìred: #ef4444;
‚Äìorange: #f59e0b;
‚Äìpurple: #a78bfa;
‚Äìcyan: #22d3ee;
}

body {
font-family: ‚ÄòKanit‚Äô, sans-serif;
background: var(‚Äìbg);
color: var(‚Äìtext);
min-height: 100vh;
overflow-x: hidden;
}

/* Header */
.header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 16px 28px;
border-bottom: 1px solid var(‚Äìborder);
background: linear-gradient(180deg, #10152a 0%, var(‚Äìbg) 100%);
}
.header-left {
display: flex;
align-items: center;
gap: 14px;
}
.logo {
font-size: 28px;
font-weight: 900;
letter-spacing: -1px;
background: linear-gradient(135deg, var(‚Äìblue), var(‚Äìcyan));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
}
.live-dot {
display: inline-flex;
align-items: center;
gap: 6px;
font-size: 13px;
font-weight: 600;
color: var(‚Äìgreen);
text-transform: uppercase;
letter-spacing: 1px;
}
.live-dot::before {
content: ‚Äò‚Äô;
width: 8px; height: 8px;
background: var(‚Äìgreen);
border-radius: 50%;
animation: pulse-dot 1.5s ease-in-out infinite;
}
@keyframes pulse-dot {
0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34,197,94,.6); }
50% { opacity: .7; box-shadow: 0 0 0 8px rgba(34,197,94,0); }
}
.header-right {
display: flex;
align-items: center;
gap: 16px;
font-size: 14px;
color: var(‚Äìtext-dim);
}
.session-badge {
display: inline-block;
padding: 4px 14px;
border-radius: 20px;
font-size: 13px;
font-weight: 600;
letter-spacing: 0.5px;
}
.session-on { background: rgba(34,197,94,.15); color: var(‚Äìgreen); border: 1px solid rgba(34,197,94,.3); }
.session-off { background: rgba(107,115,148,.15); color: var(‚Äìtext-dim); border: 1px solid var(‚Äìborder); }

/* Courts grid */
.courts-grid {
display: grid;
gap: 20px;
padding: 24px 28px;
}
.courts-1 { grid-template-columns: 1fr; }
.courts-2 { grid-template-columns: repeat(2, 1fr); }
.courts-3 { grid-template-columns: repeat(3, 1fr); }
.courts-4 { grid-template-columns: repeat(2, 1fr); }
.courts-5, .courts-6 { grid-template-columns: repeat(3, 1fr); }

/* Court card */
.court-card {
background: var(‚Äìcard);
border: 1px solid var(‚Äìborder);
border-radius: 16px;
overflow: hidden;
transition: all .3s ease;
}
.court-card.active {
background: var(‚Äìcard-active);
border-color: rgba(79,124,255,.3);
box-shadow: 0 0 30px rgba(79,124,255,.08);
}
.court-header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 16px 20px;
border-bottom: 1px solid var(‚Äìborder);
}
.court-label {
font-size: 20px;
font-weight: 700;
color: var(‚Äìtext);
}
.court-status {
font-size: 14px;
font-weight: 600;
padding: 4px 14px;
border-radius: 20px;
}
.status-playing {
background: rgba(79,124,255,.15);
color: var(‚Äìblue);
border: 1px solid rgba(79,124,255,.3);
}
.status-countdown {
background: rgba(245,158,11,.15);
color: var(‚Äìorange);
border: 1px solid rgba(245,158,11,.3);
}
.status-empty {
background: rgba(107,115,148,.1);
color: var(‚Äìtext-dim);
border: 1px solid var(‚Äìborder);
}
.court-body { padding: 20px; }
.court-body.empty {
display: flex;
align-items: center;
justify-content: center;
min-height: 140px;
color: var(‚Äìtext-dim);
font-size: 16px;
}

/* Timer */
.timer-area {
text-align: center;
margin-bottom: 16px;
}
.timer-val {
font-size: 48px;
font-weight: 900;
font-variant-numeric: tabular-nums;
letter-spacing: 2px;
color: var(‚Äìtext);
}
.timer-val.countdown { color: var(‚Äìorange); }
.timer-label {
font-size: 12px;
color: var(‚Äìtext-dim);
margin-top: 2px;
text-transform: uppercase;
letter-spacing: 1px;
}

/* Teams */
.vs-area {
display: grid;
grid-template-columns: 1fr auto 1fr;
gap: 12px;
align-items: center;
}
.team {
display: flex;
flex-direction: column;
gap: 8px;
}
.team-label {
font-size: 11px;
font-weight: 700;
text-transform: uppercase;
letter-spacing: 1.5px;
margin-bottom: 2px;
}
.team-a .team-label { color: var(‚Äìblue); }
.team-b .team-label { color: var(‚Äìred); }
.team-b { text-align: right; }

.player-row {
display: flex;
align-items: center;
gap: 10px;
}
.team-b .player-row {
flex-direction: row-reverse;
}
.player-avatar {
width: 44px; height: 44px;
border-radius: 50%;
object-fit: cover;
border: 2px solid var(‚Äìborder);
background: var(‚Äìborder);
}
.team-a .player-avatar { border-color: rgba(79,124,255,.4); }
.team-b .player-avatar { border-color: rgba(239,68,68,.4); }

.player-info {}
.player-name {
font-size: 16px;
font-weight: 600;
line-height: 1.2;
}
.player-rank {
font-size: 11px;
color: var(‚Äìtext-dim);
}

.vs-divider {
display: flex;
align-items: center;
justify-content: center;
}
.vs-text {
font-size: 20px;
font-weight: 900;
color: var(‚Äìtext-dim);
text-transform: uppercase;
letter-spacing: 2px;
}

/* Queue section */
.queue-section {
padding: 0 28px 24px;
}
.section-title {
font-size: 16px;
font-weight: 700;
color: var(‚Äìtext-dim);
text-transform: uppercase;
letter-spacing: 1.5px;
margin-bottom: 12px;
display: flex;
align-items: center;
gap: 8px;
}
.section-title .count {
background: var(‚Äìborder);
padding: 2px 10px;
border-radius: 10px;
font-size: 13px;
color: var(‚Äìtext);
}
.queue-list {
display: flex;
flex-wrap: wrap;
gap: 10px;
}
.queue-chip {
display: flex;
align-items: center;
gap: 8px;
background: var(‚Äìcard);
border: 1px solid var(‚Äìborder);
border-radius: 12px;
padding: 8px 14px 8px 8px;
}
.queue-chip img {
width: 32px; height: 32px;
border-radius: 50%;
object-fit: cover;
background: var(‚Äìborder);
}
.queue-chip .q-name {
font-size: 14px;
font-weight: 600;
}
.queue-chip .q-wait {
font-size: 11px;
color: var(‚Äìtext-dim);
}
.queue-chip.next {
border-color: rgba(34,197,94,.3);
background: rgba(34,197,94,.08);
}
.queue-chip.next .q-name { color: var(‚Äìgreen); }

/* Resting */
.rest-chip {
display: flex;
align-items: center;
gap: 8px;
background: var(‚Äìcard);
border: 1px solid var(‚Äìborder);
border-radius: 12px;
padding: 8px 14px 8px 8px;
opacity: .6;
}
.rest-chip img {
width: 32px; height: 32px;
border-radius: 50%;
object-fit: cover;
background: var(‚Äìborder);
}
.rest-chip .q-name { font-size: 14px; font-weight: 600; }

/* Event info */
.event-bar {
padding: 10px 28px;
background: rgba(79,124,255,.06);
border-bottom: 1px solid var(‚Äìborder);
display: flex;
align-items: center;
gap: 16px;
font-size: 14px;
color: var(‚Äìtext-dim);
}
.event-bar .ev-name {
font-weight: 700;
color: var(‚Äìtext);
font-size: 15px;
}
.event-bar .ev-loc { color: var(‚Äìpurple); }

/* Clock */
.clock {
font-variant-numeric: tabular-nums;
font-weight: 600;
color: var(‚Äìtext-dim);
}

/* No session */
.no-session {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
min-height: 60vh;
text-align: center;
color: var(‚Äìtext-dim);
}
.no-session .emoji { font-size: 64px; margin-bottom: 16px; }
.no-session .msg { font-size: 22px; font-weight: 600; }
.no-session .sub { font-size: 15px; margin-top: 8px; }

/* Responsive */
@media (max-width: 768px) {
.courts-2, .courts-3 { grid-template-columns: 1fr; }
.timer-val { font-size: 36px; }
.player-name { font-size: 14px; }
.player-avatar { width: 36px; height: 36px; }
}
</style>

</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">izesquad</div>
    <span class="live-dot">LIVE</span>
  </div>
  <div class="header-right">
    <span id="session-status" class="session-badge session-off">OFF</span>
    <span class="clock" id="clock">--:--:--</span>
  </div>
</div>

<div id="event-bar" class="event-bar" style="display:none">
  <span>üè∏</span>
  <span class="ev-name" id="ev-name"></span>
  <span class="ev-loc" id="ev-loc"></span>
</div>

<div id="courts-area" class="courts-grid courts-2"></div>

<div id="queue-section" class="queue-section" style="display:none">
  <div class="section-title">
    ‚è≥ ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠ <span class="count" id="queue-count">0</span>
  </div>
  <div class="queue-list" id="queue-list"></div>
</div>

<div id="rest-section" class="queue-section" style="display:none">
  <div class="section-title">
    üò¥ ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô <span class="count" id="rest-count">0</span>
  </div>
  <div class="queue-list" id="rest-list"></div>
</div>

<div id="no-session" class="no-session" style="display:none">
  <div class="emoji">üè∏</div>
  <div class="msg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Session</div>
  <div class="sub">‡∏£‡∏≠ Admin ‡πÄ‡∏õ‡∏¥‡∏î Session</div>
</div>

<script>
  let dashboard = null;
  let courtTimers = {};

  // Clock
  function updateClock() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2,'0');
    const m = String(now.getMinutes()).padStart(2,'0');
    const s = String(now.getSeconds()).padStart(2,'0');
    document.getElementById('clock').textContent = `${h}:${m}:${s}`;
  }
  setInterval(updateClock, 1000);
  updateClock();

  function fmtTime(sec) {
    const mm = String(Math.floor(sec / 60)).padStart(2, '0');
    const ss = String(sec % 60).padStart(2, '0');
    return `${mm}:${ss}`;
  }

  function escHtml(s) {
    const d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
  }

  function imgErr(el) {
    el.src = 'https://ui-avatars.com/api/?name=?&background=262d45&color=e8eaf0&size=44';
  }

  async function refresh() {
    try {
      const res = await fetch('/api/get_dashboard');
      if (res.status === 304) return;
      dashboard = await res.json();
    } catch(e) {
      console.error('TV refresh error:', e);
      return;
    }
    render();
  }

  function render() {
    if (!dashboard) return;

    const active = !!dashboard.system?.is_session_active;
    const sb = document.getElementById('session-status');
    sb.textContent = active ? 'SESSION ON' : 'OFF';
    sb.className = 'session-badge ' + (active ? 'session-on' : 'session-off');

    // Event bar
    const evBar = document.getElementById('event-bar');
    const curEvtId = dashboard.system?.current_event_id;
    if (curEvtId && dashboard.events) {
      const evt = dashboard.events.find(e => e.id === curEvtId || e.event_id === curEvtId);
      if (evt) {
        document.getElementById('ev-name').textContent = evt.name || 'Session';
        const loc = evt.location;
        document.getElementById('ev-loc').textContent = loc ? `üìç ${loc}` : '';
        evBar.style.display = 'flex';
      } else {
        evBar.style.display = 'none';
      }
    } else {
      evBar.style.display = 'none';
    }

    // No session overlay
    document.getElementById('no-session').style.display = active ? 'none' : 'flex';

    // Courts
    const courtsArea = document.getElementById('courts-area');
    const courts = dashboard.courts || {};
    const courtIds = Object.keys(courts).sort((a,b) => +a - +b);
    const n = courtIds.length || 2;
    courtsArea.className = `courts-grid courts-${Math.min(n, 6)}`;

    let html = '';
    courtIds.forEach(cid => {
      const m = courts[cid];
      const isActive = !!m;
      html += `<div class="court-card ${isActive ? 'active' : ''}">`;
      html += `<div class="court-header">`;
      html += `<span class="court-label">üè∏ Court ${cid}</span>`;
      if (!m) {
        html += `<span class="court-status status-empty">‡∏ß‡πà‡∏≤‡∏á</span>`;
      } else if (!m.started) {
        html += `<span class="court-status status-countdown">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß</span>`;
      } else {
        html += `<span class="court-status status-playing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô</span>`;
      }
      html += `</div>`;

      if (!m) {
        html += `<div class="court-body empty">‚Äî ‡∏ß‡πà‡∏≤‡∏á ‚Äî</div>`;
      } else {
        html += `<div class="court-body">`;

        // Timer
        const sec = m.started ? m.elapsed_sec : m.countdown_sec;
        const cls = m.started ? '' : 'countdown';
        const label = m.started ? '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô';
        html += `<div class="timer-area">`;
        html += `<div class="timer-val ${cls}" id="timer-${cid}">${fmtTime(sec)}</div>`;
        html += `<div class="timer-label">${label}</div>`;
        html += `</div>`;

        // Teams VS
        html += `<div class="vs-area">`;
        html += `<div class="team team-a"><div class="team-label">Team A</div>`;
        (m.team_a || []).forEach(p => {
          html += `<div class="player-row">`;
          html += `<img class="player-avatar" src="${escHtml(p.pictureUrl)}" onerror="imgErr(this)">`;
          html += `<div class="player-info">`;
          html += `<div class="player-name">${escHtml(p.nickname)}</div>`;
          html += `<div class="player-rank">${p.unranked ? p.mmr_display : p.rank_title}</div>`;
          html += `</div></div>`;
        });
        html += `</div>`;

        html += `<div class="vs-divider"><span class="vs-text">VS</span></div>`;

        html += `<div class="team team-b"><div class="team-label">Team B</div>`;
        (m.team_b || []).forEach(p => {
          html += `<div class="player-row">`;
          html += `<div class="player-info">`;
          html += `<div class="player-name">${escHtml(p.nickname)}</div>`;
          html += `<div class="player-rank">${p.unranked ? p.mmr_display : p.rank_title}</div>`;
          html += `</div>`;
          html += `<img class="player-avatar" src="${escHtml(p.pictureUrl)}" onerror="imgErr(this)">`;
          html += `</div>`;
        });
        html += `</div>`;
        html += `</div>`; // vs-area

        html += `</div>`; // court-body
      }
      html += `</div>`; // court-card
    });
    courtsArea.innerHTML = html;

    // Store timer data for client-side ticking
    courtTimers = {};
    courtIds.forEach(cid => {
      const m = courts[cid];
      if (m) {
        courtTimers[cid] = {
          started: m.started,
          elapsed: m.elapsed_sec,
          countdown: m.countdown_sec,
          lastTick: Date.now()
        };
      }
    });

    // Queue
    const queue = dashboard.queue || [];
    const qSec = document.getElementById('queue-section');
    document.getElementById('queue-count').textContent = queue.length;
    if (queue.length > 0 && active) {
      qSec.style.display = 'block';
      let qhtml = '';
      queue.forEach((p, i) => {
        const isNext = i < 4;
        qhtml += `<div class="queue-chip ${isNext ? 'next' : ''}">`;
        qhtml += `<img src="${escHtml(p.pictureUrl)}" onerror="imgErr(this)">`;
        qhtml += `<div>`;
        qhtml += `<div class="q-name">${escHtml(p.nickname)}</div>`;
        qhtml += `<div class="q-wait">${p.wait_min || 0} ‡∏ô‡∏≤‡∏ó‡∏µ</div>`;
        qhtml += `</div></div>`;
      });
      document.getElementById('queue-list').innerHTML = qhtml;
    } else {
      qSec.style.display = 'none';
    }

    // Resting
    const resting = dashboard.resting || [];
    const rSec = document.getElementById('rest-section');
    document.getElementById('rest-count').textContent = resting.length;
    if (resting.length > 0 && active) {
      rSec.style.display = 'block';
      let rhtml = '';
      resting.forEach(p => {
        rhtml += `<div class="rest-chip">`;
        rhtml += `<img src="${escHtml(p.pictureUrl)}" onerror="imgErr(this)">`;
        rhtml += `<div>`;
        rhtml += `<div class="q-name">${escHtml(p.nickname)}</div>`;
        rhtml += `</div></div>`;
      });
      document.getElementById('rest-list').innerHTML = rhtml;
    } else {
      rSec.style.display = 'none';
    }
  }

  // Client-side timer ticking (every 1s)
  function tickTimers() {
    const now = Date.now();
    for (const cid in courtTimers) {
      const t = courtTimers[cid];
      const delta = Math.floor((now - t.lastTick) / 1000);
      const el = document.getElementById(`timer-${cid}`);
      if (!el) continue;
      if (t.started) {
        el.textContent = fmtTime(t.elapsed + delta);
      } else {
        el.textContent = fmtTime(Math.max(0, t.countdown - delta));
      }
    }
  }
  setInterval(tickTimers, 1000);

  // Poll
  refresh();
  setInterval(() => refresh().catch(e => console.error(e)), 6000);
</script>

</body>
</html>
