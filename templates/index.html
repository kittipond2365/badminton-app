<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Arena</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

    <div class="navbar bg-white shadow-sm px-4 sticky top-0 z-50">
        <div class="flex-1">
            <span class="text-xl font-bold text-blue-600">üè∏ Ize'Squad</span>
        </div>
        <div class="flex-none gap-2">
            <div class="text-right mr-2">
                <div id="user-role-badge"></div>
                <div class="badge badge-neutral badge-sm" id="user-mmr">...</div>
            </div>
            <div class="avatar">
                <div class="w-10 rounded-full"><img id="user-img" src="https://ui-avatars.com/api/?name=U" /></div>
            </div>
        </div>
    </div>

    <div class="flex justify-center mt-2 px-4">
        <div role="tablist" class="tabs tabs-boxed w-full font-bold">
            <a role="tab" class="tab tab-active" onclick="switchTab('live', this)">‡∏™‡∏ô‡∏≤‡∏°</a>
            <a role="tab" class="tab" onclick="switchTab('events', this)">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠</a>
            <a role="tab" class="tab hidden staff-only" onclick="switchTab('billing', this)">‡∏Ñ‡∏¥‡∏î‡∏ï‡∏±‡∏á</a>
            <a role="tab" class="tab hidden super-only" onclick="switchTab('super', this)">‡∏ö‡∏≠‡∏™</a>
        </div>
    </div>

    <div id="tab-live" class="p-4 max-w-md mx-auto">
        <div class="card bg-white shadow-md mb-4 border-l-4 border-primary">
            <div class="card-body p-4 text-center">
                <h3 class="font-bold text-gray-700">‡∏à‡∏∏‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                <div id="status-text" class="text-sm text-gray-500 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ...</div>
                <button id="btn-action" onclick="toggleStatus()" class="btn btn-primary w-full">Check-in</button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-bold">‡∏™‡∏ô‡∏≤‡∏° (Live)</h2>
            <div id="court-ctrl" class="hidden join staff-only">
                <button onclick="changeCourts(-1)" class="btn btn-xs join-item">-</button>
                <button class="btn btn-xs join-item bg-gray-200">Court</button>
                <button onclick="changeCourts(1)" class="btn btn-xs join-item">+</button>
            </div>
        </div>
        <div id="courts-container" class="space-y-3 mb-6"></div>

        <div id="match-btn" class="hidden staff-only mb-6">
            <button onclick="triggerMatchmake()" class="btn btn-accent w-full font-bold shadow text-white">‚ö° ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (Staff)</button>
        </div>

        <h2 class="text-lg font-bold mb-2">‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô (<span id="queue-count">0</span>)</h2>
        <div class="bg-white rounded-box shadow overflow-hidden">
            <table class="table table-xs"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Rank</th><th>‡∏£‡∏≠</th></tr></thead><tbody id="queue-list"></tbody></table>
        </div>
    </div>

    <div id="tab-events" class="p-4 max-w-md mx-auto hidden">
        <div class="hidden staff-only card bg-base-200 mb-4 p-4">
            <h3 class="font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πä‡∏ß‡∏ô</h3>
            <input id="evt-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="input input-sm w-full mb-2">
            <input type="datetime-local" id="evt-time" class="input input-sm w-full mb-2">
            <button onclick="createEvent()" class="btn btn-sm btn-primary w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
        </div>
        <div id="events-container" class="space-y-3"></div>
    </div>

    <div id="tab-billing" class="p-4 max-w-md mx-auto hidden">
        <div class="card bg-white shadow-xl p-4">
            <h2 class="card-title text-green-600 mb-4">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô (Staff)</h2>
            <div class="mb-2"><label class="label font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="bill-total" class="input input-bordered w-full"></div>
            <div class="flex gap-2 mb-4"><input type="number" id="def-hr" value="2" class="input input-bordered w-1/2" placeholder="‡∏ä‡∏°"><input type="number" id="def-min" value="0" class="input input-bordered w-1/2" placeholder="‡∏ô"></div>
            <button onclick="prepBill()" class="btn btn-primary btn-sm w-full mb-4">‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
            <div id="bill-inputs" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
            <button onclick="calcBill()" class="btn btn-success text-white w-full">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            <div id="bill-res" class="hidden mt-4 bg-green-50 p-2 rounded"><table class="table table-xs w-full"><tbody id="bill-body"></tbody></table></div>
        </div>
    </div>

    <div id="tab-super" class="p-4 max-w-md mx-auto hidden">
        <div class="card bg-white shadow-xl p-4">
            <h2 class="card-title text-purple-600 mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Moderator</h2>
            <p class="text-xs text-gray-500 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á/‡∏õ‡∏•‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Mod</p>
            <select id="all-players-select" class="select select-bordered w-full mb-2"></select>
            <button onclick="toggleMod()" class="btn btn-neutral w-full mb-4">‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á / ‡∏õ‡∏•‡∏î</button>
            
            <h3 class="font-bold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Mod ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
            <ul id="mod-list" class="list-disc pl-5 text-sm mt-2"></ul>
            
            <div class="divider"></div>
            <h3 class="font-bold text-red-500">üîß ‡πÅ‡∏Å‡πâ Rank (Staff)</h3>
            <select id="rank-select" class="select select-bordered w-full mb-2"></select>
            <div class="join w-full"><input type="number" id="new-rank" class="input input-bordered join-item w-full" placeholder="Rank"><button onclick="setRank()" class="btn btn-error join-item">Save</button></div>
            
            <div class="divider"></div>
            <p class="text-xs text-center text-gray-300">My ID: <span id="my-id-display"></span></p>
        </div>
    </div>

    <dialog id="modal_finish" class="modal">
        <div class="modal-box text-center">
            <h3 class="font-bold">‡∏à‡∏ö‡πÄ‡∏Å‡∏° Court <span id="md-cid"></span></h3>
            <p class="py-4">‡πÉ‡∏Ñ‡∏£‡∏ä‡∏ô‡∏∞?</p>
            <div class="flex justify-center gap-4"><button onclick="subRes('A')" class="btn btn-primary">Team A</button><button onclick="subRes('B')" class="btn btn-error text-white">Team B</button></div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script>
        const LIFF_ID = "2009064792-6RT6YKWO"; // <--- ‡πÉ‡∏™‡πà LIFF ID ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        let user = null; let selCid=null;

        function switchTab(n, b) {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('tab-active')); b.classList.add('tab-active');
            ['live','events','billing','super'].forEach(t=>document.getElementById('tab-'+t).classList.add('hidden'));
            document.getElementById('tab-'+n).classList.remove('hidden');
        }

        async function main() {
            try {
                await liff.init({liffId:LIFF_ID}); if(!liff.isLoggedIn()){liff.login();return;}
                const p = await liff.getProfile();
                const res = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:p.userId, displayName:p.displayName, pictureUrl:p.pictureUrl})});
                user = await res.json();
                
                renderUser();
                document.getElementById('my-id-display').innerText = user.id;

                // Role Logic
                if(user.role === 'super') {
                    document.querySelectorAll('.super-only').forEach(e=>e.classList.remove('hidden'));
                    document.querySelectorAll('.staff-only').forEach(e=>e.classList.remove('hidden'));
                    loadAllPlayers();
                } else if(user.role === 'mod') {
                    document.querySelectorAll('.staff-only').forEach(e=>e.classList.remove('hidden'));
                    // Mod ‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ Rank ‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ (‡∏¢‡∏∑‡∏°‡∏´‡∏ô‡πâ‡∏≤ Super ‡πÅ‡∏ï‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô Mod)
                    document.getElementById('tab-super').innerHTML = document.getElementById('tab-super').innerHTML; // Refresh
                    // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á Mod ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mod ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
                    // (‡∏ó‡∏≥‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ Mod ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ó‡πá‡∏ö Mod ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô)
                    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢: Mod ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô Tab 'super' ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢ '‡πÅ‡∏Å‡πâ Rank' ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà Billing ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥ Tab ‡πÅ‡∏¢‡∏Å
                    // *‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç* ‡πÉ‡∏´‡πâ Mod ‡πÄ‡∏´‡πá‡∏ô Tab 'super' ‡πÅ‡∏ï‡πà Backend ‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á
                    document.getElementById('tab-super').classList.remove('hidden'); // ‡πÉ‡∏´‡πâ Mod ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏Å‡πâ Rank
                    document.querySelector('[onclick="switchTab(\'super\', this)"]').classList.remove('hidden');
                }

                refresh(); setInterval(refresh, 3000);
            } catch(e){alert(e)}
        }

        function renderUser(){
            document.getElementById('user-role-badge').innerHTML = user.role=='super'?'<span class="badge badge-warning">Super Admin</span>':(user.role=='mod'?'<span class="badge badge-accent">Mod</span>':'');
            document.getElementById('user-mmr').innerText = user.mmr;
            document.getElementById('user-img').src = user.pictureUrl;
            const b = document.getElementById('btn-action'); const t = document.getElementById('status-text');
            if(user.status=='active'){b.innerText="Check-out"; b.classList.replace('btn-primary','btn-outline'); t.innerText="üü¢ ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß";}
            else if(user.status=='playing'){b.innerText="Playing"; b.disabled=true; t.innerText="üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô";}
            else{b.innerText="Check-in"; b.classList.replace('btn-outline','btn-primary'); b.disabled=false; t.innerText="‚ö´ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤";}
        }

        async function toggleStatus(){ 
            const r=await fetch('/api/toggle_status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id})}); 
            user.status=(await r.json()).status; renderUser(); refresh(); 
        }

        async function refresh(){
            const d=await(await fetch('/api/get_dashboard')).json();
            // Courts
            const cc=document.getElementById('courts-container'); cc.innerHTML='';
            for(const[id,m] of Object.entries(d.courts)){
                if(m){
                    const min=Math.floor(m.elapsed/60); const sec=m.elapsed%60;
                    // ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏ö‡πÄ‡∏Å‡∏°: Admin, Mod, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏•‡πà‡∏ô
                    const canEnd = (user.role==='super' || user.role==='mod' || [...m.team_a,...m.team_b].map(p=>p.id).includes(user.id));
                    cc.innerHTML+=`<div class="card bg-white shadow p-3 border border-blue-100"><div class="flex justify-between text-xs text-gray-400 mb-1"><span>C${id}</span><span class="text-green-600 font-bold">${min}:${sec<10?'0'+sec:sec}</span></div><div class="flex justify-between items-center"><div class="font-bold text-blue-700 text-sm w-1/3 text-center">${m.team_a.map(p=>p.name.split(' ')[0]).join('/')}</div><div class="italic text-gray-300 font-black">VS</div><div class="font-bold text-red-700 text-sm w-1/3 text-center">${m.team_b.map(p=>p.name.split(' ')[0]).join('/')}</div></div>${canEnd?`<button onclick="selCid=${id};document.getElementById('modal_finish').showModal();document.getElementById('md-cid').innerText=${id}" class="btn btn-xs btn-success w-full mt-2 text-white">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>`:''}</div>`;
                } else cc.innerHTML+=`<div class="card bg-base-200 p-4 text-center text-gray-400 border border-dashed text-sm">C${id} ‡∏ß‡πà‡∏≤‡∏á</div>`;
            }
            // Queue & Events
            document.getElementById('queue-count').innerText=d.queue_count;
            document.getElementById('queue-list').innerHTML=d.queue.map(p=>`<tr><td>${p.name.split(' ')[0]}</td><td>${p.mmr}</td><td>${Math.floor((Date.now()/1000-p.last_active)/60)}m</td></tr>`).join('');
            document.getElementById('events-container').innerHTML=d.events.map(e=>`<div class="card bg-white shadow-sm border-l-4 border-primary p-3"><h3 class="font-bold">${e.name}</h3><div class="flex justify-between mt-1"><span class="text-xs text-gray-500">${e.datetime.replace('T',' ')} (${e.player_count} ‡∏Ñ‡∏ô)</span><button onclick="joinEvt('${e.id}')" class="btn btn-xs btn-outline">Join</button></div></div>`).join('');
            // Mod List
            if(d.mods) document.getElementById('mod-list').innerHTML = d.mods.map(m=>`<li>${m.name}</li>`).join('');
        }

        // --- ACTIONS ---
        async function createEvent(){ await fetch('/api/admin/create_event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,name:document.getElementById('evt-name').value,datetime:document.getElementById('evt-time').value})}); alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß'); refresh();}
        async function joinEvt(eid){ const r=await fetch('/api/event/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id,eventId:eid})}); alert((await r.json()).status); refresh();}
        async function triggerMatchmake(){ const r=await(await fetch('/api/matchmake',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id})})).json(); if(r.status!='matched')alert(r.message); else refresh();}
        async function changeCourts(d){ await fetch('/api/admin/set_courts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,count:document.querySelectorAll('#courts-container>div').length+d})}); refresh();}
        async function subRes(w){ await fetch('/api/submit_result',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({courtId:selCid,winner:w,requesterId:user.id})}); document.getElementById('modal_finish').close(); refresh();}

        // --- BILLING ---
        async function prepBill(){
            const d=await(await fetch('/api/get_dashboard')).json();
            const all=[]; Object.values(d.courts).forEach(m=>{if(m)[...m.team_a,...m.team_b].forEach(p=>all.push(p))}); d.queue.forEach(p=>all.push(p));
            const u=[...new Map(all.map(p=>[p.id,p])).values()].sort((a,b)=>a.name.localeCompare(b.name));
            const hr=document.getElementById('def-hr').value; const mn=document.getElementById('def-min').value;
            document.getElementById('bill-inputs').innerHTML=u.map(p=>`<div class="flex justify-between items-center bg-gray-50 p-1 rounded"><span class="text-xs font-bold w-1/3 truncate">${p.name}</span><div class="flex gap-1"><input type="number" data-uid="${p.id}" data-type="hr" value="${hr}" class="input input-xs w-10 text-center"><input type="number" data-uid="${p.id}" data-type="min" value="${mn}" class="input input-xs w-10 text-center"></div></div>`).join('');
        }
        async function calcBill(){
            const ps=[]; document.querySelectorAll('#bill-inputs>div').forEach(d=>{
                const i=d.querySelectorAll('input'); ps.push({id:i[0].dataset.uid, name:d.querySelector('span').innerText, minutes:parseInt(i[0].value)*60+parseInt(i[1].value)})
            });
            const r=await(await fetch('/api/admin/calculate_bill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,totalExpense:document.getElementById('bill-total').value,players:ps})})).json();
            if(r.error)return alert(r.error);
            document.getElementById('bill-res').classList.remove('hidden');
            document.getElementById('bill-body').innerHTML=r.bill_list.map(b=>`<tr><td>${b.name}</td><td class="text-right text-xs">${b.time}</td><td class="text-right font-bold text-green-700">${b.cost}</td></tr>`).join('');
        }

        // --- SUPER / STAFF ---
        async function loadAllPlayers(){
            const ps=await(await fetch('/api/get_all_players')).json(); 
            const h=ps.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('all-players-select').innerHTML=h;
            document.getElementById('rank-select').innerHTML=h;
        }
        async function toggleMod(){
            const tid=document.getElementById('all-players-select').value;
            const r=await(await fetch('/api/super/toggle_mod',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,targetId:tid})})).json();
            if(r.error) alert(r.error); else { alert(r.status); refresh(); }
        }
        async function setRank(){
            const tid=document.getElementById('rank-select').value; const mmr=document.getElementById('new-rank').value;
            await fetch('/api/admin/set_rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,targetId:tid,mmr})});
            alert('Saved'); loadAllPlayers();
        }

        main();
    </script>
</body>
</html>