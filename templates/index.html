<!DOCTYPE html>
<html data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>izesquad</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>var vConsole = new VConsole();</script>

  <style>
    .fade-in { animation: fade .2s ease-in; }
    @keyframes fade { from {opacity:0} to {opacity:1} }
    .player-row:hover { background: #f8fafc; }
  </style>
</head>

<body class="bg-slate-100 min-h-screen pb-24">

  <!-- NAV -->
  <div class="navbar bg-white shadow-sm px-4 sticky top-0 z-50">
    <div class="flex-1">
      <span class="text-xl font-black text-indigo-600 italic">izesquad</span>
      <span class="text-xs font-bold text-indigo-500 ml-2" id="session-pill"></span>
    </div>
    <div class="flex-none gap-2 items-center">
      <button id="btn-admin" class="btn btn-circle btn-ghost text-red-600 hidden"
        onclick="document.getElementById('modal_admin').showModal()">
        <i class="fa-solid fa-gear text-xl"></i>
      </button>
      <button id="btn-bill" class="btn btn-circle btn-ghost text-green-600 hidden"
        onclick="openBillingModal()">
        <i class="fa-solid fa-file-invoice-dollar text-xl"></i>
      </button>

      <div class="text-right">
        <div class="text-[10px] text-gray-500">MMR</div>
        <div class="font-bold text-indigo-600" id="my-mmr">...</div>
      </div>

      <div class="avatar">
        <div class="w-10 rounded-full ring ring-indigo-500 ring-offset-2">
          <img id="my-img" src="https://ui-avatars.com/api/?name=User" />
        </div>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="px-2 mt-3">
    <div role="tablist" class="tabs tabs-boxed bg-white shadow-sm font-bold">
      <a role="tab" id="tab-btn-live" class="tab tab-active" onclick="switchTab('live')">‡∏™‡∏ô‡∏≤‡∏°</a>
      <a role="tab" id="tab-btn-stats" class="tab" onclick="switchTab('stats')">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
      <a role="tab" id="tab-btn-history" class="tab" onclick="switchTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
      <a role="tab" id="tab-btn-lb" class="tab" onclick="switchTab('lb')">Leaderboard</a>
      <a role="tab" id="tab-btn-events" class="tab" onclick="switchTab('events')">Events</a>
    </div>
  </div>

  <!-- LIVE TAB -->
  <div id="tab-live" class="p-4 max-w-md mx-auto fade-in">
    <div id="session-alert" class="hidden alert alert-warning mb-4 shadow-sm">
      <i class="fa-solid fa-triangle-exclamation"></i>
      <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô (‡∏£‡∏≠ Mod ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°)</span>
    </div>

    <div class="card bg-white shadow-md mb-4 border-l-4 border-indigo-500">
      <div class="card-body p-4">
        <div class="flex justify-between items-center mb-2">
          <span class="font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
            <span id="status-badge" class="badge">...</span>
          </span>
          <span id="my-rank-text" class="text-xs font-bold text-gray-400">...</span>
        </div>

        <button id="btn-checkin" onclick="toggleStatusConfirm()" class="btn btn-primary w-full">Loading...</button>

        <div class="grid grid-cols-2 gap-2 mt-2">
          <button id="btn-rest" onclick="toggleRest()" class="btn btn-outline btn-sm w-full hidden">
            <i class="fa-solid fa-mug-hot mr-1"></i> ‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢
          </button>
          <label class="label cursor-pointer justify-start gap-2 bg-slate-50 rounded px-3 py-2 border hidden" id="auto-rest-box">
            <input type="checkbox" class="toggle toggle-sm toggle-primary" id="auto-rest-toggle" onchange="toggleAutoRest(this.checked)"/>
            <span class="label-text text-xs font-bold text-gray-600">‡∏û‡∏±‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
          </label>
        </div>

        <!-- Partner request -->
        <div id="partner-box" class="mt-3 hidden">
          <div class="divider text-xs text-gray-400 my-1">‡∏Ç‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</div>

          <div id="pair-status" class="hidden bg-indigo-50 p-2 rounded border border-indigo-100 text-xs text-indigo-700">
            ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏±‡∏ö <b id="paired-name">...</b>
            <button class="btn btn-xs btn-ghost text-red-500 ml-2" onclick="unpair()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</button>
          </div>

          <div id="outgoing-box" class="hidden bg-slate-50 p-2 rounded border text-xs">
            ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡πâ <b id="outgoing-name">...</b>
            <button class="btn btn-xs btn-ghost text-red-500 ml-2" onclick="cancelOutgoing()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>

          <div id="req-form" class="join w-full">
            <select id="partner-select" class="select select-bordered select-sm w-full join-item text-xs">
              <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>
            </select>
            <button onclick="requestPartner()" class="btn btn-sm btn-primary join-item">‡∏Ç‡∏≠</button>
          </div>

          <div id="incoming-box" class="mt-2 hidden">
            <div class="text-xs font-bold text-gray-500 mb-1">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</div>
            <div id="incoming-list" class="space-y-2"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- Staff court controls -->
    <div id="staff-court-control" class="hidden bg-white p-3 rounded shadow mb-4">
      <div class="flex justify-between items-center">
        <div class="join">
          <button onclick="changeCourt(-1)" class="btn btn-xs join-item">-</button>
          <button class="btn btn-xs join-item bg-white cursor-default" id="court-count-display">2</button>
          <button onclick="changeCourt(1)" class="btn btn-xs join-item">+</button>
        </div>

        <div class="flex gap-2">
          <button onclick="openManualMatch()" class="btn btn-xs btn-neutral">
            <i class="fa-solid fa-hand-pointer"></i> ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏≠‡∏á
          </button>
          <button onclick="matchmakeNow()" class="btn btn-xs btn-primary">
            <i class="fa-solid fa-shuffle"></i> ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </button>
        </div>
      </div>

      <div class="mt-3">
        <div class="text-xs font-bold text-gray-500 mb-2">AutoMatch ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</div>
        <div id="automatch-toggles" class="grid grid-cols-2 gap-2"></div>
      </div>
    </div>

    <!-- Courts -->
    <div id="courts-container" class="space-y-3 mb-6"></div>

    <!-- Queue -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-3">
      <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between">
        <span>‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô</span>
        <span id="q-count" class="badge badge-neutral">0</span>
      </div>
      <div class="px-3 py-2 text-xs text-gray-500">‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
      <table class="table table-sm">
        <tbody id="queue-list"></tbody>
      </table>
    </div>

    <!-- Resting -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between">
        <span>‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢</span>
        <span id="r-count" class="badge badge-ghost">0</span>
      </div>
      <table class="table table-sm">
        <tbody id="rest-list"></tbody>
      </table>
    </div>
  </div>

  <!-- PROFILE TAB (Self quick) -->
  <div id="tab-stats" class="p-4 max-w-md mx-auto hidden">
    <div class="card bg-white shadow-md p-4">
      <div class="flex items-center gap-3">
        <div class="avatar">
          <div class="w-14 rounded-full ring ring-indigo-500 ring-offset-2">
            <img id="me-big-pic" src="">
          </div>
        </div>
        <div class="flex-1">
          <div class="text-lg font-black" id="me-name">...</div>
          <div class="flex gap-2 items-center mt-1">
            <span class="badge" id="me-rank-badge">...</span>
            <span class="badge" id="me-wr-badge">WR ...%</span>
          </div>
          <div class="text-sm font-bold text-indigo-600 mt-1" id="me-mmr-big">...</div>
        </div>
        <button class="btn btn-sm btn-outline" onclick="openProfile(user.id)">
          ‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ï‡πá‡∏°
        </button>
      </div>

      <div class="mt-4">
        <div class="text-xs font-bold text-gray-500 mb-1">Progress</div>
        <progress class="progress progress-primary w-full" id="me-progress" value="0" max="100"></progress>
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span id="me-progress-label">...</span>
          <span id="me-progress-hint">...</span>
        </div>
      </div>

      <!-- Bio & Racket -->
      <div class="mt-4 space-y-2">
        <div id="me-bio-display"></div>
        <div id="me-racket-display"></div>
        <button onclick="toggleBioEdit()" class="btn btn-xs btn-ghost text-indigo-500" id="me-bio-edit-btn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
        <div id="me-bio-form" class="hidden space-y-2 mt-2 p-3 bg-slate-50 rounded border">
          <div>
            <label class="text-xs text-gray-500">üè∏ ‡∏£‡∏∏‡πà‡∏ô‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
            <input id="me-racket-input" class="input input-bordered input-sm w-full" maxlength="60" placeholder="‡πÄ‡∏ä‡πà‡∏ô Yonex Astrox 88D">
          </div>
          <div>
            <label class="text-xs text-gray-500">üìù ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö, ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 150 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)</label>
            <textarea id="me-bio-input" class="textarea textarea-bordered textarea-sm w-full" maxlength="150" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏î‡∏°‡∏≤ 3 ‡∏õ‡∏µ ‡∏ä‡∏≠‡∏ö‡∏ï‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ô‡πá‡∏ï"></textarea>
            <div class="text-right text-[10px] text-gray-400"><span id="me-bio-count">0</span>/150</div>
          </div>
          <div class="flex gap-2">
            <button onclick="saveProfile()" class="btn btn-sm btn-primary flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="clearProfile()" class="btn btn-sm btn-ghost text-red-500">‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div id="tab-history" class="p-4 max-w-md mx-auto hidden">
    <div class="tabs tabs-boxed bg-white mb-3">
      <a class="tab tab-active" id="hist-tab-my" onclick="switchHistory('my')">‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
      <a class="tab" id="hist-tab-global" onclick="switchHistory('global')">Global</a>
    </div>
    <div id="history-list" class="space-y-3"></div>
  </div>

  <!-- LEADERBOARD TAB -->
  <div id="tab-lb" class="p-4 max-w-md mx-auto hidden">
    <div class="tabs tabs-boxed bg-white mb-3">
      <a class="tab tab-active" id="lb-tab-mmr" onclick="switchLB('mmr')">MMR</a>
      <a class="tab" id="lb-tab-points" onclick="switchLB('points')">‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°</a>
      <a class="tab" id="lb-tab-wr" onclick="switchLB('winrate')">Winrate</a>
    </div>
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <table class="table table-sm">
        <tbody id="lb-list"></tbody>
      </table>
    </div>
  </div>

  <!-- EVENTS TAB -->
  <div id="tab-events" class="p-4 max-w-md mx-auto hidden">
    <div class="staff-only hidden mb-4 p-4 bg-white rounded shadow">
      <h3 class="font-bold text-sm mb-2">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Event ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</h3>
      <input id="evt-name" class="input input-bordered input-sm w-full mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πä‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å = ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)">
      <input id="evt-location" class="input input-bordered input-sm w-full mb-2" placeholder="üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">

      <label class="text-xs text-gray-500 ml-1">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° *</label>
      <input id="evt-time" type="datetime-local" class="input input-bordered input-sm w-full mb-2" onchange="onEvtStartChange()">
      <label class="text-xs text-gray-500 ml-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å = ‡πÄ‡∏£‡∏¥‡πà‡∏° +4 ‡∏ä‡∏°. ¬∑ ‡∏õ‡∏¥‡∏î session ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 2 ‡∏ä‡∏°. ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö)</label>
      <input id="evt-end-time" type="datetime-local" class="input input-bordered input-sm w-full mb-2 opacity-50" disabled>

      <div class="grid grid-cols-2 gap-2 mb-2">
        <select id="evt-points" class="select select-bordered select-sm w-full">
          <option value="21" selected>‡πÅ‡∏ï‡πâ‡∏° 21</option>
          <option value="11">‡πÅ‡∏ï‡πâ‡∏° 11</option>
        </select>
        <select id="evt-bo" class="select select-bordered select-sm w-full">
          <option value="1" selected>BO1</option>
          <option value="2">BO2</option>
          <option value="3">BO3</option>
        </select>
      </div>

      <label class="label cursor-pointer justify-start gap-2 mb-2">
        <input type="checkbox" class="checkbox checkbox-sm checkbox-primary" id="evt-notify">
        <span class="label-text text-xs">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
      </label>

      <button onclick="submitNewEvent()" class="btn btn-primary btn-sm w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button>
    </div>
    <div id="events-list" class="space-y-3"></div>
  </div>

  <!-- MODALS -->
  <dialog id="modal_finish" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">‡∏à‡∏ö‡πÄ‡∏Å‡∏° Court <span id="fin-cid"></span></h3>
      <div class="text-xs text-gray-500 mt-1" id="fin-rule"></div>

      <!-- BUG FIX: show team names in score modal for clarity -->
      <div class="mt-2 grid grid-cols-2 gap-2 text-center text-xs">
        <div class="bg-red-50 rounded p-1 font-bold text-red-600" id="fin-team-a">Team A</div>
        <div class="bg-blue-50 rounded p-1 font-bold text-blue-600" id="fin-team-b">Team B</div>
      </div>

      <div class="mt-3 space-y-3" id="score-inputs"></div>

      <div class="mt-3 flex gap-2">
        <button class="btn btn-error text-white flex-1" onclick="cancelThisMatch()">Cancel match</button>
        <button class="btn btn-primary flex-1" onclick="submitScore()">Submit</button>
      </div>

      <form method="dialog" class="mt-2 text-center">
        <button class="btn btn-ghost btn-sm">‡∏õ‡∏¥‡∏î</button>
      </form>
    </div>
  </dialog>

  <dialog id="modal_manual_match" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-3">üñê ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏≠‡∏á</h3>
      <select id="man-court" class="select select-bordered select-sm w-full mb-2"></select>

      <div class="grid grid-cols-2 gap-2 mb-3">
        <div class="bg-red-50 p-2 rounded">
          <div class="font-bold text-red-500 text-xs">TEAM A</div>
          <select id="man-p1" class="select select-bordered select-xs w-full mb-1 player-select"></select>
          <select id="man-p2" class="select select-bordered select-xs w-full player-select"></select>
        </div>
        <div class="bg-blue-50 p-2 rounded">
          <div class="font-bold text-blue-500 text-xs">TEAM B</div>
          <select id="man-p3" class="select select-bordered select-xs w-full mb-1 player-select"></select>
          <select id="man-p4" class="select select-bordered select-xs w-full player-select"></select>
        </div>
      </div>

      <button onclick="submitManualMatch()" class="btn btn-primary w-full">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á</button>
      <form method="dialog" class="mt-2 text-center"><button class="btn btn-ghost btn-sm">‡∏õ‡∏¥‡∏î</button></form>
    </div>
  </dialog>

  <dialog id="modal_admin" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4 text-red-600">Admin Panel</h3>

      <div class="mb-4 p-4 bg-red-50 rounded-lg border border-red-100">
        <h4 class="font-bold text-sm mb-2">Session Control</h4>

        <div class="grid grid-cols-2 gap-2 mb-2">
          <select id="sess-points" class="select select-bordered select-sm w-full">
            <option value="21" selected>‡πÅ‡∏ï‡πâ‡∏° 21</option>
            <option value="11">‡πÅ‡∏ï‡πâ‡∏° 11</option>
          </select>
          <select id="sess-bo" class="select select-bordered select-sm w-full">
            <option value="1" selected>BO1</option>
            <option value="2">BO2</option>
            <option value="3">BO3</option>
          </select>
        </div>

        <label class="label cursor-pointer justify-start gap-2 mb-2">
          <input type="checkbox" class="checkbox checkbox-sm checkbox-primary" id="sess-notify">
          <span class="label-text text-sm">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏™‡∏µ‡∏¢‡∏á+‡∏™‡∏±‡πà‡∏ô‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ)</span>
        </label>

        <button onclick="toggleSession('start')" class="btn btn-success text-white w-full mb-2">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô</button>
        <button onclick="toggleSession('end')" class="btn btn-error text-white w-full">üèÅ ‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô</button>
      </div>

      <!-- BUG FIX: Complete super admin section with mod promote/demote + MMR edit -->
      <div id="super-admin-section" class="mb-4 hidden">
        <h4 class="font-bold text-sm mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (Super Admin)</h4>
        <div class="h-64 overflow-y-auto border rounded p-2 bg-white">
          <table class="table table-xs">
            <thead>
              <tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Role</th><th class="text-right">Actions</th></tr>
            </thead>
            <tbody id="admin-user-list"></tbody>
          </table>
        </div>

        <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded">
          <h4 class="font-bold text-sm text-red-600 mb-2">‚ö†Ô∏è Danger Zone</h4>
          <div class="flex flex-col gap-2">
            <button onclick="hardResetStats()" class="btn btn-sm btn-outline btn-warning w-full">üîÑ Reset ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏á MMR/‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô)</button>
            <button onclick="hardResetAll()" class="btn btn-sm btn-error text-white w-full">üí£ Hard Reset ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏•‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á)</button>
          </div>
        </div>
      </div>

      <!-- Mod-level: MMR edit for any player -->
      <div id="mod-mmr-section" class="mb-4 hidden">
        <h4 class="font-bold text-sm mb-2">‡πÅ‡∏Å‡πâ MMR ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h4>
        <div class="join w-full">
          <select id="mmr-target-select" class="select select-bordered select-sm join-item w-full">
            <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô --</option>
          </select>
          <input id="mmr-new-value" type="number" class="input input-bordered input-sm join-item w-24" placeholder="MMR">
          <button onclick="submitSetMMR()" class="btn btn-sm btn-warning join-item">Set</button>
        </div>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn">‡∏õ‡∏¥‡∏î</button></form>
      </div>
    </div>
  </dialog>

  <!-- BUG FIX: Add missing MMR edit modal -->
  <dialog id="modal_edit_mmr" class="modal">
    <div class="modal-box max-w-xs">
      <h3 class="font-bold text-lg mb-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç MMR</h3>
      <div class="text-sm mb-2">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <b id="edit-mmr-name">...</b></div>
      <div class="text-sm mb-2">MMR ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="edit-mmr-current">...</b></div>
      <input id="edit-mmr-input" type="number" class="input input-bordered w-full mb-3" placeholder="MMR ‡πÉ‡∏´‡∏°‡πà">
      <input id="edit-mmr-uid" type="hidden">
      <button onclick="confirmSetMMR()" class="btn btn-warning w-full">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <form method="dialog" class="mt-2 text-center"><button class="btn btn-ghost btn-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></form>
    </div>
  </dialog>

  <dialog id="modal_billing" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
      <h3 class="font-bold text-lg mb-2 text-green-600">üí∞ Billing</h3>

      <div class="grid grid-cols-1 gap-3 mb-4 bg-gray-50 p-3 rounded-lg border">
        <select id="bill-event-select" class="select select-bordered select-sm w-full" onchange="loadBillPlayers()">
          <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Session --</option>
        </select>

        <div class="grid grid-cols-2 gap-2">
          <input id="bill-total-cost" type="number" class="input input-bordered input-sm w-full" placeholder="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°" oninput="calculateBill()">
          <input id="bill-default-hr" type="number" class="input input-bordered input-sm w-full" value="2" oninput="applyDefaultTime()">
        </div>
      </div>

      <div class="overflow-x-auto max-h-64 mb-4 border rounded">
        <table class="table table-xs table-pin-rows">
          <thead>
            <tr class="bg-gray-200">
              <th>‡∏ä‡∏∑‡πà‡∏≠</th><th class="w-16">‡∏ä‡∏°.</th><th class="w-16">‡∏ô‡∏≤‡∏ó‡∏µ</th><th class="text-right">‡∏ö‡∏≤‡∏ó</th>
            </tr>
          </thead>
          <tbody id="bill-player-list"></tbody>
        </table>
      </div>

      <div class="flex justify-between items-center bg-green-100 p-3 rounded mb-4">
        <span class="font-bold text-green-800">‡∏£‡∏ß‡∏°:</span>
        <span id="bill-grand-total" class="font-black text-xl text-green-800">0</span>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button></form>
        <button class="btn btn-success text-white" onclick="copyBillSummary()">Copy</button>
      </div>
    </div>
  </dialog>

  <dialog id="modal_profile" class="modal">
    <div class="modal-box max-w-md">
      <div class="flex items-center gap-3">
        <div class="avatar">
          <div class="w-14 rounded-full ring ring-indigo-500 ring-offset-2">
            <img id="pf-pic" src="">
          </div>
        </div>
        <div class="flex-1">
          <div class="text-lg font-black" id="pf-name">...</div>
          <div class="flex gap-2 items-center mt-1">
            <span class="badge" id="pf-rank">...</span>
            <span class="badge" id="pf-wr">WR ...%</span>
          </div>
          <div class="text-sm font-bold text-indigo-600 mt-1" id="pf-mmr">...</div>
        </div>
      </div>

      <div class="mt-4">
        <div class="text-xs font-bold text-gray-500 mb-1">Progress</div>
        <progress class="progress progress-primary w-full" id="pf-progress" value="0" max="100"></progress>
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span id="pf-progress-label">...</span>
          <span id="pf-progress-hint">...</span>
        </div>
      </div>

      <!-- Bio & Racket (read-only) -->
      <div id="pf-bio-section" class="mt-3 space-y-1 hidden">
        <div id="pf-racket-line" class="hidden text-xs"><span class="text-gray-400">üè∏</span> <span id="pf-racket" class="font-bold text-gray-700"></span></div>
        <div id="pf-bio-line" class="hidden text-xs text-gray-600 bg-slate-50 rounded p-2 border italic"></div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-2">
        <div class="bg-slate-50 p-2 rounded border">
          <div class="text-[10px] text-gray-500">Sets W/L</div>
          <div class="font-black text-gray-700" id="pf-sets">0/0</div>
        </div>
        <div class="bg-slate-50 p-2 rounded border">
          <div class="text-[10px] text-gray-500">Match W/L</div>
          <div class="font-black text-gray-700" id="pf-matches">0/0</div>
        </div>
        <div class="bg-slate-50 p-2 rounded border">
          <div class="text-[10px] text-gray-500">Points For</div>
          <div class="font-black text-gray-700" id="pf-pf">0</div>
        </div>
        <div class="bg-slate-50 p-2 rounded border">
          <div class="text-[10px] text-gray-500">Points Against</div>
          <div class="font-black text-gray-700" id="pf-pa">0</div>
        </div>
      </div>

      <div class="mt-4">
        <div class="text-sm font-bold text-gray-600 mb-2">10 ‡πÄ‡∏Å‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div id="pf-last10" class="space-y-2"></div>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn">‡∏õ‡∏¥‡∏î</button></form>
      </div>
    </div>
  </dialog>

  <!-- SCRIPT -->
  <script>
    // BUG FIX: Use the actual LIFF ID instead of placeholder
    const LIFF_ID = "2009064792-6RT6YKWO";

    let user = null;
    let dashboard = null;
    let selectedCid = null;
    let historyMode = "my";
    let lbMode = "mmr";
    let _dashboardEtag = null;  // #2: ETag for conditional polling

    let lastNotifiedMatchId = localStorage.getItem("lastMatchId") || "";

    // BUG FIX: client-side timers for courts (update every second between polls)
    let courtTimerInterval = null;

    function switchTab(t){
      document.querySelectorAll('.tab').forEach(e=>e.classList.remove('tab-active'));
      ['live','stats','history','lb','events'].forEach(x=>{
        const el=document.getElementById('tab-'+x);
        if(el) el.classList.add('hidden');
      });
      document.getElementById('tab-btn-'+t).classList.add('tab-active');
      document.getElementById('tab-'+t).classList.remove('hidden');
      if(t === 'events') initEvtTimeMin();
    }

    function switchHistory(mode){
      historyMode = mode;
      document.getElementById('hist-tab-my').classList.toggle('tab-active', mode==='my');
      document.getElementById('hist-tab-global').classList.toggle('tab-active', mode==='global');
      renderHistory();
    }

    function switchLB(mode){
      lbMode = mode;
      document.getElementById('lb-tab-mmr').classList.toggle('tab-active', mode==='mmr');
      document.getElementById('lb-tab-points').classList.toggle('tab-active', mode==='points');
      document.getElementById('lb-tab-wr').classList.toggle('tab-active', mode==='winrate');
      renderLeaderboards();
    }

    async function main(){
      if(location.hostname.includes("localhost")){
        await apiLogin("U1cf933e3a1559608c50c0456f6583dc9", "Admin Pond", "https://ui-avatars.com/api/?name=A");
      }else{
        try{
          await liff.init({liffId: LIFF_ID});
          if(!liff.isLoggedIn()) liff.login();
          const p = await liff.getProfile();
          await apiLogin(p.userId, p.displayName, p.pictureUrl);
        }catch(e){
          console.error("Init Error:", e);
          alert("Init Error: " + e);
        }
      }
    }

    async function apiLogin(uid, name, pic){
      const res = await fetch('/api/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId: uid, displayName: name, pictureUrl: pic})
      });
      user = await res.json();
      renderUserTop();
      try{ await refresh(); }catch(e){ console.error("Initial refresh error:", e); }
      setInterval(()=>{ refresh().catch(e=>console.error("Poll error:", e)); }, 6000);

      // BUG FIX: start client-side court timer (updates every second)
      if(courtTimerInterval) clearInterval(courtTimerInterval);
      courtTimerInterval = setInterval(updateCourtTimersClient, 1000);
    }

    function renderUserTop(){
      if(!user) return;
      document.getElementById('my-img').src = user.pictureUrl || "https://ui-avatars.com/api/?name=User";
      document.getElementById('my-mmr').innerText = user.mmr_display || "...";
      document.getElementById('my-rank-text').innerText = user.rank_title || "...";

      document.getElementById('me-big-pic').src = user.pictureUrl || "https://ui-avatars.com/api/?name=User";
      document.getElementById('me-name').innerText = user.nickname || "User";
      document.getElementById('me-mmr-big').innerText = user.mmr_display || "...";
      document.getElementById('me-rank-badge').className = `badge ${user.rank_color||'badge-primary'}`;
      document.getElementById('me-rank-badge').innerText = user.rank_title || "...";
      document.getElementById('me-wr-badge').className = `badge ${user.wr_badge||'badge-ghost'}`;
      document.getElementById('me-wr-badge').innerText = `WR ${user.wr||0}%`;

      const prog = user.progress || {pct:0,label:"",type:"mmr"};
      document.getElementById('me-progress').value = prog.pct || 0;
      document.getElementById('me-progress-label').innerText = prog.label || "";
      document.getElementById('me-progress-hint').innerText = prog.type === "calib"
        ? "calibrating"
        : (prog.to_up != null ? `to up: ${prog.to_up}` : "");

      // Bio & Racket display on my profile tab
      renderMyBioRacket();
    }

    function renderMyBioRacket(){
      const bio = user.bio || "";
      const racket = user.racket || "";
      const bioDisp = document.getElementById('me-bio-display');
      const rktDisp = document.getElementById('me-racket-display');

      if(racket){
        rktDisp.innerHTML = `<div class="text-xs"><span class="text-gray-400">üè∏</span> <span class="font-bold text-gray-700">${escHtml(racket)}</span></div>`;
      } else {
        rktDisp.innerHTML = '';
      }
      if(bio){
        bioDisp.innerHTML = `<div class="text-xs text-gray-600 bg-slate-50 rounded p-2 border italic">${escHtml(bio)}</div>`;
      } else {
        bioDisp.innerHTML = '';
      }
    }

    function escHtml(s){
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function toggleBioEdit(){
      const form = document.getElementById('me-bio-form');
      const isHidden = form.classList.contains('hidden');
      form.classList.toggle('hidden');
      if(isHidden){
        document.getElementById('me-bio-input').value = user.bio || "";
        document.getElementById('me-racket-input').value = user.racket || "";
        document.getElementById('me-bio-count').innerText = (user.bio||"").length;
        document.getElementById('me-bio-edit-btn').innerText = "‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";

        document.getElementById('me-bio-input').oninput = function(){
          document.getElementById('me-bio-count').innerText = this.value.length;
        };
      } else {
        document.getElementById('me-bio-edit-btn').innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå";
      }
    }

    async function saveProfile(){
      const bio = document.getElementById('me-bio-input').value.trim();
      const racket = document.getElementById('me-racket-input').value.trim();
      const r = await (await fetch('/api/update_profile',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, bio, racket})
      })).json();
      if(r.error) return alert(r.error);
      user.bio = r.bio;
      user.racket = r.racket;
      document.getElementById('me-bio-form').classList.add('hidden');
      document.getElementById('me-bio-edit-btn').innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå";
      renderMyBioRacket();
      toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß!");
    }

    async function clearProfile(){
      if(!confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏∏‡πà‡∏ô‡πÑ‡∏°‡πâ?")) return;
      const r = await (await fetch('/api/update_profile',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, bio:"", racket:""})
      })).json();
      if(r.error) return alert(r.error);
      user.bio = "";
      user.racket = "";
      document.getElementById('me-bio-input').value = "";
      document.getElementById('me-racket-input').value = "";
      document.getElementById('me-bio-count').innerText = "0";
      document.getElementById('me-bio-form').classList.add('hidden');
      document.getElementById('me-bio-edit-btn').innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå";
      renderMyBioRacket();
      toast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß");
    }

    function beepAndVibrate(){
      try{
        if(navigator.vibrate) navigator.vibrate([200,80,200]);
      }catch(e){}
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        gain.gain.value = 0.03;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        setTimeout(()=>{ osc.stop(); ctx.close(); }, 180);
      }catch(e){}
    }

    function isStaff(){
      return user && (user.role === "super" || user.role === "mod");
    }

    async function refresh(){
      try {
        const headers = {};
        if(_dashboardEtag) headers['If-None-Match'] = _dashboardEtag;
        const res = await fetch('/api/get_dashboard', {headers});

        // #2: 304 Not Modified ‚Äî nothing changed, skip all rendering
        if(res.status === 304) return;

        dashboard = await res.json();
        _dashboardEtag = res.headers.get('ETag') || null;
      } catch(e) {
        console.error("refresh failed:", e);
        return;
      }

      const sessActive = !!dashboard.system?.is_session_active;
      document.getElementById('session-pill').innerText = sessActive ? "SESSION ON" : "";
      document.getElementById('session-pill').className = sessActive
        ? "text-xs font-bold text-green-500 ml-2"
        : "text-xs font-bold text-indigo-500 ml-2";
      document.getElementById('session-alert').classList.toggle('hidden', sessActive);

      if(isStaff()){
        document.getElementById('btn-admin').classList.remove('hidden');
        document.getElementById('btn-bill').classList.remove('hidden');
        document.getElementById('staff-court-control').classList.remove('hidden');
        document.querySelectorAll('.staff-only').forEach(e=>e.classList.remove('hidden'));
        // BUG FIX: show mod MMR section for staff
        document.getElementById('mod-mmr-section').classList.remove('hidden');
        renderModMMRSelect();
      }
      if(user && user.role === "super"){
        document.getElementById('super-admin-section').classList.remove('hidden');
      }

      // update user from dashboard
      if(dashboard.all_players && user){
        const me = dashboard.all_players.find(p=>p.id===user.id);
        if(me){
          user.status = me.status;
          user.mmr_display = me.unranked ? `UNRANK (${me.calib_played}/10)` : String(me.mmr);
          user.rank_title = me.rank_title;
          user.rank_color = me.rank_color;
          user.wr = me.wr;
          user.wr_badge = me.wr_badge;
          if(me.progress) user.progress = me.progress;
        }
      }
      renderUserTop();
      renderCheckinArea(sessActive);
      renderAutomatchToggles();
      renderCourts();
      renderQueueAndRest();
      renderEvents();
      renderLeaderboards();
      renderHistory();
      renderPartnerArea();
      renderAdminUserList();

      // notify when matched
      if(dashboard.system?.notify_enabled){
        for(const [cid, st] of Object.entries(dashboard.courts||{})){
          if(!st) continue;
          const isMeIn = [...st.team_a, ...st.team_b].some(x=>x.id===user.id);
          if(isMeIn && st.match_id && st.match_id !== lastNotifiedMatchId){
            lastNotifiedMatchId = st.match_id;
            localStorage.setItem("lastMatchId", lastNotifiedMatchId);
            beepAndVibrate();
            toast(`Matched! Court ${cid}`);
          }
        }
      }
    }

    function toast(msg){
      const t = document.createElement('div');
      t.className = "toast toast-top toast-center z-[999]";
      t.innerHTML = `<div class="alert alert-info shadow"><span>${msg}</span></div>`;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2500);
    }

    function renderCheckinArea(sessActive){
      const btn = document.getElementById('btn-checkin');
      const badge = document.getElementById('status-badge');
      const restBtn = document.getElementById('btn-rest');
      const autoRestBox = document.getElementById('auto-rest-box');

      if(!sessActive){
        btn.disabled = true;
        btn.className = "btn btn-disabled w-full";
        btn.innerText = "‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πä‡∏ß‡∏ô...";
        badge.className = "badge badge-warning";
        badge.innerText = "OFF";
        restBtn.classList.add('hidden');
        autoRestBox.classList.add('hidden');
        return;
      }

      btn.disabled = false;
      const st = user.status || "offline";

      if(st === "queue"){
        btn.className = "btn btn-outline btn-error w-full";
        btn.innerText = "‚ùå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
        badge.className = "badge badge-success text-white";
        badge.innerText = "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß";
        restBtn.classList.remove('hidden');
        restBtn.innerHTML = `<i class="fa-solid fa-mug-hot mr-1"></i> ‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢`;
        autoRestBox.classList.remove('hidden');
        const meData = dashboard.all_players ? dashboard.all_players.find(p=>p.id===user.id) : null;
        document.getElementById('auto-rest-toggle').checked = !!(meData?.auto_rest);
      }else if(st === "resting"){
        btn.className = "btn btn-outline btn-error w-full";
        btn.innerText = "‚ùå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
        badge.className = "badge badge-neutral";
        badge.innerText = "‡∏û‡∏±‡∏Å";
        restBtn.classList.remove('hidden');
        restBtn.innerHTML = `<i class="fa-solid fa-person-walking mr-1"></i> ‡πÄ‡∏•‡∏¥‡∏Å‡∏û‡∏±‡∏Å`;
        autoRestBox.classList.remove('hidden');
        const meData = dashboard.all_players ? dashboard.all_players.find(p=>p.id===user.id) : null;
        document.getElementById('auto-rest-toggle').checked = !!(meData?.auto_rest);
      }else if(st === "playing"){
        btn.className = "btn btn-disabled w-full";
        btn.innerText = "üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô";
        btn.disabled = true;
        badge.className = "badge badge-warning";
        badge.innerText = "‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà";
        restBtn.classList.add('hidden');
        autoRestBox.classList.add('hidden');
      }else{
        btn.className = "btn btn-primary w-full";
        btn.innerText = "‚úÖ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°";
        badge.className = "badge badge-ghost";
        badge.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤";
        restBtn.classList.add('hidden');
        autoRestBox.classList.add('hidden');
      }
    }

    async function toggleStatusConfirm(){
      if(user.status === "offline"){
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°?")) return;
      }else if(user.status === "queue" || user.status === "resting"){
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å? (‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å reset)")) return;
      }
      const r = await (await fetch('/api/toggle_status',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      })).json();
      if(r.error) return alert(r.error);
      await refresh();
    }

    async function toggleRest(){
      const r = await (await fetch('/api/toggle_rest',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      })).json();
      if(r.error) return alert(r.error);
      await refresh();
    }

    async function toggleAutoRest(val){
      await fetch('/api/toggle_auto_rest',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, value:val})
      });
      await refresh();
    }

    function renderAutomatchToggles(){
      if(!isStaff()) return;
      const box = document.getElementById('automatch-toggles');
      const total = Object.keys(dashboard.courts||{}).length || 2;
      document.getElementById('court-count-display').innerText = total;

      box.innerHTML = "";
      for(let i=1;i<=total;i++){
        const cid = String(i);
        const on = !!dashboard.automatch?.[cid];
        const el = document.createElement('div');
        el.className = "flex items-center justify-between bg-slate-50 border rounded px-3 py-2";
        el.innerHTML = `
          <div class="text-xs font-bold text-gray-600">Court ${cid}</div>
          <input type="checkbox" class="toggle toggle-sm toggle-primary" ${on?'checked':''}
            onchange="setAutomatch('${cid}', this.checked)">
        `;
        box.appendChild(el);
      }
    }

    async function setAutomatch(cid, val){
      const r = await (await fetch('/api/admin/set_automatch',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId:cid, value:val})
      })).json();
      if(r.error) alert(r.error);
      await refresh();
    }

    function renderCourts(){
      const cc = document.getElementById('courts-container');
      cc.innerHTML = "";
      const courts = dashboard.courts || {};
      const total = Object.keys(courts).length;

      for(let i=1;i<=total;i++){
        const cid = String(i);
        const st = courts[cid];

        if(!st){
          cc.innerHTML += `<div class="p-4 border-2 border-dashed rounded text-center text-gray-400 text-sm">Court ${cid} ‡∏ß‡πà‡∏≤‡∏á</div>`;
          continue;
        }

        const renderTeam = (arr) => arr.map(p => `
          <div class="flex items-center gap-2 cursor-pointer" onclick="openProfile('${p.id}')">
            <img src="${p.pictureUrl||'https://ui-avatars.com/api/?name=?'}" class="w-6 h-6 rounded-full">
            <div class="flex flex-col leading-tight">
              <span class="text-sm font-bold">${p.nickname}</span>
              <span class="text-[10px] text-gray-500">${p.unranked ? p.mmr_display : p.rank_title}</span>
            </div>
          </div>
        `).join('');

        const canControl = isStaff() || [...st.team_a, ...st.team_b].some(x=>x.id===user.id);

        // BUG FIX: store server timestamps for client-side timer updates
        const timeLabel = st.started
          ? `<span class="court-timer" data-start-at="${st.start_at}">${Math.floor(st.elapsed_sec/60)}:${String(st.elapsed_sec%60).padStart(2,'0')}</span>`
          : `<span class="court-countdown" data-start-at="${st.start_at}">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô ${st.countdown_sec}s</span>`;

        cc.innerHTML += `
          <div class="card bg-white border border-indigo-100 shadow-sm p-3">
            <div class="flex justify-between text-indigo-700 font-bold mb-2">
              <span>COURT ${cid}</span>
              <span class="badge badge-outline">${timeLabel}</span>
            </div>

            <div class="flex items-start justify-between text-sm">
              <div class="flex flex-col gap-2 w-[45%] items-end text-right font-medium">${renderTeam(st.team_a)}</div>
              <div class="font-bold text-red-500 self-center">VS</div>
              <div class="flex flex-col gap-2 w-[45%] items-start text-left font-medium">${renderTeam(st.team_b)}</div>
            </div>

            ${canControl ? `
              <div class="grid grid-cols-2 gap-2 mt-3">
                <button class="btn btn-xs btn-error text-white" onclick="openFinish('${cid}')">‡∏à‡∏ö‡πÄ‡∏Å‡∏°/‡πÉ‡∏™‡πà‡∏™‡∏Å‡∏≠‡∏£‡πå</button>
                <button class="btn btn-xs btn-outline" onclick="cancelMatch('${cid}')">Cancel</button>
              </div>
            ` : ``}
          </div>
        `;
      }
    }

    // BUG FIX: update court timers client-side every second
    function updateCourtTimersClient(){
      const now = Date.now() / 1000;

      document.querySelectorAll('.court-timer').forEach(el => {
        const startAt = parseFloat(el.dataset.startAt || "0");
        if(!startAt) return;
        const elapsed = Math.max(0, Math.floor(now - startAt));
        const min = Math.floor(elapsed / 60);
        const sec = elapsed % 60;
        el.innerText = `${min}:${String(sec).padStart(2,'0')}`;
      });

      document.querySelectorAll('.court-countdown').forEach(el => {
        const startAt = parseFloat(el.dataset.startAt || "0");
        if(!startAt) return;
        const left = Math.max(0, Math.ceil(startAt - now));
        if(left <= 0){
          el.innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!";
          el.classList.add('text-green-600');
        } else {
          el.innerText = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô ${left}s`;
        }
      });

      // Event countdowns
      document.querySelectorAll('.event-countdown').forEach(el => {
        const target = parseFloat(el.dataset.evtTarget || "0");
        if(!target) return;
        const left = Math.max(0, Math.floor(target - now));
        const txt = el.querySelector('.countdown-text');
        if(!txt) return;
        if(left <= 0){
          txt.innerText = "‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß!";
          txt.classList.remove('text-blue-700');
          txt.classList.add('text-green-600');
        } else {
          txt.innerText = formatCountdown(left);
        }
      });
    }

    function renderQueueAndRest(){
      const q = dashboard.queue || [];
      const r = dashboard.resting || [];
      document.getElementById('q-count').innerText = q.length;
      document.getElementById('r-count').innerText = r.length;

      const qList = document.getElementById('queue-list');
      const staffView = isStaff();
      qList.innerHTML = q.length ? q.map((p,i)=>{
        // BUG FIX: use cooldown_left_sec for more accurate display
        const cdSec = p.cooldown_left_sec || 0;
        const cdMin = Math.ceil(cdSec / 60);
        const cd = cdSec > 0 ? `<span class="badge badge-warning badge-xs ml-1">CD ${cdMin}m</span>` : "";
        const pair = p.paired_with ? `<span class="badge badge-secondary badge-xs ml-1">PAIR</span>` : "";
        // Priority badge + skip/cancel button: mod only
        const prio = (staffView && p.priority_match) ? `<span class="badge badge-error badge-xs ml-1">‚ö° ‡πÅ‡∏ã‡∏á‡∏Ñ‡∏¥‡∏ß</span>` : "";
        let skipBtn = '';
        if(staffView){
          if(p.priority_match){
            skipBtn = `<button class="btn btn-xs btn-ghost text-red-500" onclick="event.stopPropagation();cancelSkipQueue('${p.id}')" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏ã‡∏á‡∏Ñ‡∏¥‡∏ß">‚úï</button>`;
          } else {
            skipBtn = `<button class="btn btn-xs btn-ghost text-orange-500" onclick="event.stopPropagation();skipQueue('${p.id}')" title="‡πÅ‡∏ã‡∏á‡∏Ñ‡∏¥‡∏ß">‚ö°</button>`;
          }
        }
        return `
          <tr class="player-row">
            <td onclick="openProfile('${p.id}')" class="cursor-pointer">
              <div class="flex items-center gap-2">
                <img src="${p.pictureUrl||'https://ui-avatars.com/api/?name=?'}" class="w-7 h-7 rounded-full">
                <div class="flex flex-col leading-tight">
                  <span class="font-bold">${p.nickname} ${pair} ${prio}</span>
                  <span class="text-[10px] text-gray-500">${p.unranked ? p.mmr_display : p.rank_title}</span>
                </div>
              </div>
            </td>
            <td class="text-right text-xs text-gray-500 whitespace-nowrap">${p.wait_min||0} ‡∏ô‡∏≤‡∏ó‡∏µ ${cd} ${skipBtn}</td>
          </tr>
        `;
      }).join('') : `<tr><td class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß</td></tr>`;

      const rList = document.getElementById('rest-list');
      rList.innerHTML = r.length ? r.map((p,i)=>{
        // BUG FIX: show cooldown for resting players too
        const cdSec = p.cooldown_left_sec || 0;
        const cdMin = Math.ceil(cdSec / 60);
        const cdLabel = cdSec > 0 ? `<span class="badge badge-warning badge-xs">CD ${cdMin}m</span>` : "";
        return `
          <tr class="player-row">
            <td onclick="openProfile('${p.id}')" class="cursor-pointer">
              <div class="flex items-center gap-2">
                <img src="${p.pictureUrl||'https://ui-avatars.com/api/?name=?'}" class="w-7 h-7 rounded-full">
                <div class="flex flex-col leading-tight">
                  <span class="font-bold">${p.nickname}</span>
                  <span class="text-[10px] text-gray-500">${p.unranked ? p.mmr_display : p.rank_title}</span>
                </div>
              </div>
            </td>
            <td class="text-right text-xs text-gray-500">${p.wait_min||0} ‡∏ô‡∏≤‡∏ó‡∏µ ${cdLabel}</td>
          </tr>
        `;
      }).join('') : `<tr><td class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏û‡∏±‡∏Å</td></tr>`;
    }

    function renderPartnerArea(){
      const box = document.getElementById('partner-box');
      if(!(user.status === "queue" || user.status === "resting")){
        box.classList.add('hidden');
        return;
      }
      box.classList.remove('hidden');

      const me = dashboard.all_players ? dashboard.all_players.find(p=>p.id===user.id) : null;

      const pairStatus = document.getElementById('pair-status');
      const outgoingBox = document.getElementById('outgoing-box');
      const reqForm = document.getElementById('req-form');
      const incomingBox = document.getElementById('incoming-box');

      // show paired
      if(me?.paired_with){
        pairStatus.classList.remove('hidden');
        reqForm.classList.add('hidden');
        outgoingBox.classList.add('hidden');
        document.getElementById('paired-name').innerText = lookupName(me.paired_with);
      }else{
        pairStatus.classList.add('hidden');
        // BUG FIX: only show request form if not already sent outgoing
        if(me?.outgoing_req){
          reqForm.classList.add('hidden');
        } else {
          reqForm.classList.remove('hidden');
        }
      }

      // outgoing
      if(me?.outgoing_req && !me?.paired_with){
        outgoingBox.classList.remove('hidden');
        document.getElementById('outgoing-name').innerText = lookupName(me.outgoing_req);
      }else{
        outgoingBox.classList.add('hidden');
      }

      // partner select options: queue or resting players (not me, not already paired)
      const sel = document.getElementById('partner-select');
      const active = (dashboard.all_players || []).filter(p =>
        (p.status === "queue" || p.status === "resting") && p.id !== user.id && !p.paired_with
      );
      sel.innerHTML = `<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>` + active.map(p=>`<option value="${p.id}">${p.nickname}</option>`).join('');

      // incoming requests
      const incomers = (me?.incoming_reqs || []).filter(x=>x !== user.id);
      if(incomers.length){
        incomingBox.classList.remove('hidden');
        const list = document.getElementById('incoming-list');
        list.innerHTML = incomers.map(id=>{
          const nm = lookupName(id);
          const disabled = !!me?.paired_with;
          return `
            <div class="flex items-center justify-between bg-white border rounded p-2">
              <div class="text-xs font-bold text-gray-700">${nm}</div>
              <div class="flex gap-2">
                <button class="btn btn-xs btn-primary" ${disabled?'disabled':''} onclick="respondReq('${id}','accept')">‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö</button>
                <button class="btn btn-xs btn-ghost text-red-500" onclick="respondReq('${id}','decline')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
              </div>
            </div>
          `;
        }).join('');
      }else{
        incomingBox.classList.add('hidden');
      }
    }

    function lookupName(uid){
      if(!dashboard || !dashboard.all_players) return "Unknown";
      const p = dashboard.all_players.find(x=>x.id===uid);
      return p ? p.nickname : "Unknown";
    }

    async function requestPartner(){
      const targetId = document.getElementById('partner-select').value;
      if(!targetId) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
      const r = await (await fetch('/api/partner/request',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, targetId})
      })).json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function cancelOutgoing(){
      await fetch('/api/partner/cancel_outgoing',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      await refresh();
    }

    async function respondReq(fromId, action){
      const r = await (await fetch('/api/partner/respond',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, fromId, action})
      })).json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function unpair(){
      await fetch('/api/partner/unpair',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      await refresh();
    }

    // staff actions
    async function changeCourt(delta){
      const current = parseInt(document.getElementById('court-count-display').innerText || "2");
      const next = Math.max(1, current + delta);
      const r = await (await fetch('/api/admin/update_courts',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, count: next})
      })).json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function toggleSession(action){
      if(action === "start" && dashboard.system?.is_session_active){
        return alert("Session ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
      }
      if(action === "end" && !confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô?")) return;

      const points = parseInt(document.getElementById('sess-points').value || "21");
      const bo = parseInt(document.getElementById('sess-bo').value || "1");
      const notify = document.getElementById('sess-notify').checked;

      const r = await (await fetch('/api/admin/toggle_session',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, action, points, bo, notify})
      })).json();

      if(r.error) return alert(r.error);

      // Close admin panel
      document.getElementById('modal_admin').close();

      // Show prominent notification
      if(action === "start"){
        toast("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
      } else {
        toast("üèÅ ‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô");
      }

      await refresh();
    }

    async function matchmakeNow(){
      const r = await (await fetch('/api/matchmake',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({})
      })).json();
      if(r.error) alert(r.error);
      else if(!r.success) toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÄ‡∏ï‡πá‡∏°");
      await refresh();
    }

    function openFinish(cid){
      selectedCid = cid;
      document.getElementById('fin-cid').innerText = cid;

      const s = dashboard.system?.scoring || {points:21,bo:1,cap:30};
      document.getElementById('fin-rule').innerText = `Rule: ${s.points}pts, BO${s.bo}, cap ${s.cap} (BO2: ‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°)`;

      // BUG FIX: show team member names in score modal
      const court = dashboard.courts?.[cid];
      if(court){
        document.getElementById('fin-team-a').innerText = "A: " + court.team_a.map(p=>p.nickname).join(', ');
        document.getElementById('fin-team-b').innerText = "B: " + court.team_b.map(p=>p.nickname).join(', ');
      }

      const box = document.getElementById('score-inputs');
      box.innerHTML = "";

      const bo = parseInt(s.bo || 1);
      // BUG FIX: for BO3, show 3 sets but mark set 3 as optional
      for(let i=1;i<=bo;i++){
        const optional = (bo === 3 && i === 3);
        const row = document.createElement('div');
        row.className = "bg-slate-50 border rounded p-2";
        row.innerHTML = `
          <div class="text-xs font-bold text-gray-600 mb-1">Set ${i} ${optional ? '<span class="text-gray-400 font-normal">(‡∏ñ‡πâ‡∏≤‡πÄ‡∏™‡∏°‡∏≠ 1-1)</span>' : ''}</div>
          <div class="grid grid-cols-2 gap-2">
            <input class="input input-bordered input-sm" id="set${i}a" type="number" placeholder="A" min="0">
            <input class="input input-bordered input-sm" id="set${i}b" type="number" placeholder="B" min="0">
          </div>
        `;
        box.appendChild(row);
      }

      document.getElementById('modal_finish').showModal();
    }

    async function cancelMatch(cid){
      if(!confirm("Cancel match ‡∏ô‡∏µ‡πâ? (‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î MMR / ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)")) return;
      const r = await (await fetch('/api/match/cancel',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId: cid})
      })).json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function cancelThisMatch(){
      document.getElementById('modal_finish').close();
      await cancelMatch(selectedCid);
    }

    async function submitScore(){
      const s = dashboard.system?.scoring || {bo:1};
      const bo = parseInt(s.bo || 1);
      const set_scores = [];
      for(let i=1;i<=bo;i++){
        const a = document.getElementById(`set${i}a`).value;
        const b = document.getElementById(`set${i}b`).value;
        // BUG FIX: skip empty sets (e.g. BO3 set 3 not played)
        if(a === "" && b === ""){
          continue;
        }
        // BUG FIX: validate both fields filled if one is
        if((a === "" && b !== "") || (a !== "" && b === "")){
          return alert(`Set ${i}: ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ä‡πà‡∏≠‡∏á`);
        }
        set_scores.push({a: parseInt(a), b: parseInt(b)});
      }

      if(set_scores.length === 0){
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏ã‡∏ï");
      }

      const r = await (await fetch('/api/match/submit',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId: selectedCid, set_scores})
      })).json();

      if(r.error) return alert(r.error);
      document.getElementById('modal_finish').close();
      toast(`Team ${r.winner} ‡∏ä‡∏ô‡∏∞!`);
      await refresh();
    }

    function openManualMatch(){
      const total = Object.keys(dashboard.courts||{}).length || 2;
      const sel = document.getElementById('man-court');
      sel.innerHTML = "";
      // BUG FIX: only show empty courts
      for(let i=1;i<=total;i++){
        const cid = String(i);
        if(dashboard.courts[cid] === null || dashboard.courts[cid] === undefined){
          sel.innerHTML += `<option value="${i}">Court ${i}</option>`;
        }
      }
      if(sel.innerHTML === ""){
        return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ß‡πà‡∏≤‡∏á");
      }

      // BUG FIX: show all active players (queue + resting), not just queue
      const act = (dashboard.all_players || []).filter(p => p.status === "queue" || p.status === "resting");
      const selects = ["man-p1","man-p2","man-p3","man-p4"];
      selects.forEach(id=>{
        const s = document.getElementById(id);
        s.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>` + act.map(p=>`<option value="${p.id}">${p.nickname} (${p.unranked ? 'UNRANK' : p.mmr})</option>`).join('');
      });
      document.getElementById('modal_manual_match').showModal();
    }

    async function submitManualMatch(){
      const courtId = document.getElementById('man-court').value;
      const p1 = document.getElementById('man-p1').value;
      const p2 = document.getElementById('man-p2').value;
      const p3 = document.getElementById('man-p3').value;
      const p4 = document.getElementById('man-p4').value;
      if(!p1||!p2||!p3||!p4) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏Ñ‡∏ô");
      if(new Set([p1,p2,p3,p4]).size !== 4) return alert("‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô");

      const r = await (await fetch('/api/matchmake/manual',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId, playerIds:[p1,p2,p3,p4]})
      })).json();
      if(r.error) alert(r.error);
      document.getElementById('modal_manual_match').close();
      await refresh();
    }

    // Events
    function formatDate(ts){
      const d = new Date((parseFloat(ts)||0) * 1000);
      return d.toLocaleString('th-TH', {day:'2-digit', month:'short', year:'2-digit', hour:'2-digit', minute:'2-digit'});
    }

    function renderEvents(){
      const box = document.getElementById('events-list');
      const events = dashboard.events || [];
      if(!events.length){
        box.innerHTML = `<div class="text-center text-gray-400 py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ events</div>`;
        return;
      }

      box.innerHTML = events.map(e=>{
        const canDel = isStaff();
        const status = e.status || "open";
        const statusColor = status === "active" ? "badge-success" : (status === "ended" ? "badge-ghost" : "badge-info");
        const borderColor = status === "active" ? "border-green-400 border-2" : (status === "open" ? "border-blue-300 border" : "border");
        const bgColor = status === "active" ? "bg-green-50" : "bg-white";

        const scoring = e.scoring || {points:21, bo:1};
        const loc = e.location || "";

        // Pre-registered (only for open events)
        const preReg = e.pre_registered_public || [];
        // Participants (played in active/ended events)
        const parts = e.participants_public || [];

        // Join/Leave button: only for open (future scheduled) events
        const myPreReg = (e.pre_registered || []);
        const iJoined = myPreReg.includes(user.id);
        const joinBtn = status === "open"
          ? (iJoined
            ? `<button class="btn btn-xs btn-outline btn-error" onclick="leaveEvent('${e.id}')"><i class="fa-solid fa-right-from-bracket mr-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`
            : `<button class="btn btn-xs btn-primary" onclick="joinEvent('${e.id}')"><i class="fa-solid fa-right-to-bracket mr-1"></i>Join</button>`)
          : '';

        // Countdown for open future events
        const countdownSec = e.countdown_sec || 0;
        const countdownHtml = (status === "open" && countdownSec > 0)
          ? `<div class="event-countdown text-center mt-2 py-2 bg-blue-50 rounded-lg" data-evt-target="${parseFloat(e.datetime||0)}">
               <span class="text-xs text-blue-500 font-bold">‚è≥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô </span>
               <span class="countdown-text text-sm font-black text-blue-700">${formatCountdown(countdownSec)}</span>
             </div>`
          : '';

        // Settings badge
        const settingsBadge = `<span class="text-xs text-gray-400">${scoring.points}‡πÅ‡∏ï‡πâ‡∏° ¬∑ BO${scoring.bo}</span>`;

        // Location
        const locHtml = loc ? `<div class="text-xs text-gray-500 mt-0.5">üìç ${loc}</div>` : '';

        // End time display
        const endDt = e.end_datetime;
        const endTimeHtml = endDt ? `<div class="text-xs text-gray-400 mt-0.5">üèÅ ‡∏à‡∏ö: ${formatDate(endDt)}</div>` : '';

        // Auto-close countdown for active events
        const autoCloseSec = e.auto_close_sec;
        const autoCloseHtml = (status === "active" && autoCloseSec != null && autoCloseSec > 0)
          ? `<div class="text-xs text-orange-500 mt-1">üîí ‡∏õ‡∏¥‡∏î session ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô ${formatCountdown(autoCloseSec)}</div>`
          : '';

        // Render people section
        function renderPeople(list, label, bgCls){
          if(!list.length) return '';
          return `
            <div class="mt-2">
              <div class="text-xs font-bold text-gray-500 mb-1">${label} (${list.length})</div>
              <div class="flex flex-wrap gap-1.5">
                ${list.map(p=>`
                  <div class="flex items-center gap-1 ${bgCls} border rounded-full px-2 py-0.5 text-xs cursor-pointer" onclick="openProfile('${p.id}')">
                    <img src="${p.pictureUrl||'https://ui-avatars.com/api/?name=?'}" class="w-5 h-5 rounded-full">
                    <span class="font-bold">${p.nickname}</span>
                  </div>
                `).join('')}
              </div>
            </div>`;
        }

        const preRegHtml = renderPeople(preReg, "üôã ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤", "bg-blue-50");
        const partsHtml = renderPeople(parts, "üè∏ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô", "bg-slate-50");

        return `
          <div class="${bgColor} ${borderColor} rounded-xl p-3 shadow-sm">
            <div class="flex justify-between items-start">
              <div class="flex-1 min-w-0">
                <div class="font-black text-gray-800 truncate">${status === "active" ? "üü¢ " : ""}${e.name}</div>
                <div class="text-xs text-gray-500">${formatDate(e.datetime)} ¬∑ <span class="badge badge-xs ${statusColor}">${status.toUpperCase()}</span> ¬∑ ${settingsBadge}</div>
                ${locHtml}
                ${endTimeHtml}
                ${autoCloseHtml}
              </div>
              <div class="flex items-center gap-1 shrink-0 ml-2">
                ${joinBtn}
                ${canDel ? `<button class="btn btn-xs btn-ghost text-red-500" onclick="deleteEvent('${e.id}')"><i class="fa-solid fa-trash"></i></button>` : ``}
              </div>
            </div>
            ${countdownHtml}
            ${preRegHtml}
            ${partsHtml}
          </div>
        `;
      }).join('');
    }

    function formatCountdown(sec){
      if(sec <= 0) return "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!";
      const d = Math.floor(sec / 86400);
      const h = Math.floor((sec % 86400) / 3600);
      const m = Math.floor((sec % 3600) / 60);
      let parts = [];
      if(d > 0) parts.push(`${d} ‡∏ß‡∏±‡∏ô`);
      if(h > 0) parts.push(`${h} ‡∏ä‡∏°.`);
      parts.push(`${m} ‡∏ô‡∏≤‡∏ó‡∏µ`);
      return parts.join(' ');
    }

    // BUG FIX: complete admin user list with promote/demote + MMR edit
    function renderAdminUserList(){
      if(!user || user.role !== "super") return;
      const tbl = document.getElementById('admin-user-list');
      if(!tbl) return;
      const modIds = dashboard.mod_ids || [];

      tbl.innerHTML = (dashboard.all_players||[]).map(p=>{
        const isMod = modIds.includes(p.id);
        const isSuperAdmin = p.id === "U1cf933e3a1559608c50c0456f6583dc9";
        const roleBadge = isSuperAdmin ? '<span class="badge badge-error badge-xs">SUPER</span>'
          : isMod ? '<span class="badge badge-warning badge-xs">MOD</span>'
          : '<span class="badge badge-ghost badge-xs">USER</span>';

        const actions = isSuperAdmin ? '' : `
          ${isMod
            ? `<button class="btn btn-xs btn-ghost text-red-500" onclick="manageMod('${p.id}','demote')">‡∏ñ‡∏≠‡∏î Mod</button>`
            : `<button class="btn btn-xs btn-ghost text-blue-500" onclick="manageMod('${p.id}','promote')">‡∏ï‡∏±‡πâ‡∏á Mod</button>`
          }
          <button class="btn btn-xs btn-ghost text-orange-500" onclick="openEditMMR('${p.id}')">MMR</button>
        `;

        return `
          <tr>
            <td>
              <div class="flex items-center gap-1">
                <img src="${p.pictureUrl||'https://ui-avatars.com/api/?name=?'}" class="w-5 h-5 rounded-full">
                <span class="font-bold text-xs">${p.nickname}</span>
              </div>
            </td>
            <td>${roleBadge}</td>
            <td class="text-right">${actions}</td>
          </tr>
        `;
      }).join('');
    }

    // BUG FIX: add manageMod function
    async function manageMod(targetId, action){
      const actionText = action === "promote" ? "‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Mod" : "‡∏ñ‡∏≠‡∏î‡∏à‡∏≤‡∏Å Mod";
      if(!confirm(`${actionText}: ${lookupName(targetId)}?`)) return;

      const r = await (await fetch('/api/admin/manage_mod',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({requesterId: user.id, targetUserId: targetId, action})
      })).json();
      if(r.error) alert(r.error);
      else toast(`${actionText}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
      await refresh();
    }

    // BUG FIX: add openEditMMR function
    function openEditMMR(uid){
      const p = (dashboard.all_players||[]).find(x=>x.id===uid);
      if(!p) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô");
      document.getElementById('edit-mmr-name').innerText = p.nickname;
      document.getElementById('edit-mmr-current').innerText = p.unranked ? p.mmr_display : p.mmr;
      document.getElementById('edit-mmr-input').value = p.mmr;
      document.getElementById('edit-mmr-uid').value = uid;
      document.getElementById('modal_edit_mmr').showModal();
    }

    // BUG FIX: add confirmSetMMR function
    async function confirmSetMMR(){
      const uid = document.getElementById('edit-mmr-uid').value;
      const newMmr = document.getElementById('edit-mmr-input').value;
      if(!uid || !newMmr) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

      const r = await (await fetch('/api/admin/set_mmr',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({requesterId: user.id, targetUserId: uid, newMmr: parseInt(newMmr)})
      })).json();
      if(r.error) alert(r.error);
      else toast("‡πÅ‡∏Å‡πâ MMR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      document.getElementById('modal_edit_mmr').close();
      await refresh();
    }

    // BUG FIX: render mod MMR select dropdown
    function renderModMMRSelect(){
      const sel = document.getElementById('mmr-target-select');
      if(!sel) return;
      const players = dashboard.all_players || [];
      sel.innerHTML = `<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô --</option>` +
        players.map(p=>`<option value="${p.id}">${p.nickname} (${p.unranked ? 'UNRANK' : p.mmr})</option>`).join('');
    }

    // BUG FIX: add submitSetMMR for mod-level MMR edit
    async function submitSetMMR(){
      const uid = document.getElementById('mmr-target-select').value;
      const newMmr = document.getElementById('mmr-new-value').value;
      if(!uid || !newMmr) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å MMR");

      const r = await (await fetch('/api/admin/set_mmr',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({requesterId: user.id, targetUserId: uid, newMmr: parseInt(newMmr)})
      })).json();
      if(r.error) alert(r.error);
      else toast("‡πÅ‡∏Å‡πâ MMR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      await refresh();
    }

    // --- Event time constraints ---
    function toLocalISOString(d){
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60000);
      return local.toISOString().slice(0,16);
    }

    function initEvtTimeMin(){
      const el = document.getElementById('evt-time');
      if(el) el.min = toLocalISOString(new Date());
    }

    function onEvtStartChange(){
      const startEl = document.getElementById('evt-time');
      const endEl = document.getElementById('evt-end-time');
      if(!startEl.value){
        endEl.disabled = true;
        endEl.classList.add('opacity-50');
        endEl.value = '';
        endEl.min = '';
        return;
      }
      // Enable end time, set min = start time
      endEl.disabled = false;
      endEl.classList.remove('opacity-50');
      endEl.min = startEl.value;
      // If current end is before new start, clear it
      if(endEl.value && endEl.value <= startEl.value) endEl.value = '';
      // Refresh start min to current time
      initEvtTimeMin();
    }

    async function submitNewEvent(){
      const n = document.getElementById('evt-name').value.trim();
      const t = document.getElementById('evt-time').value;
      const tEnd = document.getElementById('evt-end-time').value;
      const loc = document.getElementById('evt-location').value.trim();
      const pts = parseInt(document.getElementById('evt-points').value || "21");
      const bo = parseInt(document.getElementById('evt-bo').value || "1");
      const notify = document.getElementById('evt-notify').checked;

      if(!t) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°");
      const ts = new Date(t).getTime()/1000;

      // Validate not in past
      if(ts < Date.now()/1000 - 60) return alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ");

      // End time: use input or default to start + 4 hours
      let endTs;
      if(tEnd){
        endTs = new Date(tEnd).getTime()/1000;
        if(endTs <= ts) return alert("‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°");
      } else {
        endTs = ts + (4 * 3600); // default +4h
      }

      const body = {userId:user.id, datetime:ts, end_datetime:endTs, points:pts, bo:bo, notify:notify};
      if(n) body.name = n;
      if(loc) body.location = loc;

      const r = await (await fetch('/api/event/create',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      })).json();
      if(r.error) return alert(r.error);
      toast("‡∏™‡∏£‡πâ‡∏≤‡∏á Event ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      document.getElementById('evt-name').value = "";
      document.getElementById('evt-time').value = "";
      document.getElementById('evt-end-time').value = "";
      document.getElementById('evt-end-time').disabled = true;
      document.getElementById('evt-end-time').classList.add('opacity-50');
      document.getElementById('evt-location').value = "";
      await refresh();
    }

    async function deleteEvent(eid){
      if(!confirm("‡∏•‡∏ö event ‡∏ô‡∏µ‡πâ?")) return;
      const r = await (await fetch('/api/event/delete',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, eventId:eid})
      })).json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function joinEvent(eid){
      const r = await (await fetch('/api/event/join',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, eventId:eid})
      })).json();
      if(r.error) return alert(r.error);
      toast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß!");
      await refresh();
    }

    async function leaveEvent(eid){
      if(!confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°?")) return;
      const r = await (await fetch('/api/event/leave',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, eventId:eid})
      })).json();
      if(r.error) return alert(r.error);
      toast("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß");
      await refresh();
    }

    async function skipQueue(targetId){
      if(!confirm("‡πÅ‡∏ã‡∏á‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ?")) return;
      const r = await (await fetch('/api/admin/skip_queue',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, targetId:targetId})
      })).json();
      if(r.error) return alert(r.error);
      if(r.auto_matched){
        toast("‚ö° ‡πÅ‡∏ã‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
      } else {
        toast("‚ö° ‡∏ï‡∏±‡πâ‡∏á Priority ‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠)");
      }
      await refresh();
    }

    async function cancelSkipQueue(targetId){
      const r = await (await fetch('/api/admin/cancel_skip_queue',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, targetId:targetId})
      })).json();
      if(r.error) return alert(r.error);
      toast("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏ã‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß");
      await refresh();
    }

    // Leaderboards
    function renderLeaderboards(){
      const list = document.getElementById('lb-list');
      const lb = dashboard.leaderboards?.[lbMode] || [];
      if(!lb.length){
        list.innerHTML = `<tr><td class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
      }
      list.innerHTML = lb.map((p,i)=>{
        let right = "";
        if(lbMode === "mmr"){
          right = `<div class="font-black text-indigo-600">${p.unranked ? p.mmr_display : p.mmr}</div>`;
        }else if(lbMode === "points"){
          // BUG FIX: use points_for directly from player data (now included in dashboard)
          right = `<div class="font-black text-indigo-600">${p.points_for || 0}</div>`;
        }else{
          right = `<div class="badge ${p.wr_badge}">WR ${p.wr}%</div>`;
        }

        // BUG FIX: highlight current user in leaderboard
        const isMe = p.id === user.id;
        const rowClass = isMe ? "player-row bg-indigo-50" : "player-row";

        return `
          <tr class="${rowClass}">
            <td onclick="openProfile('${p.id}')" class="cursor-pointer">
              <div class="flex items-center gap-2">
                <div class="text-xs font-black text-gray-500 w-6">${i+1}</div>
                <img src="${p.pictureUrl||'https://ui-avatars.com/api/?name=?'}" class="w-8 h-8 rounded-full">
                <div class="flex flex-col leading-tight">
                  <span class="font-bold">${p.nickname} ${isMe ? '‚≠ê' : ''}</span>
                  <span class="text-[10px] text-gray-500">${p.unranked ? p.mmr_display : p.rank_title}</span>
                </div>
              </div>
            </td>
            <td class="text-right">${right}</td>
          </tr>
        `;
      }).join('');
    }

    // History
    function renderHistory(){
      const box = document.getElementById('history-list');
      try {
      const hist = dashboard.history || [];
      if(!hist.length){
        box.innerHTML = `<div class="text-center text-gray-400 py-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
        return;
      }

      const renderTeam = (ids) => ids.map(uid=>{
        const p = (dashboard.all_players||[]).find(x=>x.id===uid);
        if(!p) return `<div class="text-xs text-gray-400">Unknown</div>`;
        return `
          <div class="flex items-center gap-2 cursor-pointer" onclick="openProfile('${uid}')">
            <img src="${p.pictureUrl||'https://ui-avatars.com/api/?name=?'}" class="w-6 h-6 rounded-full">
            <div class="flex flex-col leading-tight">
              <span class="text-xs font-bold">${p.nickname}</span>
              <span class="text-[10px] text-gray-500">${p.unranked ? p.mmr_display : p.rank_title}</span>
            </div>
          </div>
        `;
      }).join('');

      const myId = user.id;
      const filtered = hist.filter(m=>{
        if(!m) return false;
        if(historyMode === "global") return true;
        return ((m.team_a_ids||[]).includes(myId) || (m.team_b_ids||[]).includes(myId));
      });

      if(!filtered.length){
        box.innerHTML = `<div class="text-center text-gray-400 py-6">${historyMode==='my' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'}</div>`;
        return;
      }

      box.innerHTML = filtered.filter(m=>m).map(m=>{
        const winSide = m.winner;
        const isMeA = (m.team_a_ids||[]).includes(myId);
        const isMeB = (m.team_b_ids||[]).includes(myId);
        const meSide = isMeA ? "A" : (isMeB ? "B" : null);
        const iWon = meSide ? (meSide === winSide) : null;

        const myDelta = (m.mmr_changes && m.mmr_changes[myId] != null) ? m.mmr_changes[myId] : null;
        const deltaHtml = (historyMode === "my" && myDelta != null)
          ? `<span class="font-black ${myDelta>=0?'text-green-600':'text-red-500'}">${myDelta>=0?'+':''}${myDelta}</span>`
          : ``;

        const scoreLine = (m.set_scores||[]).map(s=>`${s.a}-${s.b}`).join(' | ');
        const durMin = Math.floor((m.duration_sec||0)/60);

        // BUG FIX: highlight winning team in history
        const teamAWon = winSide === "A";
        const teamBWon = winSide === "B";

        return `
          <div class="bg-white border rounded p-3 shadow-sm">
            <div class="flex justify-between items-center mb-2">
              <div class="text-xs text-gray-500">${new Date((m.end_at||m.created_at||0)*1000).toLocaleString('th-TH',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})} ¬∑ ${durMin}m ¬∑ Court ${m.court_id||'?'}</div>
              <div class="flex items-center gap-2">
                ${historyMode === "my" && meSide ? `<span class="badge ${iWon?'badge-success':'badge-error'} badge-sm">${iWon?'WIN':'LOSS'}</span>` : ``}
                ${historyMode === "global" ? `<span class="badge badge-outline badge-sm">WIN ${winSide}</span>` : ``}
                ${deltaHtml}
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div class="space-y-2 ${teamAWon ? 'bg-green-50 rounded p-1' : ''}">${renderTeam(m.team_a_ids||[])}</div>
              <div class="space-y-2 ${teamBWon ? 'bg-green-50 rounded p-1' : ''}">${renderTeam(m.team_b_ids||[])}</div>
            </div>

            <div class="mt-2 text-xs text-gray-600 flex justify-between">
              <span><b>Score:</b> ${scoreLine}</span>
              <span><b>Total:</b> ${m.total_points_a}-${m.total_points_b}</span>
            </div>
          </div>
        `;
      }).join('');
      } catch(e) { console.error("renderHistory error:", e); box.innerHTML = `<div class="text-center text-gray-400 py-6">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ</div>`; }
    }

    // Billing
    async function openBillingModal(){
      const select = document.getElementById('bill-event-select');
      const events = dashboard.events || [];
      select.innerHTML = '<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Session --</option>';
      events.filter(e=>e.status!=="open").slice(0,10).forEach(e=>{
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.innerText = `${e.name} (${formatDate(e.datetime)})`;
        select.appendChild(opt);
      });
      document.getElementById('modal_billing').showModal();
    }

    function loadBillPlayers(){
      const eid = document.getElementById('bill-event-select').value;
      const evt = (dashboard.events||[]).find(e=>e.id===eid);
      const tbody = document.getElementById('bill-player-list');
      const defHr = document.getElementById('bill-default-hr').value || 2;

      tbody.innerHTML = "";
      const candidates = (evt?.participants_public || []);
      if(!candidates.length){
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</td></tr>`;
        calculateBill();
        return;
      }
      candidates.forEach(u=>{
        tbody.innerHTML += `
          <tr class="bill-row" data-name="${u.nickname}">
            <td>
              <div class="flex items-center gap-2">
                <img src="${u.pictureUrl||'https://ui-avatars.com/api/?name=?'}" class="w-6 h-6 rounded-full">
                <span class="font-bold">${u.nickname}</span>
                <button onclick="this.closest('tr').remove();calculateBill()" class="btn btn-xs btn-ghost text-red-400 rounded-full px-1">x</button>
              </div>
            </td>
            <td><input type="number" class="input input-bordered input-xs w-full bill-hr" value="${defHr}" min="0" oninput="calculateBill()"></td>
            <td><input type="number" class="input input-bordered input-xs w-full bill-min" value="0" min="0" step="5" oninput="calculateBill()"></td>
            <td class="text-right font-bold bill-price">0</td>
          </tr>
        `;
      });
      calculateBill();
    }

    function applyDefaultTime(){
      const def = document.getElementById('bill-default-hr').value;
      document.querySelectorAll('.bill-hr').forEach(el => el.value = def);
      document.querySelectorAll('.bill-min').forEach(el => el.value = 0);
      calculateBill();
    }

    function calculateBill(){
      const totalCost = parseFloat(document.getElementById('bill-total-cost').value) || 0;
      const rows = document.querySelectorAll('.bill-row');

      let totalMinutesPool = 0;
      rows.forEach(row=>{
        const h = parseInt(row.querySelector('.bill-hr').value)||0;
        const m = parseInt(row.querySelector('.bill-min').value)||0;
        totalMinutesPool += (h*60)+m;
      });

      const costPerMin = totalMinutesPool > 0 ? (totalCost / totalMinutesPool) : 0;

      let grand = 0;
      rows.forEach(row=>{
        const h = parseInt(row.querySelector('.bill-hr').value)||0;
        const m = parseInt(row.querySelector('.bill-min').value)||0;
        const myCost = Math.ceil(((h*60)+m) * costPerMin);
        row.querySelector('.bill-price').innerText = myCost;
        grand += myCost;
      });

      document.getElementById('bill-grand-total').innerText = grand;
    }

    async function hardResetStats(){
      if(!confirm("‚ö†Ô∏è Reset ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô?\n(MMR, W/L, Streak, History ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)\n\n‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞ Mod ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà")) return;
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á? ‡∏Å‡∏î‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠ Reset ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥")) return;
      const r = await (await fetch('/api/admin/hard_reset',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, mode:'stats'})
      })).json();
      if(r.error) return alert(r.error);
      toast("üîÑ Reset ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      await refresh();
    }

    async function hardResetAll(){
      if(!confirm("üí£ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!\n\n‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô, ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥, Events, History\n‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô")) return;
      if(!confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ñ‡∏≤‡∏ß‡∏£!")) return;
      if(prompt("‡∏û‡∏¥‡∏°‡∏û‡πå 'RESET' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô") !== "RESET") return alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å");
      const r = await (await fetch('/api/admin/hard_reset',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, mode:'all'})
      })).json();
      if(r.error) return alert(r.error);
      toast("üí£ Hard Reset ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      location.reload();
    }

    function copyBillSummary(){
      const eid = document.getElementById('bill-event-select').value;
      const evt = (dashboard.events||[]).find(e=>e.id===eid);
      const evtName = evt ? evt.name : "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏Å‡πä‡∏ß‡∏ô";

      let txt = `üí∏ ${evtName}\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${document.getElementById('bill-total-cost').value} ‡∏ö‡∏≤‡∏ó\n------------------\n`;
      document.querySelectorAll('.bill-row').forEach(row=>{
        const name = row.dataset.name;
        const price = row.querySelector('.bill-price').innerText;
        const h = row.querySelector('.bill-hr').value;
        const m = row.querySelector('.bill-min').value;
        txt += `${name} (${m>0?`${h}‡∏ä‡∏°.${m}‡∏ô.`:`${h}‡∏ä‡∏°.`}) = ${price}.- \n`;
      });
      txt += `------------------\n‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏à‡πä‡∏∞ üòò`;

      function fallbackCopy(text){
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.cssText = 'position:fixed;left:-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }

      try {
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(txt).then(()=>toast("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!")).catch(()=>{
            fallbackCopy(txt);
            toast("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!");
          });
        } else {
          fallbackCopy(txt);
          toast("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!");
        }
      } catch(e) {
        fallbackCopy(txt);
        toast("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!");
      }
    }

    // Profile modal
    async function openProfile(uid){
      try {
        const r = await (await fetch(`/api/player/${uid}`)).json();
        if(r.error) return alert(r.error);

        document.getElementById('pf-pic').src = r.pictureUrl || "https://ui-avatars.com/api/?name=User";
        document.getElementById('pf-name').innerText = r.nickname;
        document.getElementById('pf-mmr').innerText = r.unranked ? r.mmr_display : `MMR ${r.mmr}`;
        document.getElementById('pf-rank').className = `badge ${r.rank_color||'badge-primary'}`;
        document.getElementById('pf-rank').innerText = r.unranked ? r.mmr_display : r.rank_title;
        document.getElementById('pf-wr').className = `badge ${r.wr_badge||'badge-ghost'}`;
        document.getElementById('pf-wr').innerText = `WR ${r.wr||0}%`;

        const prog = r.progress || {pct:0,label:"",type:"mmr"};
        document.getElementById('pf-progress').value = prog.pct || 0;
        document.getElementById('pf-progress-label').innerText = prog.label || "";
        document.getElementById('pf-progress-hint').innerText = prog.type==="calib" ? "calibrating" : (prog.to_up!=null?`to up: ${prog.to_up}`:"");

        // Bio & Racket
        const bioSec = document.getElementById('pf-bio-section');
        const rktLine = document.getElementById('pf-racket-line');
        const bioLine = document.getElementById('pf-bio-line');
        const hasBio = !!(r.bio);
        const hasRacket = !!(r.racket);

        if(hasBio || hasRacket){
          bioSec.classList.remove('hidden');
          if(hasRacket){
            rktLine.classList.remove('hidden');
            document.getElementById('pf-racket').innerText = r.racket;
          } else {
            rktLine.classList.add('hidden');
          }
          if(hasBio){
            bioLine.classList.remove('hidden');
            bioLine.innerText = r.bio;
          } else {
            bioLine.classList.add('hidden');
          }
        } else {
          bioSec.classList.add('hidden');
        }

        document.getElementById('pf-sets').innerText = `${r.stats.sets_w}/${r.stats.sets_l}`;
        document.getElementById('pf-matches').innerText = `${r.stats.match_w}/${r.stats.match_l}`;
        document.getElementById('pf-pf').innerText = r.stats.points_for;
        document.getElementById('pf-pa').innerText = r.stats.points_against;

        const lastBox = document.getElementById('pf-last10');
        const last = r.last10 || [];
        if(!last.length){
          lastBox.innerHTML = `<div class="text-center text-gray-400 py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
        }else{
          lastBox.innerHTML = last.filter(m=>m&&m.team_a_ids&&m.team_b_ids).map(m=>{
            const isA = (m.team_a_ids||[]).includes(r.id);
            const meSide = isA ? "A" : "B";
            const iWon = m.winner === meSide;
            const delta = (m.mmr_changes && m.mmr_changes[r.id]!=null) ? m.mmr_changes[r.id] : 0;
            const score = (m.set_scores||[]).map(s=>`${s.a}-${s.b}`).join(" | ");

            // BUG FIX: show teammate and opponent names
            const teammates = (isA ? (m.team_a_ids||[]) : (m.team_b_ids||[])).filter(id=>id!==r.id);
            const opponents = isA ? (m.team_b_ids||[]) : (m.team_a_ids||[]);
            const tmName = teammates.map(id=>lookupName(id)).join(', ');
            const oppName = opponents.map(id=>lookupName(id)).join(', ');

            return `
              <div class="bg-slate-50 border rounded p-2 text-xs">
                <div class="flex justify-between items-center">
                  <span class="badge ${iWon?'badge-success':'badge-error'} badge-sm">${iWon?'WIN':'LOSS'}</span>
                  <span class="font-black ${delta>=0?'text-green-600':'text-red-500'}">${delta>=0?'+':''}${delta}</span>
                </div>
                <div class="text-gray-500 mt-1">‡∏Ñ‡∏π‡πà: ${tmName || '-'} | vs ${oppName || '-'}</div>
                <div class="text-gray-600 mt-1">Score: ${score} ¬∑ Total: ${m.total_points_a}-${m.total_points_b}</div>
              </div>
            `;
          }).join('');
        }

        document.getElementById('modal_profile').showModal();
      } catch(e) {
        console.error("openProfile error:", e);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }

    main();
  </script>
</body>
</html>
