<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Smart Arena</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>var vConsole = new VConsole();</script>
</head>
<body class="bg-slate-100 min-h-screen pb-24">

    <div class="navbar bg-white shadow-sm px-4 sticky top-0 z-50">
        <div class="flex-1">
            <span class="text-xl font-bold text-indigo-600"><i class="fa-solid fa-shuttlecock"></i> SMART BAD</span>
        </div>
        <div class="flex-none gap-2">
            <div class="text-right">
                <div class="text-[10px] text-gray-500">MMR</div>
                <div class="font-bold text-indigo-600" id="my-mmr">...</div>
            </div>
            <div class="avatar">
                <div class="w-10 rounded-full ring ring-indigo-500 ring-offset-2">
                    <img id="my-img" src="https://ui-avatars.com/api/?name=User" />
                </div>
            </div>
        </div>
    </div>

    <div class="px-2 mt-3">
        <div role="tablist" class="tabs tabs-boxed bg-white shadow-sm font-bold">
            <a role="tab" class="tab tab-active" onclick="switchTab('live', this)">‡∏™‡∏ô‡∏≤‡∏°</a>
            <a role="tab" class="tab" onclick="switchTab('stats', this)">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (New!)</a>
            <a role="tab" class="tab" onclick="switchTab('rank', this)">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</a>
            <a role="tab" class="tab" onclick="switchTab('manage', this)">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</a>
        </div>
    </div>

    <div id="tab-live" class="p-4 max-w-md mx-auto fade-in">
        <div class="card bg-white shadow-md mb-4 border-l-4 border-indigo-500">
            <div class="card-body p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
                    <span id="status-badge" class="badge">...</span>
                </div>
                <button id="btn-checkin" onclick="toggleStatus()" class="btn btn-indigo w-full">Loading...</button>
            </div>
        </div>

        <h3 class="font-bold text-gray-500 mb-2"><i class="fa-solid fa-video text-red-500"></i> ‡∏™‡∏î‡∏à‡∏≤‡∏Å‡∏™‡∏ô‡∏≤‡∏°</h3>
        <div id="courts-container" class="space-y-3 mb-6"></div>

        <div id="staff-controls" class="hidden mb-6">
            <button onclick="matchmake()" class="btn btn-neutral w-full shadow-lg"><i class="fa-solid fa-bolt text-yellow-400"></i> ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between">
                <span>‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô</span>
                <span id="q-count" class="badge badge-neutral">0</span>
            </div>
            <table class="table table-sm">
                <tbody id="queue-list"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-stats" class="p-4 max-w-md mx-auto hidden">
        <div class="card bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-xl mb-4">
            <div class="card-body p-5 text-center">
                <h2 class="text-lg font-bold opacity-80">WIN RATE</h2>
                <div class="text-5xl font-black my-2" id="st-wr">0%</div>
                <div class="flex justify-center gap-4 text-sm opacity-90">
                    <span>üèÜ ‡∏ä‡∏ô‡∏∞ <b id="st-win">0</b></span>
                    <span>‚ùå ‡πÅ‡∏û‡πâ <b id="st-lose">0</b></span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-white p-3 rounded-xl shadow-sm border border-orange-100">
                <div class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-fire text-orange-500"></i> Win Streak</div>
                <div class="text-xl font-bold text-gray-700" id="st-streak">0</div>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border border-blue-100">
                <div class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-trophy text-blue-500"></i> Total Games</div>
                <div class="text-xl font-bold text-gray-700" id="st-total">0</div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-4 mb-3 border-l-4 border-green-400">
            <h3 class="font-bold text-gray-700 mb-1">ü§ù Best Partner (‡∏Ñ‡∏π‡πà‡∏´‡∏π)</h3>
            <p class="text-sm text-gray-500">‡∏Ñ‡∏π‡πà‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ä‡∏ô‡∏∞‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î</p>
            <div class="text-lg font-bold text-green-600 mt-1" id="st-partner">-</div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-red-400">
            <h3 class="font-bold text-gray-700 mb-1">üòà Nemesis (‡∏Ñ‡∏π‡πà‡∏õ‡∏£‡∏±‡∏ö)</h3>
            <p class="text-sm text-gray-500">‡πÄ‡∏à‡∏≠‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πÑ‡∏£ ‡πÅ‡∏û‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ</p>
            <div class="text-lg font-bold text-red-600 mt-1" id="st-nemesis">-</div>
        </div>
    </div>

    <div id="tab-rank" class="p-4 max-w-md mx-auto hidden">
        <div class="overflow-x-auto bg-white rounded-xl shadow-sm">
            <table class="table">
                <thead><tr class="bg-gray-100"><th>#</th><th>Player</th><th class="text-right">MMR</th></tr></thead>
                <tbody id="lb-list"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-manage" class="p-4 max-w-md mx-auto hidden">
        <div class="staff-only hidden space-y-4">
            <div class="card bg-white shadow p-4">
                <h3 class="font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á Event</h3>
                <input id="evt-name" class="input input-bordered input-sm w-full mt-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πä‡∏ß‡∏ô">
                <input id="evt-time" type="datetime-local" class="input input-bordered input-sm w-full mt-2">
                <button onclick="createEvent()" class="btn btn-sm btn-primary mt-2 w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
            </div>
        </div>
        <div id="events-list" class="mt-4 space-y-2"></div>
    </div>

    <dialog id="modal_finish" class="modal">
        <div class="modal-box text-center">
            <h3 class="font-bold text-lg">‡∏à‡∏ö‡πÄ‡∏Å‡∏° Court <span id="fin-cid"></span></h3>
            <p class="py-4">‡∏ó‡∏µ‡∏°‡πÑ‡∏´‡∏ô‡∏ä‡∏ô‡∏∞?</p>
            <div class="flex gap-2 justify-center">
                <button onclick="submitRes('A')" class="btn btn-primary flex-1">Team A</button>
                <button onclick="submitRes('B')" class="btn btn-error text-white flex-1">Team B</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script>
        const LIFF_ID = "2009064792-6RT6YKWO";
        let user = null;
        let selectedCid = null;

        function switchTab(t, btn) {
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('tab-active'));
            if(btn) btn.classList.add('tab-active');
            ['live','stats','rank','manage'].forEach(x => document.getElementById('tab-'+x).classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
        }

        async function main() {
            // Test Mode Check
            if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
                await mockLogin();
            } else {
                try {
                    await liff.init({liffId: LIFF_ID});
                    if(!liff.isLoggedIn()) { liff.login(); return; }
                    const p = await liff.getProfile();
                    await apiLogin(p.userId, p.displayName, p.pictureUrl);
                } catch(e) { alert(e); }
            }
        }

        async function mockLogin() {
            // Mock Super Admin ID
            await apiLogin("U1cf933e3a1559608c50c0456f6583dc9", "Pond Admin", "https://ui-avatars.com/api/?name=P");
        }

        async function apiLogin(uid, name, pic) {
            const res = await fetch('/api/login', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({userId:uid, displayName:name, pictureUrl:pic})
            });
            user = await res.json();
            renderUserUI();
            refresh();
            setInterval(refresh, 3000);
        }

        function renderUserUI() {
            document.getElementById('my-img').src = user.pictureUrl;
            document.getElementById('my-mmr').innerText = user.mmr;
            
            // Render Smart Stats
            const s = user.stats;
            document.getElementById('st-wr').innerText = s.win_rate + "%";
            document.getElementById('st-win').innerText = s.wins;
            document.getElementById('st-lose').innerText = s.losses;
            document.getElementById('st-streak').innerText = s.streak;
            document.getElementById('st-total').innerText = s.total;
            document.getElementById('st-partner').innerText = s.best_partner;
            document.getElementById('st-nemesis').innerText = s.nemesis;

            // Admin Button
            if(user.role === 'super' || user.role === 'mod') {
                document.querySelectorAll('.staff-only').forEach(e=>e.classList.remove('hidden'));
                document.getElementById('staff-controls').classList.remove('hidden');
            }

            // Status Button
            const btn = document.getElementById('btn-checkin');
            const badge = document.getElementById('status-badge');
            if (user.status === 'active') {
                btn.innerText = "‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å (Check-out)"; btn.className = "btn btn-outline btn-error w-full";
                badge.innerText = "üü¢ ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß"; badge.className = "badge badge-success text-white";
            } else if (user.status === 'playing') {
                btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô"; btn.disabled = true;
                badge.innerText = "üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô"; badge.className = "badge badge-warning";
            } else {
                btn.innerText = "‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°"; btn.className = "btn btn-primary w-full"; btn.disabled = false;
                badge.innerText = "‚ö´ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤"; badge.className = "badge badge-ghost";
            }
        }

        async function refresh() {
            const d = await(await fetch('/api/get_dashboard')).json();
            
            // Live Courts
            const cc = document.getElementById('courts-container'); cc.innerHTML = '';
            for(const [cid, m] of Object.entries(d.courts)) {
                if(m) {
                    const min = Math.floor(m.elapsed/60);
                    const isStaff = (user.role === 'super' || user.role === 'mod');
                    cc.innerHTML += `
                    <div class="card bg-white border border-indigo-100 shadow-sm p-3">
                        <div class="flex justify-between text-indigo-700 font-bold mb-2">
                            <span>COURT ${cid}</span>
                            <span class="badge badge-outline">${min} min</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="w-[45%] text-right truncate font-medium">${m.team_a.join('<br>')}</div>
                            <div class="font-bold text-red-500">VS</div>
                            <div class="w-[45%] text-left truncate font-medium">${m.team_b.join('<br>')}</div>
                        </div>
                        ${isStaff ? `<button onclick="selectedCid=${cid};document.getElementById('modal_finish').showModal();document.getElementById('fin-cid').innerText=${cid}" class="btn btn-xs btn-error text-white w-full mt-2">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>` : ''}
                    </div>`;
                } else {
                    cc.innerHTML += `<div class="p-4 border-2 border-dashed rounded text-center text-gray-400 text-sm">Court ${cid} ‡∏ß‡πà‡∏≤‡∏á</div>`;
                }
            }

            // Queue
            document.getElementById('q-count').innerText = d.queue_count;
            document.getElementById('queue-list').innerHTML = d.queue.map((p,i) => `
                <tr class="border-b">
                    <td>${i+1}. ${p.nickname}</td>
                    <td class="text-right"><span class="badge badge-ghost badge-xs">${p.rank_title}</span></td>
                </tr>
            `).join('');

            // Leaderboard
            document.getElementById('lb-list').innerHTML = d.leaderboard.map((p,i) => `
                <tr>
                    <td class="font-bold text-gray-500">${i+1}</td>
                    <td>
                        <div class="flex items-center gap-2">
                            <div class="avatar"><div class="w-6 rounded-full"><img src="${p.pictureUrl}"></div></div>
                            <span class="text-sm font-bold">${p.nickname}</span>
                        </div>
                    </td>
                    <td class="text-right font-mono font-bold text-indigo-600">${p.mmr}</td>
                </tr>
            `).join('');
            
            // Events
            document.getElementById('events-list').innerHTML = d.events.map(e => `
                <div class="card bg-white border-l-4 border-yellow-400 p-3 shadow-sm">
                    <div class="font-bold">${e.name}</div>
                    <div class="text-xs text-gray-500">${e.datetime.replace('T',' ')}</div>
                </div>
            `).join('');
        }

        async function toggleStatus() {
            await fetch('/api/toggle_status', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id})});
            // Reload user stats immediately
            await apiLogin(user.id, user.nickname, user.pictureUrl);
        }

        async function matchmake() {
            const r = await(await fetch('/api/matchmake',{method:'POST'})).json();
            if(r.status !== 'matched') alert(r.status === 'full' ? '‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°' : '‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
            else refresh();
        }

        async function submitRes(w) {
            await fetch('/api/submit_result', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({courtId:selectedCid, winner:w})
            });
            document.getElementById('modal_finish').close();
            refresh();
        }
        
        async function createEvent() {
            const n=document.getElementById('evt-name').value;
            const t=document.getElementById('evt-time').value;
            if(n&&t) {
                await fetch('/api/admin/create_event', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n, datetime:t})});
                alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß'); refresh();
            }
        }

        main();
    </script>
</body>
</html>