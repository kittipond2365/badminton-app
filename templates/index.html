<!DOCTYPE html>
<html data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>izesquad</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    .fade-in { animation: fadein .25s ease; }
    @keyframes fadein { from {opacity: .2; transform: translateY(3px);} to {opacity:1; transform:none;} }
    .mini { font-size: 11px; }
  </style>
</head>

<body class="bg-slate-100 min-h-screen pb-24">

  <!-- TOP NAV -->
  <div class="navbar bg-white shadow-sm px-4 sticky top-0 z-50">
    <div class="flex-1">
      <span class="text-xl font-black text-indigo-600 italic">izesquad <i class="fa-solid fa-bolt text-yellow-400"></i></span>
    </div>
    <div class="flex-none gap-2 items-center">
      <button id="btn-admin" class="btn btn-circle btn-ghost text-red-600 hidden" onclick="openAdmin()">
        <i class="fa-solid fa-gear text-xl"></i>
      </button>
      <button id="btn-bill" class="btn btn-circle btn-ghost text-green-600 hidden" onclick="openBilling()">
        <i class="fa-solid fa-file-invoice-dollar text-xl"></i>
      </button>

      <div class="text-right">
        <div class="text-[10px] text-gray-500">RANK</div>
        <div class="font-bold text-indigo-600" id="my-rank">...</div>
      </div>

      <div class="avatar">
        <div class="w-10 rounded-full ring ring-indigo-500 ring-offset-2">
          <img id="my-img" src="https://ui-avatars.com/api/?name=User" />
        </div>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="px-2 mt-3">
    <div role="tablist" class="tabs tabs-boxed bg-white shadow-sm font-bold">
      <a role="tab" id="tab-btn-live" class="tab tab-active" onclick="switchTab('live')">‡∏™‡∏ô‡∏≤‡∏°</a>
      <a role="tab" id="tab-btn-history" class="tab" onclick="switchTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
      <a role="tab" id="tab-btn-rank" class="tab" onclick="switchTab('rank')">Leaderboard</a>
      <a role="tab" id="tab-btn-events" class="tab" onclick="switchTab('events')">Sessions</a>
    </div>
  </div>

  <!-- LIVE TAB -->
  <div id="tab-live" class="p-4 max-w-md mx-auto fade-in">
    <div id="session-alert" class="hidden alert alert-warning mb-4 shadow-sm">
      <i class="fa-solid fa-triangle-exclamation"></i><span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô (‡∏£‡∏≠ Mod ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°)</span>
    </div>

    <!-- MY STATUS CARD -->
    <div class="card bg-white shadow-md mb-4 border-l-4 border-indigo-500">
      <div class="card-body p-4">
        <div class="flex justify-between items-center mb-2">
          <span class="font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status-badge" class="badge">...</span></span>
          <span id="my-rank-text" class="text-xs font-bold text-gray-400">...</span>
        </div>

        <button id="btn-checkin" class="btn btn-primary w-full" onclick="confirmToggleStatus()">Loading...</button>

        <div class="mt-3 flex items-center justify-between gap-2">
          <button id="btn-rest" class="btn btn-sm btn-outline w-1/2 hidden" onclick="toggleRest()">‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢</button>

          <label id="auto-rest-box" class="w-1/2 flex items-center justify-end gap-2 hidden">
            <span class="mini text-gray-500 font-bold">Auto Rest</span>
            <input id="auto-rest-toggle" type="checkbox" class="toggle toggle-sm toggle-primary" onchange="toggleAutoRest()"/>
          </label>
        </div>

        <!-- Partner -->
        <div id="partner-box" class="mt-4 hidden">
          <div class="divider text-xs text-gray-400 my-1">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</div>

          <!-- paired status -->
          <div id="paired-panel" class="hidden bg-indigo-50 p-2 rounded border border-indigo-100 flex justify-between items-center">
            <div class="text-xs text-indigo-700">
              <i class="fa-solid fa-link"></i>
              ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö: <span id="paired-name" class="font-bold">-</span>
            </div>
            <button class="btn btn-xs btn-ghost text-red-500" onclick="unpair()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏π‡πà</button>
          </div>

          <!-- outgoing request -->
          <div id="outgoing-panel" class="hidden bg-amber-50 p-2 rounded border border-amber-100 flex justify-between items-center mt-2">
            <div class="text-xs text-amber-700">
              <i class="fa-solid fa-paper-plane"></i>
              ‡∏Ç‡∏≠‡πÑ‡∏õ‡∏´‡∏≤: <span id="outgoing-name" class="font-bold">-</span> (‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
            </div>
            <button class="btn btn-xs btn-ghost text-red-500" onclick="cancelOutgoing()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>

          <!-- request form -->
          <div id="request-form" class="join w-full mt-2">
            <select id="partner-select" class="select select-bordered select-sm w-full join-item text-xs">
              <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>
            </select>
            <button class="btn btn-sm btn-primary join-item" onclick="sendPartnerRequest()">‡∏Ç‡∏≠</button>
          </div>

          <!-- incoming requests -->
          <div class="mt-3">
            <div class="text-xs text-gray-500 font-bold mb-1">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</div>
            <div id="incoming-list" class="space-y-2"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- STAFF CONTROLS -->
    <div id="staff-controls" class="hidden mb-4">
      <button class="btn btn-neutral w-full shadow-lg" onclick="requestMatchmake()">
        <i class="fa-solid fa-shuffle"></i> ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Å‡∏î‡∏™‡∏±‡πà‡∏á‡∏•‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î Auto)
      </button>
    </div>

    <!-- COURTS -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-4">
      <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between items-center">
        <span>‡∏™‡∏ô‡∏≤‡∏°</span>
        <span class="badge badge-neutral" id="court-count-display">0</span>
      </div>
      <div id="courts-container" class="p-3 space-y-3"></div>
    </div>

    <!-- QUEUE -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between">
        <span>‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô</span>
        <span id="q-count" class="badge badge-neutral">0</span>
      </div>
      <table class="table table-sm">
        <tbody id="queue-list"></tbody>
      </table>
      <div class="p-3 text-xs text-gray-400">
        * ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ‚Äú‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‚Äù ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà ‡πÅ‡∏ï‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏¢‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô
      </div>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div id="tab-history" class="p-4 max-w-md mx-auto hidden fade-in">
    <div class="join w-full mb-3">
      <button class="btn btn-sm join-item btn-primary" id="hist-btn-my" onclick="switchHistory('my')">‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
      <button class="btn btn-sm join-item" id="hist-btn-global" onclick="switchHistory('global')">Global</button>
    </div>
    <div id="history-list" class="space-y-3"></div>
  </div>

  <!-- LEADERBOARD TAB -->
  <div id="tab-rank" class="p-4 max-w-md mx-auto hidden fade-in">
    <div class="join w-full mb-3">
      <button class="btn btn-sm join-item btn-primary" id="lb-btn-mmr" onclick="switchLB('mmr')">MMR</button>
      <button class="btn btn-sm join-item" id="lb-btn-points" onclick="switchLB('points')">POINTS</button>
      <button class="btn btn-sm join-item" id="lb-btn-winrate" onclick="switchLB('winrate')">WINRATE</button>
    </div>

    <div class="overflow-x-auto bg-white rounded-xl shadow-sm">
      <table class="table table-xs">
        <thead>
          <tr class="bg-gray-100">
            <th>#</th>
            <th>Player</th>
            <th class="text-right" id="lb-metric-head">MMR</th>
          </tr>
        </thead>
        <tbody id="lb-list"></tbody>
      </table>
      <div class="p-3 text-xs text-gray-400">
        * ‡∏Ñ‡∏ô UNRANKED ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏°‡∏≠ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏≤ MMR ‡∏à‡∏≤‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö)
      </div>
    </div>
  </div>

  <!-- EVENTS TAB -->
  <div id="tab-events" class="p-4 max-w-md mx-auto hidden fade-in">
    <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
      <div class="font-bold text-gray-700 mb-2">Sessions (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô)</div>
      <div class="text-xs text-gray-500 mb-3">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà check-in ‡πÉ‡∏ô session ‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÜ</div>
      <button class="btn btn-success text-white w-full" onclick="openBilling()">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</button>
    </div>

    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Session ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      <div id="events-list" class="p-3 space-y-2"></div>
    </div>
  </div>

  <!-- MODALS -->

  <!-- ADMIN MODAL -->
  <dialog id="modal_admin" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-3 text-red-600">Admin / Mod Panel</h3>

      <div class="p-3 bg-red-50 rounded border border-red-100 mb-4">
        <div class="font-bold text-sm mb-2">Session Control</div>

        <div class="grid grid-cols-3 gap-2 mb-2">
          <select id="sess-target" class="select select-bordered select-sm">
            <option value="21">21 ‡πÅ‡∏ï‡πâ‡∏°</option>
            <option value="11">11 ‡πÅ‡∏ï‡πâ‡∏°</option>
          </select>
          <select id="sess-bo" class="select select-bordered select-sm">
            <option value="1">BO1</option>
            <option value="2">BO2 (‡∏ô‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°)</option>
            <option value="3">BO3</option>
          </select>
          <label class="flex items-center gap-2 justify-end">
            <span class="mini font-bold text-gray-500">Notify</span>
            <input id="sess-notify" type="checkbox" class="toggle toggle-sm toggle-success"/>
          </label>
        </div>

        <button class="btn btn-success text-white w-full mb-2" onclick="toggleSession('start')">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô</button>
        <button class="btn btn-error text-white w-full" onclick="toggleSession('end')">üèÅ ‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô</button>
      </div>

      <div class="p-3 bg-gray-50 rounded border mb-4">
        <div class="font-bold text-sm mb-2">Courts & AutoMatch (‡∏£‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏£‡πå‡∏ó)</div>
        <div class="flex items-center justify-between mb-2">
          <div class="join">
            <button class="btn btn-xs join-item" onclick="changeCourtCount(-1)">-</button>
            <button class="btn btn-xs join-item bg-white cursor-default" id="court-admin-display">2</button>
            <button class="btn btn-xs join-item" onclick="changeCourtCount(1)">+</button>
          </div>
          <div class="text-xs text-gray-500">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Auto ‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</div>
        </div>
        <div id="automatch-list" class="space-y-2"></div>
      </div>

      <div class="p-3 bg-white rounded border mb-4">
        <div class="font-bold text-sm mb-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç MMR (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Mod)</div>
        <div class="text-xs text-gray-500 mb-2">UNRANKED ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå MMR ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
        <div class="h-48 overflow-y-auto border rounded p-2 bg-white">
          <table class="table table-xs">
            <tbody id="mmr-edit-list"></tbody>
          </table>
        </div>
      </div>

      <div id="super-admin-section" class="hidden p-3 bg-white rounded border mb-4">
        <div class="font-bold text-sm mb-2">Moderators (Super Admin only)</div>
        <div class="h-40 overflow-y-auto border rounded p-2 bg-white">
          <table class="table table-xs">
            <tbody id="admin-user-list"></tbody>
          </table>
        </div>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn">‡∏õ‡∏¥‡∏î</button></form>
      </div>
    </div>
  </dialog>

  <!-- BILLING MODAL -->
  <dialog id="modal_billing" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
      <h3 class="font-bold text-lg mb-2 text-green-600">üí∞ Billing</h3>

      <div class="grid grid-cols-1 gap-3 mb-4 bg-gray-50 p-3 rounded-lg border">
        <select id="bill-event-select" class="select select-bordered select-sm w-full" onchange="loadBillPlayers()">
          <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Session --</option>
        </select>

        <div class="grid grid-cols-2 gap-2">
          <input id="bill-total-cost" type="number" class="input input-bordered input-sm w-full" placeholder="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°" oninput="calculateBill()">
          <input id="bill-default-hr" type="number" class="input input-bordered input-sm w-full" value="2" oninput="applyDefaultTime()">
        </div>

        <label class="label cursor-pointer justify-start gap-2">
          <input type="checkbox" id="bill-show-all" class="checkbox checkbox-sm checkbox-primary" onchange="loadBillPlayers()">
          <span class="label-text font-bold text-gray-500">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏Ç‡πâ‡∏≤‡∏° session)</span>
        </label>
      </div>

      <div class="overflow-x-auto max-h-64 mb-4 border rounded">
        <table class="table table-xs table-pin-rows">
          <thead><tr class="bg-gray-200"><th>‡∏ä‡∏∑‡πà‡∏≠</th><th class="w-16">‡∏ä‡∏°.</th><th class="w-16">‡∏ô‡∏≤‡∏ó‡∏µ</th><th class="text-right">‡∏ö‡∏≤‡∏ó</th></tr></thead>
          <tbody id="bill-player-list"></tbody>
        </table>
      </div>

      <div class="flex justify-between items-center bg-green-100 p-3 rounded mb-4">
        <span class="font-bold text-green-800">‡∏£‡∏ß‡∏°:</span>
        <span id="bill-grand-total" class="font-black text-xl text-green-800">0</span>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button></form>
        <button class="btn btn-success text-white" onclick="copyBillSummary()">Copy</button>
      </div>
    </div>
  </dialog>

  <!-- FINISH / SCORE MODAL -->
  <dialog id="modal_score" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-2">üè∏ ‡πÉ‡∏™‡πà‡∏™‡∏Å‡∏≠‡∏£‡πå / ‡∏à‡∏ö‡πÄ‡∏Å‡∏°</h3>
      <div class="text-xs text-gray-500 mb-3">
        ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏î‡∏¥‡∏ß‡∏™‡πå‡∏ñ‡∏∂‡∏á 30-29 | BO2 ‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‚Äú‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°‚Äù
      </div>

      <div class="bg-gray-50 p-3 rounded border mb-3">
        <div class="font-bold text-gray-700">Court <span id="score-court">-</span></div>
        <div class="text-sm mt-1">
          <span class="font-bold text-indigo-700" id="teamA-names">-</span>
          <span class="mx-2 text-gray-400">vs</span>
          <span class="font-bold text-red-600" id="teamB-names">-</span>
        </div>
        <div class="text-xs text-gray-500 mt-1" id="match-timer-hint">-</div>
      </div>

      <div id="score-inputs" class="space-y-2"></div>

      <div class="grid grid-cols-2 gap-2 mt-4">
        <button class="btn btn-primary" onclick="submitScore()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
        <button class="btn btn-outline btn-error" onclick="cancelMatch()">Cancel Match</button>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button></form>
      </div>
    </div>
  </dialog>

  <!-- PROFILE MODAL -->
  <dialog id="modal_profile" class="modal">
    <div class="modal-box">
      <div class="flex items-center gap-3">
        <div class="avatar">
          <div class="w-14 rounded-full">
            <img id="pf-img" src=""/>
          </div>
        </div>
        <div>
          <div class="font-black text-lg" id="pf-name">-</div>
          <div class="text-xs text-gray-500 font-bold" id="pf-rank">-</div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2 mt-4">
        <div class="bg-white border rounded p-2 text-center">
          <div class="mini text-gray-400">Set WR</div>
          <div class="font-black text-indigo-600" id="pf-wr">0%</div>
        </div>
        <div class="bg-white border rounded p-2 text-center">
          <div class="mini text-gray-400">Sets</div>
          <div class="font-black" id="pf-sets">0-0</div>
        </div>
        <div class="bg-white border rounded p-2 text-center">
          <div class="mini text-gray-400">Points</div>
          <div class="font-black" id="pf-pts">0/0</div>
        </div>
      </div>

      <div class="mt-4">
        <div class="font-bold text-gray-600 mb-2">10 ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div id="pf-last10" class="space-y-2"></div>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn">‡∏õ‡∏¥‡∏î</button></form>
      </div>
    </div>
  </dialog>

  <!-- TOAST -->
  <div class="toast toast-top toast-center z-[999]" id="toast" style="display:none;">
    <div class="alert alert-info shadow-lg">
      <span id="toast-text">-</span>
    </div>
  </div>

<script>
  const LIFF_ID = "2009064792-6RT6YKWO";

  let user = null;
  let dashboard = null;

  let histMode = "my";
  let lbMode = "mmr";

  let selectedCourt = null;
  let lastSeenMatchId = null;
  let lastIncomingSet = new Set();

  function showToast(text, ms=1800) {
    const t = document.getElementById("toast");
    const tt = document.getElementById("toast-text");
    tt.innerText = text;
    t.style.display = "block";
    setTimeout(()=> t.style.display="none", ms);
  }

  // small beep (WebAudio)
  function beep() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.08;
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 140);
    } catch(e) {}
  }
  function vibrate() {
    try { navigator.vibrate([180, 80, 180]); } catch(e) {}
  }

  function switchTab(t) {
    document.querySelectorAll('.tab').forEach(e => e.classList.remove('tab-active'));
    ["live","history","rank","events"].forEach(x=>{
      const el = document.getElementById("tab-"+x);
      if (el) el.classList.add("hidden");
    });
    document.getElementById("tab-btn-"+t).classList.add("tab-active");
    document.getElementById("tab-"+t).classList.remove("hidden");
  }

  function switchHistory(mode) {
    histMode = mode;
    document.getElementById("hist-btn-my").classList.toggle("btn-primary", mode==="my");
    document.getElementById("hist-btn-global").classList.toggle("btn-primary", mode==="global");
    renderHistory();
  }

  function switchLB(mode) {
    lbMode = mode;
    document.getElementById("lb-btn-mmr").classList.toggle("btn-primary", mode==="mmr");
    document.getElementById("lb-btn-points").classList.toggle("btn-primary", mode==="points");
    document.getElementById("lb-btn-winrate").classList.toggle("btn-primary", mode==="winrate");
    renderLeaderboard();
  }

  async function main() {
    if (location.hostname.includes("localhost")) {
      await apiLogin("U1cf933e3a1559608c50c0456f6583dc9", "Admin Pond", "https://ui-avatars.com/api/?name=A");
    } else {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        const p = await liff.getProfile();
        await apiLogin(p.userId, p.displayName, p.pictureUrl);
      } catch (e) {
        alert("LIFF Error: " + e);
      }
    }
  }

  async function apiLogin(uid, name, pic) {
    const res = await fetch("/api/login", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: uid, displayName: name, pictureUrl: pic })
    });
    const r = await res.json();
    if (r.error) return alert(r.error);
    user = r;
    await refresh();
    setInterval(refresh, 4000);
  }

  async function refresh() {
    if (!user) return;
    const res = await fetch("/api/get_dashboard?uid=" + encodeURIComponent(user.id));
    const d = await res.json();
    if (d.error) {
      console.error(d.error);
      return;
    }
    dashboard = d;

    renderTop();
    renderLive();
    renderHistory();
    renderLeaderboard();
    renderEvents();
    renderAdminPanelData();

    handleNotifications();
  }

  function renderTop() {
    const me = dashboard.me;
    if (!me) return;

    document.getElementById("my-img").src = me.pictureUrl || "https://ui-avatars.com/api/?name=User";
    document.getElementById("my-rank").innerText = me.rank_text || "...";
    document.getElementById("my-rank-text").innerText = me.rank_text || "...";

    // session controls visibility
    const isStaff = (me.role === "super" || me.role === "mod");
    document.getElementById("btn-admin").classList.toggle("hidden", !isStaff);
    document.getElementById("btn-bill").classList.toggle("hidden", !isStaff);
    document.getElementById("staff-controls").classList.toggle("hidden", !isStaff);

    if (me.role === "super") {
      document.getElementById("super-admin-section").classList.remove("hidden");
    }
  }

  function updateCheckinUI() {
    const me = dashboard.me;
    const system = dashboard.system;
    const btn = document.getElementById("btn-checkin");
    const badge = document.getElementById("status-badge");
    const sessAlert = document.getElementById("session-alert");

    if (!system.is_session_active) {
      sessAlert.classList.remove("hidden");
      btn.disabled = true;
      btn.classList.add("btn-disabled");
      btn.innerText = "‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πä‡∏ß‡∏ô...";
      badge.innerText = "‡∏õ‡∏¥‡∏î‡∏Å‡πä‡∏ß‡∏ô";
      badge.className = "badge badge-ghost";
      return;
    }

    sessAlert.classList.add("hidden");
    btn.disabled = false;
    btn.classList.remove("btn-disabled");

    // rest / auto rest controls
    const restBtn = document.getElementById("btn-rest");
    const autoRestBox = document.getElementById("auto-rest-box");
    const autoRestToggle = document.getElementById("auto-rest-toggle");

    if (me.status === "offline") {
      btn.innerText = "‚úÖ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°";
      btn.className = "btn btn-primary w-full";
      badge.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤";
      badge.className = "badge badge-ghost";

      restBtn.classList.add("hidden");
      autoRestBox.classList.add("hidden");
      document.getElementById("partner-box").classList.add("hidden");
    }
    else if (me.status === "active") {
      btn.innerText = "‚ùå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
      btn.className = "btn btn-outline btn-error w-full";
      badge.innerText = me.resting ? "‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢" : "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß";
      badge.className = me.resting ? "badge badge-warning" : "badge badge-success text-white";

      restBtn.classList.remove("hidden");
      restBtn.innerText = me.resting ? "‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß" : "‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢";

      autoRestBox.classList.remove("hidden");
      autoRestToggle.checked = !!me.auto_rest;

      document.getElementById("partner-box").classList.remove("hidden");
    }
    else {
      btn.innerText = "üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô";
      btn.className = "btn btn-disabled w-full";
      btn.disabled = true;
      badge.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô";
      badge.className = "badge badge-warning";

      restBtn.classList.add("hidden");
      autoRestBox.classList.add("hidden");
      document.getElementById("partner-box").classList.add("hidden");
    }
  }

  function renderLive() {
    updateCheckinUI();

    // courts
    const courts = dashboard.courts || {};
    document.getElementById("court-count-display").innerText = Object.keys(courts).length;

    const cc = document.getElementById("courts-container");
    cc.innerHTML = "";

    const me = dashboard.me;
    const isStaff = me && (me.role === "super" || me.role === "mod");
    const cam = (dashboard.system && dashboard.system.court_automatch) ? dashboard.system.court_automatch : {};

    for (const [cid, m] of Object.entries(courts)) {
      const autoOn = !!cam[String(cid)];

      if (!m) {
        cc.innerHTML += `
          <div class="p-3 border-2 border-dashed rounded text-center text-gray-400 text-sm bg-white">
            <div class="flex justify-between items-center">
              <div>COURT ${cid} ‡∏ß‡πà‡∏≤‡∏á</div>
              ${isStaff ? `
                <label class="flex items-center gap-2">
                  <span class="mini font-bold text-gray-500">Auto</span>
                  <input type="checkbox" class="toggle toggle-xs toggle-primary" ${autoOn?"checked":""}
                    onchange="toggleCourtAuto('${cid}', this.checked)">
                </label>
              ` : ``}
            </div>
          </div>
        `;
      } else {
        const canManage = isStaff || (m.team_a_ids||[]).includes(me.id) || (m.team_b_ids||[]).includes(me.id);
        const startsIn = m.state === "countdown" ? m.starts_in_sec : 0;
        const elapsedMin = Math.floor((m.elapsed_sec||0)/60);

        const renderTeam = (teamData) => (teamData||[]).map(p =>
          `<div class="flex items-center gap-1 cursor-pointer" onclick="openProfile('${p.id}')">
            <img src="${p.pictureUrl||''}" class="w-5 h-5 rounded-full">
            <span class="truncate max-w-[85px]">${escapeHtml(p.nickname)}</span>
          </div>`
        ).join("");

        const statusLine = (m.state === "countdown")
          ? `<span class="badge badge-outline">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô ${startsIn}s</span>`
          : `<span class="badge badge-outline">${elapsedMin} min</span>`;

        cc.innerHTML += `
          <div class="card bg-white border border-indigo-100 shadow-sm p-3">
            <div class="flex justify-between items-center mb-2">
              <div class="text-indigo-700 font-bold">COURT ${cid}</div>
              <div class="flex items-center gap-3">
                ${statusLine}
                ${isStaff ? `
                  <label class="flex items-center gap-2">
                    <span class="mini font-bold text-gray-500">Auto</span>
                    <input type="checkbox" class="toggle toggle-xs toggle-primary" ${autoOn?"checked":""}
                      onchange="toggleCourtAuto('${cid}', this.checked)">
                  </label>
                ` : ``}
              </div>
            </div>

            <div class="flex items-start justify-between text-sm">
              <div class="flex flex-col gap-1 w-[45%] items-end text-right font-medium">
                ${renderTeam(m.team_a_data)}
              </div>
              <div class="font-bold text-red-500 self-center">VS</div>
              <div class="flex flex-col gap-1 w-[45%] items-start text-left font-medium">
                ${renderTeam(m.team_b_data)}
              </div>
            </div>

            ${canManage ? `
              <button class="btn btn-xs btn-primary w-full mt-2"
                onclick="openScoreModal('${cid}')">
                ‡πÉ‡∏™‡πà‡∏™‡∏Å‡∏≠‡∏£‡πå / ‡∏à‡∏ö‡πÄ‡∏Å‡∏°
              </button>
              ${isStaff ? `
                <button class="btn btn-xs btn-outline btn-error w-full mt-2"
                  onclick="quickCancel('${cid}')">
                  Cancel Match (Mod)
                </button>
              ` : ``}
            ` : ``}
          </div>
        `;
      }
    }

    // queue
    const q = dashboard.queue || [];
    document.getElementById("q-count").innerText = dashboard.queue_count || 0;
    const qList = document.getElementById("queue-list");

    qList.innerHTML = q.map((p,i)=>{
      const restTag = p.resting ? `<span class="badge badge-xs badge-warning ml-1">‡∏û‡∏±‡∏Å</span>` : ``;
      const wait = `<span class="badge badge-xs badge-ghost ml-2">${p.wait_min||0}m</span>`;

      let pairTag = "";
      if (p.pair_lock) {
        const pp = (dashboard.all_players||[]).find(x=>x.id===p.pair_lock);
        pairTag = pp ? `<span class="badge badge-xs badge-outline ml-1 text-indigo-500"><i class="fa-solid fa-link mr-1"></i>${escapeHtml(pp.nickname)}</span>` : "";
      }

      return `
        <tr class="border-b">
          <td class="cursor-pointer" onclick="openProfile('${p.id}')">
            ${i+1}. ${escapeHtml(p.nickname)} ${wait} ${restTag} ${pairTag}
          </td>
          <td class="text-right">
            <span class="badge badge-ghost badge-xs">${escapeHtml(p.rank_text||'')}</span>
          </td>
        </tr>
      `;
    }).join("") || `<tr><td class="p-4 text-center text-gray-400" colspan="2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß</td></tr>`;

    // partner UI
    renderPartnerUI();
  }

  function renderPartnerUI() {
    const me = dashboard.me;
    const all = dashboard.all_players || [];
    const box = document.getElementById("partner-box");
    if (!me || me.status !== "active") { box.classList.add("hidden"); return; }
    box.classList.remove("hidden");

    // paired
    const pairedPanel = document.getElementById("paired-panel");
    const pairedName = document.getElementById("paired-name");
    if (me.pair_lock) {
      pairedPanel.classList.remove("hidden");
      const pp = all.find(x=>x.id===me.pair_lock);
      pairedName.innerText = pp ? pp.nickname : "-";
    } else {
      pairedPanel.classList.add("hidden");
    }

    // outgoing
    const outgoingPanel = document.getElementById("outgoing-panel");
    const outgoingName = document.getElementById("outgoing-name");
    if (me.outgoing_request_to) {
      outgoingPanel.classList.remove("hidden");
      const tp = all.find(x=>x.id===me.outgoing_request_to);
      outgoingName.innerText = tp ? tp.nickname : "-";
    } else {
      outgoingPanel.classList.add("hidden");
    }

    // request select (only active players, not self)
    const sel = document.getElementById("partner-select");
    const cur = sel.value;
    sel.innerHTML = `<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>`;
    all.filter(p=>p.id!==me.id && p.status==="active").forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.innerText = p.nickname;
      sel.appendChild(opt);
    });
    if (cur) sel.value = cur;

    // incoming list
    const incList = document.getElementById("incoming-list");
    const inc = me.incoming_requests || [];
    if (inc.length === 0) {
      incList.innerHTML = `<div class="text-xs text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>`;
    } else {
      incList.innerHTML = inc.map(rid=>{
        const rp = all.find(x=>x.id===rid);
        const nm = rp ? rp.nickname : rid;
        const disabled = !!me.pair_lock;
        return `
          <div class="flex justify-between items-center bg-white border rounded p-2">
            <div class="text-xs font-bold text-gray-700 flex items-center gap-2">
              <img src="${rp?rp.pictureUrl:''}" class="w-6 h-6 rounded-full">
              ${escapeHtml(nm)}
            </div>
            <button class="btn btn-xs btn-success text-white" ${disabled?"disabled":""}
              onclick="acceptRequest('${rid}')">
              ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö
            </button>
          </div>
        `;
      }).join("");
    }
  }

  function renderHistory() {
    const list = document.getElementById("history-list");
    const me = dashboard.me;

    const src = (histMode === "my") ? (dashboard.history.my||[]) : (dashboard.history.global||[]);
    if (!src.length) {
      list.innerHTML = `<div class="p-4 text-center text-gray-400 bg-white rounded">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
      return;
    }

    list.innerHTML = src.slice(0,30).map(m=>{
      const win = m.winner_team;
      const bo = m.bo || (m.settings && m.settings.bo) || 1;
      const dur = m.duration_min != null ? `${m.duration_min}m` : "-";
      const scores = (m.set_scores||[]).map(s=>`${s.a}-${s.b}`).join(", ");
      const totalPts = `${m.points_a_total||0}-${m.points_b_total||0}`;

      // determine my side
      let myResult = "";
      if (histMode === "my" && me) {
        const myTeam = (m.team_a_ids||[]).includes(me.id) ? "A" : "B";
        const isWin = (win === myTeam);
        myResult = isWin
          ? `<span class="badge badge-success text-white ml-2">WIN</span>`
          : `<span class="badge badge-error text-white ml-2">LOSE</span>`;
      } else {
        myResult = `<span class="badge badge-outline ml-2">W:${win}</span>`;
      }

      return `
        <div class="bg-white rounded-xl shadow-sm border p-3">
          <div class="flex justify-between items-center mb-2">
            <div class="font-bold text-gray-700">
              Court ${m.court_id} ¬∑ BO${bo} ¬∑ ${dur}
              ${myResult}
            </div>
            <div class="text-xs text-gray-400">${formatTime(m.ended_at || m.start_at || m.created_at)}</div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="bg-indigo-50 rounded p-2">
              <div class="text-xs font-bold text-indigo-700 mb-1">TEAM A</div>
              ${(m.team_a_data||[]).map(p=>`
                <div class="flex items-center gap-2 cursor-pointer" onclick="openProfile('${p.id}')">
                  <img class="w-5 h-5 rounded-full" src="${p.pictureUrl||''}">
                  <div class="text-xs font-bold text-gray-700">${escapeHtml(p.nickname)}</div>
                </div>
              `).join("")}
            </div>
            <div class="bg-rose-50 rounded p-2">
              <div class="text-xs font-bold text-rose-700 mb-1">TEAM B</div>
              ${(m.team_b_data||[]).map(p=>`
                <div class="flex items-center gap-2 cursor-pointer" onclick="openProfile('${p.id}')">
                  <img class="w-5 h-5 rounded-full" src="${p.pictureUrl||''}">
                  <div class="text-xs font-bold text-gray-700">${escapeHtml(p.nickname)}</div>
                </div>
              `).join("")}
            </div>
          </div>

          <div class="mt-2 text-xs text-gray-600">
            <div><b>Set:</b> ${escapeHtml(scores || "-")}</div>
            <div><b>Total Points:</b> ${escapeHtml(totalPts)}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderLeaderboard() {
    const rows = (dashboard.leaderboards && dashboard.leaderboards[lbMode]) ? dashboard.leaderboards[lbMode] : [];
    const body = document.getElementById("lb-list");
    const head = document.getElementById("lb-metric-head");

    if (lbMode === "mmr") head.innerText = "MMR";
    if (lbMode === "points") head.innerText = "POINTS";
    if (lbMode === "winrate") head.innerText = "WR(SET)";

    body.innerHTML = rows.map((p,i)=>{
      let metric = "";
      if (lbMode === "mmr") metric = (p.is_unranked ? p.rank_text : p.mmr);
      if (lbMode === "points") metric = p.points_for_total;
      if (lbMode === "winrate") metric = (p.set_winrate + "%");

      const sub = lbMode === "mmr"
        ? `${p.rank_text}`
        : `Diff ${p.point_diff_total >=0?"+":""}${p.point_diff_total} | Sets ${p.sets_won}-${p.sets_lost}`;

      return `
        <tr class="cursor-pointer" onclick="openProfile('${p.id}')">
          <td class="font-bold text-gray-500">${i+1}</td>
          <td>
            <div class="flex flex-col">
              <div class="flex items-center gap-2">
                <div class="avatar"><div class="w-7 rounded-full"><img src="${p.pictureUrl||''}"></div></div>
                <span class="text-sm font-bold">${escapeHtml(p.nickname)}</span>
              </div>
              <span class="text-[10px] text-gray-400 ml-9">${escapeHtml(sub)}</span>
            </div>
          </td>
          <td class="text-right">
            <div class="font-mono font-bold text-indigo-600">${escapeHtml(String(metric))}</div>
          </td>
        </tr>
      `;
    }).join("");
  }

  function renderEvents() {
    const evs = dashboard.events || [];
    const box = document.getElementById("events-list");

    box.innerHTML = evs.slice(0,12).map(e=>{
      const st = e.status === "active"
        ? `<span class="badge badge-success text-white">active</span>`
        : `<span class="badge badge-ghost">closed</span>`;
      const start = formatTime(e.start_time);
      const end = e.end_time ? formatTime(e.end_time) : "-";
      const pcount = (e.participants||[]).length || (e.participants_data||[]).length || 0;

      return `
        <div class="bg-white border rounded p-3">
          <div class="flex justify-between items-center">
            <div class="font-bold text-gray-700">${escapeHtml(e.name||e.id)}</div>
            ${st}
          </div>
          <div class="text-xs text-gray-500 mt-1">‡πÄ‡∏£‡∏¥‡πà‡∏°: ${start} | ‡∏à‡∏ö: ${end}</div>
          <div class="text-xs text-gray-500 mt-1">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: <b>${pcount}</b> ‡∏Ñ‡∏ô</div>
        </div>
      `;
    }).join("") || `<div class="text-center text-gray-400 p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ session</div>`;
  }

  function renderAdminPanelData() {
    const me = dashboard.me;
    if (!me) return;
    const isStaff = (me.role === "super" || me.role === "mod");
    if (!isStaff) return;

    // court count display
    document.getElementById("court-admin-display").innerText = Object.keys(dashboard.courts||{}).length;

    // automatch list
    const cam = dashboard.system.court_automatch || {};
    const autoList = document.getElementById("automatch-list");
    autoList.innerHTML = Object.keys(dashboard.courts||{}).map(cid=>{
      const on = !!cam[String(cid)];
      return `
        <label class="flex items-center justify-between bg-white border rounded p-2">
          <span class="font-bold text-gray-700">Court ${cid}</span>
          <input type="checkbox" class="toggle toggle-sm toggle-primary" ${on?"checked":""}
            onchange="toggleCourtAuto('${cid}', this.checked)">
        </label>
      `;
    }).join("");

    // mmr edit list (mod-only)
    const mmrList = document.getElementById("mmr-edit-list");
    const all = dashboard.all_players || [];
    mmrList.innerHTML = all.map(p=>{
      const unrank = p.is_unranked;
      return `
        <tr>
          <td class="w-10"><img class="w-7 h-7 rounded-full" src="${p.pictureUrl||''}"></td>
          <td class="text-xs font-bold">${escapeHtml(p.nickname)}<div class="text-[10px] text-gray-400">${escapeHtml(p.rank_text||'')}</div></td>
          <td class="text-right">
            <input class="input input-bordered input-xs w-20" type="number" value="${unrank ? '' : (p.mmr ?? '')}" placeholder="${unrank ? 'unrank' : 'mmr'}"
              id="mmr-in-${p.id}">
          </td>
          <td class="text-right w-20">
            <label class="mini flex items-center gap-2 justify-end">
              <input type="checkbox" class="checkbox checkbox-xs" id="force-rk-${p.id}">
              force
            </label>
          </td>
          <td class="text-right w-16">
            <button class="btn btn-xs btn-primary" onclick="saveMMR('${p.id}')">save</button>
          </td>
        </tr>
      `;
    }).join("");

    // mod manage (super only)
    if (me.role === "super") {
      const adminUserList = document.getElementById("admin-user-list");
      adminUserList.innerHTML = all.map(p=>{
        const checked = p.is_mod ? "checked" : "";
        return `
          <tr>
            <td class="text-xs font-bold">${escapeHtml(p.nickname)}</td>
            <td class="text-right">
              <input type="checkbox" class="toggle toggle-xs toggle-success" ${checked}
                onchange="toggleMod('${p.id}', this.checked)">
            </td>
          </tr>
        `;
      }).join("");
    }
  }

  // ---------------- NOTIFICATIONS ----------------
  function handleNotifications() {
    const me = dashboard.me;
    if (!me) return;

    // find match where I'm in
    let myMatch = null;
    for (const [cid, m] of Object.entries(dashboard.courts||{})) {
      if (!m) continue;
      const a = m.team_a_ids || [];
      const b = m.team_b_ids || [];
      if (a.includes(me.id) || b.includes(me.id)) {
        myMatch = m;
        break;
      }
    }

    if (myMatch && myMatch.match_id && myMatch.match_id !== lastSeenMatchId) {
      lastSeenMatchId = myMatch.match_id;
      beep(); vibrate();
      showToast(`üîî ‡πÑ‡∏î‡πâ‡∏•‡∏á‡πÅ‡∏Ç‡πà‡∏á Court ${myMatch.court_id} ‡πÅ‡∏•‡πâ‡∏ß!`);
    }

    // incoming partner requests new -> notify
    const inc = new Set(me.incoming_requests || []);
    let hasNew = false;
    inc.forEach(x=>{
      if (!lastIncomingSet.has(x)) hasNew = true;
    });
    if (hasNew) {
      beep(); vibrate();
      showToast("üì© ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡∏°‡πà!");
    }
    lastIncomingSet = inc;
  }

  // ---------------- ACTIONS ----------------
  async function confirmToggleStatus() {
    const me = dashboard.me;
    if (!dashboard.system.is_session_active) return;

    if (me.status === "offline") {
      if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°?")) return;
    } else if (me.status === "active") {
      if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å?\n‚ö†Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å reset ‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß/‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢/‡∏Ñ‡∏π‡πà")) return;
    } else {
      return;
    }
    await fetch("/api/toggle_status", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id })
    });
    await refresh();
  }

  async function toggleRest() {
    const me = dashboard.me;
    const r = await (await fetch("/api/toggle_rest", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id })
    })).json();
    if (r.error) alert(r.error);
    await refresh();
  }

  async function toggleAutoRest() {
    const me = dashboard.me;
    const r = await (await fetch("/api/toggle_auto_rest", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id })
    })).json();
    if (r.error) alert(r.error);
    await refresh();
  }

  async function sendPartnerRequest() {
    const me = dashboard.me;
    const targetId = document.getElementById("partner-select").value;
    if (!targetId) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

    const r = await (await fetch("/api/partner/request", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id, targetId })
    })).json();
    if (r.error) alert(r.error);
    await refresh();
  }

  async function cancelOutgoing() {
    const me = dashboard.me;
    const r = await (await fetch("/api/partner/cancel_outgoing", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id })
    })).json();
    if (r.error) alert(r.error);
    await refresh();
  }

  async function acceptRequest(requesterId) {
    const me = dashboard.me;
    const r = await (await fetch("/api/partner/accept", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id, requesterId })
    })).json();
    if (r.error) alert(r.error);
    await refresh();
  }

  async function unpair() {
    const me = dashboard.me;
    if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏π‡πà?")) return;
    const r = await (await fetch("/api/partner/unpair", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id })
    })).json();
    if (r.error) alert(r.error);
    await refresh();
  }

  async function requestMatchmake() {
    const r = await (await fetch("/api/matchmake", { method:"POST" })).json();
    if (r.error) return alert(r.error);
    if (r.status === "full") return alert("‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏°");
    if (r.status === "waiting") return alert("‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢");
    await refresh();
  }

  async function toggleCourtAuto(cid, enabled) {
    const me = dashboard.me;
    const r = await (await fetch("/api/admin/toggle_automatch", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id, courtId: cid, enabled })
    })).json();
    if (r.error) alert(r.error);
    await refresh();
  }

  // ---------------- SCORE MODAL ----------------
  function openScoreModal(cid) {
    selectedCourt = cid;
    const m = dashboard.courts[cid];
    if (!m) return;

    document.getElementById("score-court").innerText = cid;
    document.getElementById("teamA-names").innerText = (m.team_a||[]).join(" / ");
    document.getElementById("teamB-names").innerText = (m.team_b||[]).join(" / ");

    if (m.state === "countdown") {
      document.getElementById("match-timer-hint").innerText = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô ${m.starts_in_sec}s (‡∏•‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ)`;
    } else {
      const min = Math.floor((m.elapsed_sec||0)/60);
      document.getElementById("match-timer-hint").innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ~ ${min} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    }

    // render score inputs based on session config
    constCE = dashboard.system.session_config || { target_points: 21, bo: 1 };
    renderScoreInputs(RCE.bo||1);

    document.getElementById("modal_score").showModal();
  }

  function renderScoreInputs(bo) {
    const cfg = dashboard.system.session_config || { target_points: 21, bo: 1 };
    const target = cfg.target_points || 21;
    const box = document.getElementById("score-inputs");
    box.innerHTML = "";

    const maxSets = (bo==3) ? 3 : bo;
    for (let i=1; i<=maxSets; i++) {
      box.innerHTML += `
        <div class="bg-white border rounded p-2">
          <div class="text-xs font-bold text-gray-600 mb-1">Set ${i} (‡∏ñ‡∏∂‡∏á ${target}, ‡∏î‡∏¥‡∏ß‡∏™‡πå‡∏ñ‡∏∂‡∏á 30)</div>
          <div class="grid grid-cols-2 gap-2">
            <input id="sa-${i}" type="number" class="input input-bordered input-sm" placeholder="Team A">
            <input id="sb-${i}" type="number" class="input input-bordered input-sm" placeholder="Team B">
          </div>
          ${bo==3 && i==3 ? `<div class="text-[10px] text-gray-400 mt-1">* Set 3 ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ä‡∏ô‡∏∞‡∏Ñ‡∏£‡∏ö 2 ‡πÄ‡∏ã‡∏ï‡πÅ‡∏•‡πâ‡∏ß</div>` : ``}
        </div>
      `;
    }
    if (bo==2) {
      box.innerHTML += `<div class="text-xs text-gray-500">* BO2: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‚Äú‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°‚Äù ‡∏Ç‡∏≠‡∏á 2 ‡πÄ‡∏ã‡∏ï</div>`;
    }
  }

  function getScorePayload() {
    const cfg = dashboard.system.session_config || { bo: 1 };
    const bo = cfg.bo || 1;
    const maxSets = (bo==3) ? 3 : bo;

    const scores = [];
    for (let i=1; i<=maxSets; i++) {
      const a = document.getElementById(`sa-${i}`).value;
      const b = document.getElementById(`sb-${i}`).value;

      if (a==="" && b==="") {
        // allow empty only for bo3 set3
        continue;
      }
      if (a==="" || b==="") throw new Error("‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏ï‡∏ô‡∏±‡πâ‡∏ô");
      scores.push({ a: parseInt(a,10), b: parseInt(b,10) });
    }
    return scores;
  }

  async function submitScore() {
    try {
      const me = dashboard.me;
      const set_scores = getScorePayload();

      const r = await (await fetch("/api/submit_result", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ userId: me.id, courtId: selectedCourt, set_scores })
      })).json();

      if (r.error) return alert(r.error);

      document.getElementById("modal_score").close();
      showToast("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß");
      await refresh();
    } catch(e) {
      alert(e.message || e);
    }
  }

  async function cancelMatch() {
    const me = dashboard.me;
    if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Cancel Match?\n- ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î MMR\n- ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥\n- ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°")) return;

    const r = await (await fetch("/api/match/cancel", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id, courtId: selectedCourt })
    })).json();

    if (r.error) return alert(r.error);
    document.getElementById("modal_score").close();
    showToast("‚õîÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÅ‡∏•‡πâ‡∏ß");
    await refresh();
  }

  async function quickCancel(cid) {
    selectedCourt = cid;
    await cancelMatch();
  }

  // ---------------- BILLING ----------------
  function openBilling() {
    const evs = dashboard.events || [];
    const sel = document.getElementById("bill-event-select");
    sel.innerHTML = `<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Session --</option>`;
    evs.slice(0,8).forEach(e=>{
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.innerText = `${e.name} (${formatTime(e.start_time)})`;
      sel.appendChild(opt);
    });
    document.getElementById("modal_billing").showModal();
  }

  function loadBillPlayers() {
    const eid = document.getElementById("bill-event-select").value;
    const showAll = document.getElementById("bill-show-all").checked;
    const tbody = document.getElementById("bill-player-list");
    const defHr = document.getElementById("bill-default-hr").value || 2;

    tbody.innerHTML = "";

    let candidates = [];
    if (showAll) {
      candidates = dashboard.all_players || [];
    } else {
      const evt = (dashboard.events||[]).find(e=>e.id===eid);
      candidates = evt ? (evt.participants_data || []) : [];
    }

    if (!candidates.length) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡πä‡∏Å "‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô")</td></tr>`;
      return;
    }

    candidates.forEach(u=>{
      tbody.innerHTML += `
        <tr class="bill-row" data-name="${escapeHtml(u.nickname)}">
          <td>
            <div class="flex items-center gap-2">
              <img src="${u.pictureUrl||''}" class="w-6 h-6 rounded-full">
              <span class="text-xs font-bold">${escapeHtml(u.nickname)}</span>
              <button onclick="this.closest('tr').remove();calculateBill()" class="btn btn-xs btn-ghost text-red-400 rounded-full px-1">x</button>
            </div>
          </td>
          <td><input type="number" class="input input-bordered input-xs w-full bill-hr" value="${defHr}" min="0" oninput="calculateBill()"></td>
          <td><input type="number" class="input input-bordered input-xs w-full bill-min" value="0" min="0" step="5" oninput="calculateBill()"></td>
          <td class="text-right font-bold bill-price">0</td>
        </tr>
      `;
    });
    calculateBill();
  }

  function applyDefaultTime() {
    const def = document.getElementById("bill-default-hr").value;
    document.querySelectorAll(".bill-hr").forEach(el=>el.value=def);
    document.querySelectorAll(".bill-min").forEach(el=>el.value=0);
    calculateBill();
  }

  function calculateBill() {
    const totalCost = parseFloat(document.getElementById("bill-total-cost").value) || 0;
    const rows = document.querySelectorAll(".bill-row");

    let totalMinutesPool = 0;
    rows.forEach(row=>{
      const h = parseInt(row.querySelector(".bill-hr").value)||0;
      const m = parseInt(row.querySelector(".bill-min").value)||0;
      totalMinutesPool += (h*60)+m;
    });

    const costPerMin = totalMinutesPool > 0 ? (totalCost / totalMinutesPool) : 0;
    let grandTotal = 0;

    rows.forEach(row=>{
      const h = parseInt(row.querySelector(".bill-hr").value)||0;
      const m = parseInt(row.querySelector(".bill-min").value)||0;
      const myCost = Math.ceil(((h*60)+m) * costPerMin);
      row.querySelector(".bill-price").innerText = myCost;
      grandTotal += myCost;
    });

    document.getElementById("bill-grand-total").innerText = grandTotal;
  }

  function copyBillSummary() {
    const eid = document.getElementById("bill-event-select").value;
    const evt = (dashboard.events||[]).find(e=>e.id===eid);
    const evtName = evt ? evt.name : "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏Å‡πä‡∏ß‡∏ô";
    let txt = `üí∏ ${evtName}\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${document.getElementById("bill-total-cost").value} ‡∏ö‡∏≤‡∏ó\n------------------\n`;
    document.querySelectorAll(".bill-row").forEach(row=>{
      const name = row.dataset.name;
      const price = row.querySelector(".bill-price").innerText;
      const h = row.querySelector(".bill-hr").value;
      const m = row.querySelector(".bill-min").value;
      txt += `${name} (${m>0?`${h}‡∏ä‡∏°.${m}‡∏ô.`:`${h}‡∏ä‡∏°.`}) = ${price}.- \n`;
    });
    txt += `------------------\n‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏à‡πä‡∏∞ üòò`;

    navigator.clipboard.writeText(txt).then(()=>alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!"));
  }

  // ---------------- ADMIN ----------------
  function openAdmin() {
    // set defaults from system config
    const cfg = dashboard.system.session_config || { target_points:21, bo:1, notify_enabled:false };
    document.getElementById("sess-target").value = String(cfg.target_points||21);
    document.getElementById("sess-bo").value = String(cfg.bo||1);
    document.getElementById("sess-notify").checked = !!cfg.notify_enabled;

    document.getElementById("modal_admin").showModal();
  }

  async function toggleSession(action) {
    const me = dashboard.me;
    if (action === "end") {
      if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô?")) return;
    }
    const payload = {
      userId: me.id,
      action
    };
    if (action === "start") {
      payload.target_points = parseInt(document.getElementById("sess-target").value,10);
      payload.bo = parseInt(document.getElementById("sess-bo").value,10);
      payload.notify_enabled = document.getElementById("sess-notify").checked;
      payload.ready_check = false;
    }

    const r = await (await fetch("/api/admin/toggle_session", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    })).json();
    if (r.error) return alert(r.error);

    document.getElementById("modal_admin").close();
    showToast(action==="start" ? "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "üèÅ ‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    await refresh();
  }

  async function changeCourtCount(delta) {
    const me = dashboard.me;
    const current = Object.keys(dashboard.courts||{}).length;
    const next = Math.max(1, Math.min(8, current + delta));

    const r = await (await fetch("/api/admin/update_courts", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id, count: next })
    })).json();
    if (r.error) return alert(r.error);
    await refresh();
  }

  async function toggleMod(tid, checked) {
    const me = dashboard.me;
    const r = await (await fetch("/api/admin/manage_mod", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ requesterId: me.id, targetUserId: tid, action: checked ? "promote" : "demote" })
    })).json();
    if (r.error) alert(r.error);
    await refresh();
  }

  async function saveMMR(tid) {
    const me = dashboard.me;
    const inp = document.getElementById("mmr-in-"+tid);
    const force = document.getElementById("force-rk-"+tid).checked;
    const v = inp.value;
    if (!v) return alert("‡∏Å‡∏£‡∏≠‡∏Å MMR ‡∏Å‡πà‡∏≠‡∏ô");
    const r = await (await fetch("/api/admin/set_mmr", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId: me.id, targetUserId: tid, newMmr: parseInt(v,10), force_ranked: force })
    })).json();
    if (r.error) return alert(r.error);
    showToast("‚úÖ ‡πÄ‡∏ã‡∏ü MMR ‡πÅ‡∏•‡πâ‡∏ß");
    await refresh();
  }

  // ---------------- PROFILE ----------------
  async function openProfile(uid) {
    const r = await (await fetch(`/api/player/profile/${encodeURIComponent(uid)}`)).json();
    if (r.error) return alert(r.error);

    document.getElementById("pf-img").src = r.pictureUrl || "https://ui-avatars.com/api/?name=User";
    document.getElementById("pf-name").innerText = r.nickname;
    document.getElementById("pf-rank").innerText = r.rank_text;

    document.getElementById("pf-wr").innerText = (r.stats.set_winrate||0) + "%";
    document.getElementById("pf-sets").innerText = `${r.stats.sets_won||0}-${r.stats.sets_lost||0}`;
    document.getElementById("pf-pts").innerText = `${r.stats.points_for_total||0}/${r.stats.points_against_total||0}`;

    const box = document.getElementById("pf-last10");
    box.innerHTML = (r.last10||[]).map(m=>{
      const scores = (m.set_scores||[]).map(s=>`${s.a}-${s.b}`).join(", ");
      const dur = m.duration_min!=null ? `${m.duration_min}m` : "-";
      const win = m.winner_team;

      // show who won
      const tag = `<span class="badge badge-outline">W:${win}</span>`;
      return `
        <div class="bg-white border rounded p-2">
          <div class="flex justify-between items-center">
            <div class="text-xs font-bold text-gray-700">Court ${m.court_id} ¬∑ BO${m.bo} ¬∑ ${dur}</div>
            ${tag}
          </div>
          <div class="text-[10px] text-gray-500 mt-1">Set: ${escapeHtml(scores||"-")} | Total: ${m.points_a_total||0}-${m.points_b_total||0}</div>
        </div>
      `;
    }).join("") || `<div class="text-xs text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;

    document.getElementById("modal_profile").showModal();
  }

  // ---------------- HELPERS ----------------
  function formatTime(ts) {
    if (!ts) return "-";
    const d = new Date(ts*1000);
    return d.toLocaleString("th-TH", { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
  }

  function escapeHtml(str) {
    if (str === null || str === undefined) return "";
    return String(str).replace(/[&<>"']/g, function(m) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }

  main();
</script>

</body>
</html>
