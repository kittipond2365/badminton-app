<!DOCTYPE html>
<html data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>izesquad</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>var vConsole = new VConsole();</script>
</head>

<body class="bg-slate-100 min-h-screen pb-24">
  <div class="toast toast-top toast-center z-[9999]" id="toast-root"></div>

  <div class="navbar bg-white shadow-sm px-4 sticky top-0 z-50">
    <div class="flex-1">
      <span class="text-xl font-black text-indigo-600 italic">izesquad <i class="fa-solid fa-bolt text-yellow-400"></i></span>
    </div>

    <div class="flex-none gap-2">
      <button id="btn-admin" onclick="document.getElementById('modal_admin').showModal()" class="btn btn-circle btn-ghost text-red-600 hidden">
        <i class="fa-solid fa-gear text-xl"></i>
      </button>

      <button id="btn-bill" onclick="openBillingModal()" class="btn btn-circle btn-ghost text-green-600 hidden">
        <i class="fa-solid fa-file-invoice-dollar text-xl"></i>
      </button>

      <div class="text-right">
        <div class="text-[10px] text-gray-500">MMR</div>
        <div class="font-bold text-indigo-600" id="my-mmr">...</div>
      </div>

      <div class="avatar">
        <div class="w-10 rounded-full ring ring-indigo-500 ring-offset-2">
          <img id="my-img" src="https://ui-avatars.com/api/?name=User" />
        </div>
      </div>
    </div>
  </div>

  <div class="px-2 mt-3">
    <div role="tablist" class="tabs tabs-boxed bg-white shadow-sm font-bold">
      <a role="tab" id="tab-btn-live" class="tab tab-active" onclick="switchTab('live')">‡∏™‡∏ô‡∏≤‡∏°</a>
      <a role="tab" id="tab-btn-stats" class="tab" onclick="switchTab('stats')">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</a>
      <a role="tab" id="tab-btn-history" class="tab" onclick="switchTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
      <a role="tab" id="tab-btn-rank" class="tab" onclick="switchTab('rank')">Rank</a>
      <a role="tab" id="tab-btn-events" class="tab" onclick="switchTab('events')">Events</a>
    </div>
  </div>

  <!-- LIVE -->
  <div id="tab-live" class="p-4 max-w-md mx-auto">
    <div id="session-alert" class="hidden alert alert-warning mb-4 shadow-sm">
      <i class="fa-solid fa-triangle-exclamation"></i><span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô (‡∏£‡∏≠ Mod ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°)</span>
    </div>

    <div class="card bg-white shadow-md mb-4 border-l-4 border-indigo-500">
      <div class="card-body p-4">
        <div class="flex justify-between items-center mb-2">
          <span class="font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status-badge" class="badge">...</span></span>
          <span id="my-rank-text" class="text-xs font-bold text-gray-400">...</span>
        </div>

        <button id="btn-checkin" onclick="toggleStatus()" class="btn btn-primary w-full">Loading...</button>

        <!-- REST button -->
        <button id="btn-rest" onclick="toggleRest()" class="btn btn-outline w-full mt-2 hidden">
          <i class="fa-solid fa-mug-hot"></i> ‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢
        </button>

        <div id="partner-req-box" class="mt-3 hidden">
          <div class="divider text-xs text-gray-400 my-1">‡∏Ç‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</div>

          <div id="req-form" class="join w-full">
            <select id="partner-select" class="select select-bordered select-sm w-full join-item text-xs">
              <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>
            </select>
            <button onclick="requestPartner()" class="btn btn-sm btn-primary join-item">‡∏Ç‡∏≠</button>
          </div>

          <div id="req-active" class="hidden flex justify-between items-center bg-indigo-50 p-2 rounded border border-indigo-100 mt-2">
            <div class="text-xs text-indigo-700">
              <i class="fa-solid fa-link"></i> ‡∏£‡∏≠‡∏Ñ‡∏π‡πà: <span id="req-target-name" class="font-bold">...</span>
            </div>
            <button onclick="cancelRequest()" class="btn btn-xs btn-ghost text-red-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>

          <div id="incoming-box" class="hidden mt-3">
            <div class="divider text-xs text-gray-400 my-1">‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</div>
            <div id="incoming-list" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- STAFF: per-court automatch toggles -->
    <div id="staff-extra" class="hidden mb-3 space-y-2">
      <div class="bg-white rounded-xl shadow-sm p-3">
        <div class="font-bold text-gray-700 text-sm mb-2">
          <i class="fa-solid fa-robot"></i> AutoMatch ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏£‡πå‡∏ó
        </div>
        <div id="auto-courts-list" class="space-y-2"></div>
        <div class="text-[11px] text-gray-400 mt-2">
          AutoMatch <b>ON</b> = ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ß‡πà‡∏≤‡∏á/‡πÄ‡∏Å‡∏°‡∏à‡∏ö ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°)
        </div>
      </div>
    </div>

    <div id="courts-container" class="space-y-3 mb-6"></div>

    <div id="mod-court-control" class="hidden flex justify-between items-center bg-gray-200 p-2 rounded mb-4">
      <div class="join">
        <button onclick="changeCourtCount(-1)" class="btn btn-xs join-item">-</button>
        <button class="btn btn-xs join-item bg-white cursor-default" id="court-count-display">2</button>
        <button onclick="changeCourtCount(1)" class="btn btn-xs join-item">+</button>
      </div>
      <button onclick="openManualMatch()" class="btn btn-xs btn-neutral"><i class="fa-solid fa-hand-pointer"></i> ‡∏à‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</button>
    </div>

    <div id="staff-controls" class="hidden mb-6">
      <button onclick="matchmake()" class="btn btn-neutral w-full shadow-lg">
        <i class="fa-solid fa-shuffle"></i> ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏•‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î AutoMatch
      </button>
      <div class="text-[11px] text-gray-400 mt-2 text-center">
        ‡∏ñ‡πâ‡∏≤ AutoMatch ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ = ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‚Äù
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between items-center">
        <span>‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô</span>
        <div class="flex items-center gap-2">
          <span class="badge badge-neutral" id="q-count">0</span>
          <span class="text-[11px] text-gray-400">(‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏ô‡∏≤‡∏ó‡∏µ)</span>
        </div>
      </div>

      <table class="table table-sm">
        <thead>
          <tr class="bg-gray-100">
            <th>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th>
            <th class="text-right">‡∏£‡∏≠</th>
            <th class="text-right">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
        </thead>
        <tbody id="queue-list"></tbody>
      </table>
    </div>
  </div>

  <!-- STATS -->
  <div id="tab-stats" class="p-4 max-w-md mx-auto hidden">
    <div class="card bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-xl mb-4">
      <div class="card-body p-5 text-center">
        <h2 class="text-lg font-bold opacity-80">WIN RATE</h2>
        <div class="text-5xl font-black my-2" id="st-wr">0%</div>
        <div class="flex justify-center gap-4 text-sm opacity-90">
          <span>üèÜ Matches: <b id="st-total">0</b></span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4">
      <div class="bg-white p-3 rounded-xl shadow-sm border border-orange-100">
        <div class="text-xs text-gray-400 mb-1">üî• Win Streak</div>
        <div class="text-xl font-bold text-gray-700" id="st-streak">0</div>
      </div>
      <div class="bg-white p-3 rounded-xl shadow-sm border border-green-100">
        <div class="text-xs text-gray-400 mb-1">ü§ù Best Partner</div>
        <div class="text-sm font-bold text-green-600 truncate" id="st-partner">-</div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-3 border-l-4 border-red-400">
      <div class="text-xs text-gray-400 mb-1">üòà Nemesis</div>
      <div class="text-lg font-bold text-red-600" id="st-nemesis">-</div>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="tab-history" class="p-4 max-w-md mx-auto hidden">
    <h3 class="font-bold text-gray-500 mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á (‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤)</h3>
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <table class="table table-xs">
        <thead><tr class="bg-gray-100"><th>‡∏ú‡∏•</th><th>‡πÄ‡∏ß‡∏•‡∏≤/‡∏ô‡∏≤‡∏ô</th><th class="text-right">MMR</th></tr></thead>
        <tbody id="history-list"></tbody>
      </table>
    </div>
  </div>

  <!-- RANK -->
  <div id="tab-rank" class="p-4 max-w-md mx-auto hidden">
    <div class="overflow-x-auto bg-white rounded-xl shadow-sm">
      <table class="table table-xs">
        <thead><tr class="bg-gray-100"><th>#</th><th>Player</th><th class="text-right">MMR</th></tr></thead>
        <tbody id="lb-list"></tbody>
      </table>
    </div>
  </div>

  <!-- EVENTS -->
  <div id="tab-events" class="p-4 max-w-md mx-auto hidden">
    <div class="staff-only hidden mb-4 p-4 bg-white rounded shadow">
      <h3 class="font-bold text-sm mb-2">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Event (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Session)</h3>
      <input id="evt-name" class="input input-bordered input-sm w-full mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠ event">
      <input id="evt-time" type="datetime-local" class="input input-bordered input-sm w-full mb-2">
      <button onclick="submitNewEvent()" class="btn btn-primary btn-sm w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button>
    </div>
    <div id="events-list" class="space-y-4"></div>
  </div>

  <!-- MANUAL MATCH -->
  <dialog id="modal_manual_match" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">üñê ‡∏à‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</h3>

      <select id="man-court" class="select select-bordered select-sm w-full mb-2"></select>

      <div class="grid grid-cols-2 gap-2 mb-4">
        <div class="bg-red-50 p-2 rounded">
          <div class="font-bold text-red-500 text-xs">TEAM A</div>
          <select id="man-p1" class="select select-bordered select-xs w-full mb-1 player-select"></select>
          <select id="man-p2" class="select select-bordered select-xs w-full player-select"></select>
        </div>
        <div class="bg-blue-50 p-2 rounded">
          <div class="font-bold text-blue-500 text-xs">TEAM B</div>
          <select id="man-p3" class="select select-bordered select-xs w-full mb-1 player-select"></select>
          <select id="man-p4" class="select select-bordered select-xs w-full player-select"></select>
        </div>
      </div>

      <button onclick="submitManualMatch()" class="btn btn-primary w-full">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á</button>
      <form method="dialog" class="mt-2 text-center"><button class="btn btn-ghost btn-sm">‡∏õ‡∏¥‡∏î</button></form>
    </div>
  </dialog>

  <!-- ADMIN -->
  <dialog id="modal_admin" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4 text-red-600">Admin Panel</h3>

      <div class="mb-6 p-4 bg-red-50 rounded-lg border border-red-100">
        <h4 class="font-bold text-sm mb-2">Session Control</h4>
        <button onclick="toggleSession('start')" class="btn btn-success text-white w-full mb-2">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô</button>
        <button onclick="toggleSession('end')" class="btn btn-error text-white w-full">üèÅ ‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô</button>
      </div>

      <div id="mod-tools" class="mb-6 hidden p-4 bg-white rounded-lg border">
        <h4 class="font-bold text-sm mb-3 text-gray-700"><i class="fa-solid fa-pen-to-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç MMR ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h4>

        <div class="grid grid-cols-1 gap-2">
          <select id="mmr-player-select" class="select select-bordered select-sm w-full" onchange="syncMmrEditorFromSelect()">
            <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô --</option>
          </select>

          <div class="flex items-center justify-between text-xs text-gray-500">
            <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/Rank: <b id="mmr-player-rank">-</b></span>
            <span>MMR ‡πÄ‡∏î‡∏¥‡∏°: <b id="mmr-player-current">-</b></span>
          </div>

          <input id="mmr-new-value" type="number" class="input input-bordered input-sm w-full" placeholder="‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç MMR ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô 1200)">
          <button onclick="adminSetMmr()" class="btn btn-sm btn-primary w-full">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï MMR</button>

          <div class="text-[11px] text-gray-400 mt-1">
            * ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏±‡∏á UNRANKED ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö 10 ‡πÄ‡∏Å‡∏° (‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏ô MMR ‡∏≠‡∏¢‡∏π‡πà)
          </div>
        </div>
      </div>

      <div id="super-admin-section" class="mb-4 hidden">
        <h4 class="font-bold text-sm mb-2">Moderators</h4>
        <div class="h-48 overflow-y-auto border rounded p-2 bg-white">
          <table class="table table-xs"><tbody id="admin-user-list"></tbody></table>
        </div>
        <div class="mt-4 pt-4 border-t">
          <button onclick="resetSystem()" class="btn btn-outline btn-error btn-sm w-full">‚ö†Ô∏è Factory Reset</button>
        </div>
      </div>

      <div class="modal-action"><form method="dialog"><button class="btn">‡∏õ‡∏¥‡∏î</button></form></div>
    </div>
  </dialog>

  <!-- FINISH / CANCEL -->
  <dialog id="modal_finish" class="modal">
    <div class="modal-box text-center">
      <h3 class="font-bold text-lg">‡∏à‡∏ö‡πÄ‡∏Å‡∏° Court <span id="fin-cid"></span></h3>
      <div class="text-xs text-gray-400 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå (‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î MMR / ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</div>

      <div class="flex flex-col gap-2 justify-center mt-4">
        <button onclick="submitRes('A')" class="btn btn-primary w-full">Team A ‡∏ä‡∏ô‡∏∞</button>
        <button onclick="submitRes('B')" class="btn btn-error text-white w-full">Team B ‡∏ä‡∏ô‡∏∞</button>
        <button onclick="cancelMatch()" class="btn btn-ghost w-full">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå (Cancel)</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- BILLING -->
  <dialog id="modal_billing" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
      <h3 class="font-bold text-lg mb-2 text-green-600">üí∞ Billing</h3>

      <div class="grid grid-cols-1 gap-3 mb-4 bg-gray-50 p-3 rounded-lg border">
        <select id="bill-event-select" class="select select-bordered select-sm w-full" onchange="loadBillPlayers()">
          <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Session --</option>
        </select>

        <div class="grid grid-cols-2 gap-2">
          <input id="bill-total-cost" type="number" class="input input-bordered input-sm w-full" placeholder="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°" oninput="calculateBill()">
          <input id="bill-default-hr" type="number" class="input input-bordered input-sm w-full" value="2" oninput="applyDefaultTime()">
        </div>

        <label class="label cursor-pointer justify-start gap-2">
          <input type="checkbox" id="bill-show-all" class="checkbox checkbox-sm checkbox-primary" onchange="loadBillPlayers()">
          <span class="label-text font-bold text-gray-500">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</span>
        </label>
      </div>

      <div class="overflow-x-auto max-h-64 mb-4 border rounded">
        <table class="table table-xs table-pin-rows">
          <thead><tr class="bg-gray-200"><th>‡∏ä‡∏∑‡πà‡∏≠</th><th class="w-16">‡∏ä‡∏°.</th><th class="w-16">‡∏ô‡∏≤‡∏ó‡∏µ</th><th class="text-right">‡∏ö‡∏≤‡∏ó</th></tr></thead>
          <tbody id="bill-player-list"></tbody>
        </table>
      </div>

      <div class="flex justify-between items-center bg-green-100 p-3 rounded mb-4">
        <span class="font-bold text-green-800">‡∏£‡∏ß‡∏°:</span>
        <span id="bill-grand-total" class="font-black text-xl text-green-800">0</span>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button></form>
        <button class="btn btn-success text-white" onclick="copyBillSummary()">Copy</button>
      </div>
    </div>
  </dialog>

  <script>
    const LIFF_ID = "2009064792-6RT6YKWO";

    let user = null;
    let globalEvents = [];
    let globalAllPlayers = [];
    let globalSystem = {};
    let selectedCid = 1;

    function escapeHtml(s) {
      return (s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function showToast(text, type="info", ms=3500) {
      const root = document.getElementById("toast-root");
      const div = document.createElement("div");
      const cls = type === "error" ? "alert alert-error" : type === "success" ? "alert alert-success" : "alert alert-info";
      div.className = cls + " shadow-lg whitespace-pre-line";
      div.innerHTML = `<span>${escapeHtml(text)}</span>`;
      root.appendChild(div);
      setTimeout(() => div.remove(), ms);
    }

    function isUnrankedPlayer(p) {
      const cp = (p && typeof p.calib_played !== 'undefined') ? parseInt(p.calib_played || 0) : null;
      if (cp !== null && !isNaN(cp)) return cp < 10;
      const rt = (p && p.rank_title) ? String(p.rank_title) : "";
      return rt.startsWith("UNRANKED");
    }

    function mmrTextForUI(p) {
      if (!p) return "...";
      if (p.mmr_display) return p.mmr_display;
      if (isUnrankedPlayer(p)) {
        const cp = parseInt(p.calib_played || 0);
        return `UNRANKED (${isNaN(cp)?0:cp}/10)`;
      }
      return String(p.mmr ?? "...");
    }

    function minutesWaitedFromQueueSince(qs) {
      if (!qs) return 0;
      const sec = Math.max(0, Math.floor(Date.now()/1000 - Number(qs)));
      return Math.floor(sec / 60);
    }

    function switchTab(t) {
      document.querySelectorAll('.tab').forEach(e => e.classList.remove('tab-active'));
      ['live','stats','history','rank','events'].forEach(x => {
        const el = document.getElementById('tab-'+x);
        if (el) el.classList.add('hidden');
      });
      document.getElementById('tab-btn-'+t).classList.add('tab-active');
      document.getElementById('tab-'+t).classList.remove('hidden');
    }

    async function main() {
      const isLocalhost = location.hostname.includes("localhost");
      const isDebug = new URLSearchParams(location.search).get("debug") === "1";

      if (isLocalhost || isDebug) {
        return apiLogin("U1cf933e3a1559608c50c0456f6583dc9", "Admin Pond", "https://ui-avatars.com/api/?name=A");
      }

      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const p = await liff.getProfile();
        await apiLogin(p.userId, p.displayName, p.pictureUrl);
      } catch (e) {
        alert("LIFF Error: " + (e?.message || e));
        return apiLogin("U1cf933e3a1559608c50c0456f6583dc9", "Admin Pond", "https://ui-avatars.com/api/?name=A");
      }
    }

    async function apiLogin(uid, name, pic) {
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({userId: uid, displayName: name, pictureUrl: pic})
      });
      const data = await res.json();
      if (!res.ok || data.error) {
        alert(data.error || "Login failed");
        return;
      }
      user = data;
      renderUserUI();
      await refresh();
      setInterval(refresh, 5000);
    }

    function renderUserUI() {
      if (!user) return;

      document.getElementById('my-img').src = user.pictureUrl || "https://ui-avatars.com/api/?name=User";
      document.getElementById('my-mmr').innerText = mmrTextForUI(user);
      document.getElementById('my-rank-text').innerText = user.rank_title ?? "...";

      if (user.stats) {
        document.getElementById('st-wr').innerText = (user.stats.win_rate ?? 0) + "%";
        document.getElementById('st-total').innerText = user.stats.total ?? 0;
        document.getElementById('st-streak').innerText = user.stats.streak ?? 0;
        document.getElementById('st-partner').innerText = user.stats.best_partner ?? "-";
        document.getElementById('st-nemesis').innerText = user.stats.nemesis ?? "-";
      }

      const isStaff = (user.role === 'super' || user.role === 'mod');
      if (isStaff) {
        document.getElementById('btn-admin').classList.remove('hidden');
        document.getElementById('btn-bill').classList.remove('hidden');
        document.getElementById('staff-controls').classList.remove('hidden');
        document.getElementById('mod-court-control').classList.remove('hidden');
        document.getElementById('staff-extra').classList.remove('hidden');
        document.querySelectorAll('.staff-only').forEach(e => e.classList.remove('hidden'));
        document.getElementById('mod-tools').classList.remove('hidden');
      }
      if (user.role === 'super') {
        document.getElementById('super-admin-section').classList.remove('hidden');
      }
    }

    function updateCheckinBtn(meObj) {
      const btn = document.getElementById('btn-checkin');
      const badge = document.getElementById('status-badge');
      const reqBox = document.getElementById('partner-req-box');
      const btnRest = document.getElementById('btn-rest');

      const status = meObj?.status || user?.status || "offline";
      const resting = !!meObj?.resting;

      if (!btn) return;

      if (status === 'active') {
        btn.disabled = false;
        btn.innerText = "‚ùå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
        btn.className = "btn btn-outline btn-error w-full";

        if (resting) {
          badge.innerText = "‡∏û‡∏±‡∏Å";
          badge.className = "badge badge-warning";
        } else {
          badge.innerText = "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß";
          badge.className = "badge badge-success text-white";
        }

        // rest button visible only when active
        btnRest.classList.remove('hidden');
        if (resting) {
          btnRest.className = "btn btn-primary w-full mt-2";
          btnRest.innerHTML = `<i class="fa-solid fa-person-running"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß`;
          reqBox.classList.add('hidden'); // resting => no matching / no partner req
        } else {
          btnRest.className = "btn btn-outline w-full mt-2";
          btnRest.innerHTML = `<i class="fa-solid fa-mug-hot"></i> ‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢`;
          reqBox.classList.remove('hidden');
        }

      } else if (status === 'playing') {
        btn.innerText = "üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô";
        btn.disabled = true;
        btn.className = "btn btn-disabled w-full";
        badge.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô";
        badge.className = "badge badge-warning";
        reqBox.classList.add('hidden');
        btnRest.classList.add('hidden');
      } else {
        btn.disabled = false;
        btn.innerText = "‚úÖ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°";
        btn.className = "btn btn-primary w-full";
        badge.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤";
        badge.className = "badge badge-ghost";
        reqBox.classList.add('hidden');
        btnRest.classList.add('hidden');
      }

      const reqForm = document.getElementById('req-form');
      const reqActive = document.getElementById('req-active');
      if (status === 'active' && !resting) {
        if (user.partner_req) {
          reqForm.classList.add('hidden');
          reqActive.classList.remove('hidden');
          const target = globalAllPlayers.find(p => p.id === user.partner_req);
          document.getElementById('req-target-name').innerText = target ? target.nickname : '...';
        } else {
          reqForm.classList.remove('hidden');
          reqActive.classList.add('hidden');
        }
      } else {
        reqForm.classList.remove('hidden');
        reqActive.classList.add('hidden');
      }
    }

    function renderAutoMatchToggles() {
      const isStaff = (user.role === 'super' || user.role === 'mod');
      if (!isStaff) return;

      const list = document.getElementById("auto-courts-list");
      if (!list) return;

      const am = (globalSystem.auto_match_courts || {});
      const courtIds = Object.keys(globalSystem.auto_match_courts || {}).sort((a,b)=>parseInt(a)-parseInt(b));
      if (!courtIds.length) {
        list.innerHTML = `<div class="text-xs text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</div>`;
        return;
      }

      list.innerHTML = courtIds.map(cid => {
        const checked = am[cid] ? "checked" : "";
        return `
          <div class="flex items-center justify-between bg-gray-50 border rounded-lg px-3 py-2">
            <div class="font-bold text-sm text-gray-700">Court ${cid}</div>
            <input type="checkbox" class="toggle toggle-primary" ${checked} onchange="setAutoMatchCourt('${cid}', this.checked)">
          </div>
        `;
      }).join("");
    }

    function renderManualCourtOptions() {
      const sel = document.getElementById("man-court");
      if (!sel) return;
      const total = Object.keys(globalSystem.auto_match_courts || {}).length || 2;
      sel.innerHTML = "";
      for (let i=1;i<=total;i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.innerText = `Court ${i}`;
        sel.appendChild(opt);
      }
    }

    function renderMmrEditorOptions() {
      const isStaff = (user.role === 'super' || user.role === 'mod');
      if (!isStaff) return;

      const sel = document.getElementById("mmr-player-select");
      if (!sel) return;

      const cur = sel.value;
      sel.innerHTML = `<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô --</option>`;

      const sorted = [...globalAllPlayers].sort((a,b)=> (a.nickname||"").localeCompare(b.nickname||""));
      sorted.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.innerText = `${p.nickname} ‚Ä¢ ${p.rank_title}`;
        sel.appendChild(opt);
      });

      if (cur) sel.value = cur;
      syncMmrEditorFromSelect();
    }

    function syncMmrEditorFromSelect() {
      const sel = document.getElementById("mmr-player-select");
      const rankEl = document.getElementById("mmr-player-rank");
      const curEl = document.getElementById("mmr-player-current");
      const input = document.getElementById("mmr-new-value");

      if (!sel || !rankEl || !curEl || !input) return;

      const pid = sel.value;
      const p = globalAllPlayers.find(x => x.id === pid);
      if (!p) {
        rankEl.innerText = "-";
        curEl.innerText = "-";
        input.value = "";
        return;
      }

      rankEl.innerText = p.rank_title || "-";
      curEl.innerText = String(p.mmr ?? "-");
      if (!input.value) input.value = String(p.mmr ?? "");
    }

    async function adminSetMmr() {
      const sel = document.getElementById("mmr-player-select");
      const input = document.getElementById("mmr-new-value");
      if (!sel || !input) return;

      const targetId = sel.value;
      const val = parseInt(input.value);
      if (!targetId) return showToast("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô", "error");
      if (isNaN(val) || val < 0) return showToast("‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç MMR ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");

      const res = await fetch('/api/admin/set_mmr', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, targetUserId:targetId, newMmr: val})
      });
      const r = await res.json();
      if (r.error) return showToast(r.error, "error");

      showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï MMR ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ", "success");
      await refresh();
      await apiLogin(user.id, user.nickname, user.pictureUrl);
    }

    async function refresh() {
      if (!user) return;

      const res = await fetch('/api/get_dashboard?uid=' + encodeURIComponent(user.id));
      const d = await res.json();

      globalSystem = d.system || {};
      globalEvents = d.events || [];
      globalAllPlayers = d.all_players || [];

      const me = globalAllPlayers.find(p => p.id === user.id);
      if (me) {
        user.status = me.status;
        user.partner_req = me.partner_req;
        user.mmr = me.mmr;
        user.mmr_display = me.mmr_display;
        user.rank_title = me.rank_title;
        user.resting = !!me.resting;

        document.getElementById('my-mmr').innerText = mmrTextForUI(me);
        document.getElementById('my-rank-text').innerText = user.rank_title || "...";
      }

      renderAutoMatchToggles();
      renderManualCourtOptions();
      renderMmrEditorOptions();

      const isSessionActive = !!(globalSystem && globalSystem.is_session_active);
      const sessAlert = document.getElementById('session-alert');
      const btnCheckin = document.getElementById('btn-checkin');
      const btnRest = document.getElementById('btn-rest');
      const reqBox = document.getElementById('partner-req-box');

      if (!isSessionActive) {
        sessAlert.classList.remove('hidden');
        btnCheckin.disabled = true;
        btnCheckin.innerText = "‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πä‡∏ß‡∏ô...";
        btnCheckin.classList.add('btn-disabled');
        reqBox.classList.add('hidden');
        btnRest.classList.add('hidden');
      } else {
        sessAlert.classList.add('hidden');
        btnCheckin.disabled = false;
        btnCheckin.classList.remove('btn-disabled');
        updateCheckinBtn(me || user);
      }

      document.getElementById('court-count-display').innerText = Object.keys(d.courts || {}).length;

      // courts render (with timer minutes)
      const cc = document.getElementById('courts-container');
      cc.innerHTML = '';

      const isStaff = (user.role === 'super' || user.role === 'mod');

      for (const [cid, m] of Object.entries(d.courts || {})) {
        if (m) {
          const min = m.elapsed_min ?? Math.floor((m.elapsed_sec || 0) / 60);
          const autoOn = !!(globalSystem.auto_match_courts && globalSystem.auto_match_courts[String(cid)]);

          const renderTeam = (teamData) => (teamData || []).map(p =>
            `<div class="flex items-center gap-1">
              <img src="${p.pic || ''}" class="w-5 h-5 rounded-full">
              <span class="truncate max-w-[90px]">${p.name || ''}</span>
            </div>`
          ).join('');

          const isPlayerInMatch = (m.team_a_ids || []).includes(user.id) || (m.team_b_ids || []).includes(user.id);
          const canEnd = isStaff || isPlayerInMatch;

          cc.innerHTML += `
            <div class="card bg-white border border-indigo-100 shadow-sm p-3">
              <div class="flex justify-between items-center mb-2">
                <span class="text-indigo-700 font-bold">COURT ${cid}</span>
                <div class="flex items-center gap-2">
                  <span class="badge badge-outline">${min} ‡∏ô‡∏≤‡∏ó‡∏µ</span>
                  <span class="badge ${autoOn?'badge-success text-white':'badge-ghost'}">${autoOn?'Auto ON':'Auto OFF'}</span>
                </div>
              </div>

              <div class="flex items-start justify-between text-sm">
                <div class="flex flex-col gap-1 w-[45%] items-end text-right font-medium">${renderTeam(m.team_a_data)}</div>
                <div class="font-bold text-red-500 self-center">VS</div>
                <div class="flex flex-col gap-1 w-[45%] items-start text-left font-medium">${renderTeam(m.team_b_data)}</div>
              </div>

              ${canEnd ? `
                <button onclick="selectedCid=${cid};document.getElementById('modal_finish').showModal();document.getElementById('fin-cid').innerText=${cid}"
                  class="btn btn-xs btn-error text-white w-full mt-2">
                  ‡∏à‡∏ö‡πÄ‡∏Å‡∏° / Cancel
                </button>` : ``}
            </div>
          `;
        } else {
          const autoOn = !!(globalSystem.auto_match_courts && globalSystem.auto_match_courts[String(cid)]);
          cc.innerHTML += `
            <div class="p-4 border-2 border-dashed rounded text-center text-gray-400 text-sm">
              Court ${cid} ‡∏ß‡πà‡∏≤‡∏á ‚Ä¢ ${autoOn ? 'AutoMatch ON (‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏û‡∏≠)' : 'AutoMatch OFF'}
            </div>`;
        }
      }

      // super admin mod list
      if (user.role === 'super') {
        document.getElementById('admin-user-list').innerHTML = globalAllPlayers.map(p => `
          <tr>
            <td>${p.nickname}</td>
            <td class="text-right">
              <input type="checkbox" class="toggle toggle-xs toggle-success" ${p.is_mod ? 'checked' : ''} onchange="toggleMod('${p.id}', this.checked)">
            </td>
          </tr>
        `).join('');
      }

      // queue list (show waited minutes + status)
      document.getElementById('q-count').innerText = d.queue_count || 0;

      document.getElementById('queue-list').innerHTML = (d.queue || []).map((p, i) => {
        const waited = minutesWaitedFromQueueSince(p.queue_since);
        const status = p.status === "playing" ? "‡πÄ‡∏•‡πà‡∏ô" : (p.resting ? "‡∏û‡∏±‡∏Å" : "‡∏£‡∏≠");
        const badgeCls = p.status === "playing" ? "badge badge-warning"
                        : (p.resting ? "badge badge-ghost" : "badge badge-success text-white");
        const reqHtml = (p.partner_req && !p.resting) ? (() => {
          const target = globalAllPlayers.find(x => x.id === p.partner_req);
          if (!target) return '';
          return `<span class="badge badge-xs badge-outline ml-1 text-indigo-500 gap-1"><i class="fa-solid fa-link"></i> ‡∏Ñ‡∏π‡πà ${target.nickname}</span>`;
        })() : '';

        return `<tr class="border-b">
          <td class="text-sm">${p.nickname} ${reqHtml}</td>
          <td class="text-right font-mono">${waited}</td>
          <td class="text-right"><span class="${badgeCls} badge-xs">${status}</span></td>
        </tr>`;
      }).join('');

      // leaderboard (hide mmr for unranked)
      document.getElementById('lb-list').innerHTML = (d.leaderboard || []).map((p, i) => `
        <tr>
          <td class="font-bold text-gray-500">${i + 1}</td>
          <td>
            <div class="flex items-center gap-2">
              <div class="avatar"><div class="w-6 rounded-full"><img src="${p.pictureUrl}"></div></div>
              <div class="flex flex-col">
                <span class="text-sm font-bold">${p.nickname}</span>
                <span class="text-[10px] text-gray-400">${p.rank_title}</span>
              </div>
            </div>
          </td>
          <td class="text-right">
            <div class="font-mono font-bold text-indigo-600">${mmrTextForUI(p)}</div>
          </td>
        </tr>
      `).join('');

      // partner select (active only & not resting)
      const pSelect = document.getElementById('partner-select');
      if (pSelect && document.activeElement !== pSelect) {
        const cur = pSelect.value;
        pSelect.innerHTML = '<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>';
        globalAllPlayers
          .filter(p => p.id !== user.id && p.status === 'active' && !p.resting)
          .forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.innerText = p.nickname;
            pSelect.appendChild(opt);
          });
        if (cur) pSelect.value = cur;
      }

      // manual selects (active only, not resting)
      document.querySelectorAll('.player-select').forEach(s => {
        if (document.activeElement !== s && s.children.length <= 1) {
          s.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
          globalAllPlayers
            .filter(p => p.status === 'active' && !p.resting)
            .forEach(p => {
              const opt = document.createElement('option');
              opt.value = p.id;
              opt.innerText = p.nickname;
              s.appendChild(opt);
            });
        }
      });

      renderIncomingRequests(d.incoming_partner_requests || []);

      if (d.notifications_unread && d.notifications_unread.length) {
        d.notifications_unread.forEach(n => showToast(n.text, "success", 4500));
        const ids = d.notifications_unread.map(x => x.id);
        fetch('/api/notifications/ack', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({userId: user.id, ids})
        });
      }

      // history: include duration minutes
      const hList = document.getElementById('history-list');
      if (hList && user.my_history) {
        const hideDelta = isUnrankedPlayer(user);
        hList.innerHTML = user.my_history.length ? user.my_history.map(m => {
          const myTeam = (m.team_a_ids || []).includes(user.id) ? 'A' : 'B';
          const isWin = m.winner_team === myTeam;

          let change = isWin ? "+0" : "-0";
          if (!hideDelta && m.mmr_snapshot && m.mmr_snapshot[user.id]) change = m.mmr_snapshot[user.id].change;
          if (hideDelta) change = "UNRANKED";

          const timePart = (m.date || "").split(' ')[1] || "";
          const durMin = (typeof m.duration_min !== "undefined") ? m.duration_min : Math.floor((m.duration_sec || 0)/60);
          const court = m.court_id ? `C${m.court_id}` : "";

          return `<tr>
            <td>${isWin ? '<span class="badge badge-success text-white">W</span>' : '<span class="badge badge-error text-white">L</span>'}</td>
            <td class="text-xs">${timePart} ‚Ä¢ ${durMin}m ${court ? '‚Ä¢ '+court : ''}</td>
            <td class="text-right font-bold ${isWin?'text-green-600':'text-red-500'}">${change}</td>
          </tr>`;
        }).join('') : `<tr><td colspan="3" class="text-center p-4 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>`;
      }

      renderEvents();
    }

    function renderIncomingRequests(list) {
      const box = document.getElementById('incoming-box');
      const el = document.getElementById('incoming-list');
      if (!box || !el) return;

      if (!list.length || user.status !== 'active' || user.resting) {
        box.classList.add('hidden');
        el.innerHTML = '';
        return;
      }

      box.classList.remove('hidden');
      el.innerHTML = list.map(p => `
        <div class="flex items-center justify-between bg-white border rounded p-2">
          <div class="flex items-center gap-2">
            <img src="${p.pictureUrl || ''}" class="w-7 h-7 rounded-full">
            <div class="text-sm font-bold">${p.nickname}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-xs btn-success text-white" onclick="respondPartner('${p.id}','accept')">‡∏£‡∏±‡∏ö</button>
            <button class="btn btn-xs btn-ghost text-red-500" onclick="respondPartner('${p.id}','decline')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
          </div>
        </div>
      `).join('');
    }

    function renderEvents() {
      const el = document.getElementById('events-list');
      if (!el) return;

      if (!globalEvents.length) {
        el.innerHTML = `<div class="text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Events</div>`;
        return;
      }

      const isStaff = (user.role === 'super' || user.role === 'mod');

      el.innerHTML = globalEvents.map(e => {
        const joinedCount = (e.joined_users || []).length;
        const joinedMe = (e.players || []).includes(user.id);
        const isSession = e.type === "session";

        return `
          <div class="card bg-white shadow-sm border p-3">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-bold text-gray-800">
                  ${e.name}
                  ${isSession ? `<span class="badge badge-info badge-sm ml-2">SESSION</span>` : ``}
                  ${e.status === 'ended' ? `<span class="badge badge-ghost badge-sm ml-1">ENDED</span>` : ``}
                </div>
                <div class="text-xs text-gray-500">${formatDate(e.datetime)}</div>
                <div class="text-xs text-gray-500 mt-1">üë• ${joinedCount} ‡∏Ñ‡∏ô</div>
              </div>
              ${isStaff && !isSession ? `<button class="btn btn-xs btn-ghost text-red-500" onclick="deleteEvent('${e.id}')">‡∏•‡∏ö</button>` : ``}
            </div>

            <div class="flex flex-wrap gap-2 mt-2">
              ${(e.joined_users || []).map(u => `
                <span class="badge badge-outline">
                  <img src="${u.pictureUrl || ''}" class="w-4 h-4 rounded-full mr-1">${u.nickname}
                </span>
              `).join('')}
            </div>

            ${
              isSession
              ? `<div class="text-xs text-gray-400 mt-3 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏î‡∏¢‡∏Å‡∏î ‚Äú‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°‚Äù</div>`
              : (e.status === 'ended'
                  ? `<div class="text-xs text-gray-400 mt-3 text-center">Event ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>`
                  : `<button class="btn btn-sm w-full mt-3 ${joinedMe ? 'btn-outline btn-error' : 'btn-primary'}"
                            onclick="toggleEventJoin('${e.id}')">
                       ${joinedMe ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°'}
                     </button>`
                )
            }
          </div>
        `;
      }).join('');
    }

    // ---- API actions ----
    async function toggleStatus() {
      const res = await fetch('/api/toggle_status', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      const r = await res.json();
      if (r.error) showToast(r.error, "error");
      await apiLogin(user.id, user.nickname, user.pictureUrl);
    }

    async function toggleRest() {
      const res = await fetch('/api/toggle_rest', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      const r = await res.json();
      if (r.error) return showToast(r.error, "error");
      showToast(r.resting ? "‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß üí§ (‡∏¢‡∏±‡∏á‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà)" : "‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‚úÖ", "success");
      await refresh();
    }

    async function requestPartner() {
      const targetId = document.getElementById('partner-select').value;
      if (!targetId) return showToast("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö", "error");
      const res = await fetch('/api/request_partner', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, targetId})
      });
      const r = await res.json();
      if (r.error) showToast(r.error, "error");
      await apiLogin(user.id, user.nickname, user.pictureUrl);
    }

    async function cancelRequest() {
      await fetch('/api/cancel_request', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      await apiLogin(user.id, user.nickname, user.pictureUrl);
    }

    async function respondPartner(requesterId, action) {
      await fetch('/api/partner/respond', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, requesterId, action})
      });
      await apiLogin(user.id, user.nickname, user.pictureUrl);
    }

    async function matchmake() {
      // staff only button: fill disabled-auto courts
      const res = await fetch('/api/matchmake', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId: user.id})
      });
      const r = await res.json();

      if (r.error) return showToast(r.error, "error");

      if (r.status !== 'matched') {
        showToast('‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î AutoMatch ‡∏ß‡πà‡∏≤‡∏á', "info");
      } else {
        showToast(`‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ${r.matched_count || 1} ‡∏™‡∏ô‡∏≤‡∏° ‚úÖ`, "success");
        refresh();
      }
    }

    async function submitRes(w) {
      const res = await fetch('/api/submit_result', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({courtId:selectedCid, winner:w, userId:user.id})
      });
      const r = await res.json();
      if (r.error) return showToast(r.error, "error");

      document.getElementById('modal_finish').close();

      if (r.auto_matches && r.auto_matches.length) {
        showToast(`‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ AutoMatch ‡πÄ‡∏ï‡∏¥‡∏° ${r.auto_matches.length} ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ‚úÖ`, "success", 4500);
      } else {
        showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚úÖ`, "success");
      }

      await apiLogin(user.id, user.nickname, user.pictureUrl);
      refresh();
    }

    async function cancelMatch() {
      const res = await fetch('/api/cancel_match', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({courtId:selectedCid, userId:user.id})
      });
      const r = await res.json();
      if (r.error) return showToast(r.error, "error");

      document.getElementById('modal_finish').close();

      if (r.auto_matches && r.auto_matches.length) {
        showToast(`Cancel ‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ AutoMatch ‡πÄ‡∏ï‡∏¥‡∏° ${r.auto_matches.length} ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó ‚úÖ`, "success", 4500);
      } else {
        showToast("Cancel ‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ô‡∏µ‡πâ AutoMatch OFF ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠)", "info");
      }

      refresh();
    }

    function openManualMatch() {
      document.getElementById('modal_manual_match').showModal();
    }

    async function submitManualMatch() {
      const courtId = document.getElementById('man-court').value;
      const p1 = document.getElementById('man-p1').value;
      const p2 = document.getElementById('man-p2').value;
      const p3 = document.getElementById('man-p3').value;
      const p4 = document.getElementById('man-p4').value;

      if(!p1||!p2||!p3||!p4) return showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', "error");
      if(new Set([p1,p2,p3,p4]).size !== 4) return showToast('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', "error");

      const res = await fetch('/api/matchmake/manual', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId:courtId, playerIds:[p1,p2,p3,p4]})
      });
      const r = await res.json();
      if (r.error) return showToast(r.error, "error");

      document.getElementById('modal_manual_match').close();
      showToast("‡∏à‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
      refresh();
    }

    async function toggleSession(action) {
      if (action === 'end' && !confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô?')) return;
      await fetch('/api/admin/toggle_session', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action, userId:user.id})
      });
      location.reload();
    }

    async function changeCourtCount(delta) {
      const current = parseInt(document.getElementById('court-count-display').innerText || "2");
      const res = await fetch('/api/admin/update_courts', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, count: current + delta})
      });
      const r = await res.json();
      if (r.error) showToast(r.error, "error");
      refresh();
    }

    async function setAutoMatchCourt(courtId, enabled) {
      const res = await fetch('/api/admin/set_auto_match_court', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId, enabled})
      });
      const r = await res.json();
      if (r.error) showToast(r.error, "error");
      else showToast(`Court ${courtId} AutoMatch = ${enabled ? "ON" : "OFF"}`, "success");
      refresh();
    }

    async function toggleMod(tid, val) {
      await fetch('/api/admin/manage_mod', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({requesterId:user.id, targetUserId:tid, action: val ? 'promote' : 'demote'})
      });
    }

    async function resetSystem() {
      if(!confirm('‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
      if(!confirm('‚õîÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢!')) return;
      await fetch('/api/admin/reset_system', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      showToast('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', "success");
      location.reload();
    }

    async function submitNewEvent() {
      const n = document.getElementById('evt-name').value.trim();
      const t = document.getElementById('evt-time').value;
      if(!n||!t) return showToast("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö", "error");
      const timestamp = Math.floor(new Date(t).getTime() / 1000);

      const res = await fetch('/api/event/create', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, name:n, datetime:timestamp})
      });
      const r = await res.json();
      if(r.error) return showToast(r.error, "error");

      document.getElementById('evt-name').value = '';
      document.getElementById('evt-time').value = '';
      showToast("‡∏™‡∏£‡πâ‡∏≤‡∏á event ‡πÅ‡∏•‡πâ‡∏ß", "success");
      refresh();
      switchTab('events');
    }

    async function deleteEvent(eid) {
      if(!confirm('‡∏•‡∏ö‡∏ô‡∏∞?')) return;
      const res = await fetch('/api/event/delete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, eventId:eid})
      });
      const r = await res.json();
      if (r.error) showToast(r.error, "error");
      refresh();
    }

    async function toggleEventJoin(eid) {
      const res = await fetch('/api/event/join_toggle', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({eventId:eid, userId:user.id})
      });
      const r = await res.json();
      if (r.error) showToast(r.error, "error");
      refresh();
    }

    // ---- Billing ----
    async function openBillingModal() {
      await refresh();
      const select = document.getElementById('bill-event-select');

      const sessions = globalEvents.filter(e => e.type === "session");
      sessions.sort((a,b) => (b.sort_key || 0) - (a.sort_key || 0));
      const target = sessions.slice(0, 10);

      select.innerHTML = '<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Session (10 ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) --</option>';
      target.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.innerText = `${e.name} (${formatDate(e.datetime)})`;
        select.appendChild(opt);
      });

      document.getElementById('modal_billing').showModal();
    }

    function loadBillPlayers() {
      const eid = document.getElementById('bill-event-select').value;
      const showAll = document.getElementById('bill-show-all').checked;
      const evt = globalEvents.find(e => e.id === eid);
      const tbody = document.getElementById('bill-player-list');
      const defHr = document.getElementById('bill-default-hr').value || 2;

      tbody.innerHTML = '';

      let candidates = [];
      if (showAll) {
        candidates = globalAllPlayers;
      } else if (evt) {
        candidates = (evt.joined_users || []).map(u => {
          const full = globalAllPlayers.find(p => p.id === u.id);
          return full ? full : { id: u.id, nickname: u.nickname, pictureUrl: u.pictureUrl };
        });
      }

      if (!candidates.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</td></tr>';
        calculateBill();
        return;
      }

      candidates.forEach(u => {
        tbody.innerHTML += `
          <tr class="bill-row" data-name="${u.nickname}">
            <td>
              <div class="flex items-center gap-2">
                <img src="${u.pictureUrl || ''}" class="w-6 h-6 rounded-full">
                ${u.nickname}
                <button onclick="this.closest('tr').remove();calculateBill()" class="btn btn-xs btn-ghost text-red-400 rounded-full px-1">x</button>
              </div>
            </td>
            <td><input type="number" class="input input-bordered input-xs w-full bill-hr" value="${defHr}" min="0" oninput="calculateBill()"></td>
            <td><input type="number" class="input input-bordered input-xs w-full bill-min" value="0" min="0" step="5" oninput="calculateBill()"></td>
            <td class="text-right font-bold bill-price">0</td>
          </tr>
        `;
      });

      calculateBill();
    }

    function applyDefaultTime() {
      const def = document.getElementById('bill-default-hr').value;
      document.querySelectorAll('.bill-hr').forEach(el => el.value = def);
      document.querySelectorAll('.bill-min').forEach(el => el.value = 0);
      calculateBill();
    }

    function calculateBill() {
      const totalCost = parseFloat(document.getElementById('bill-total-cost').value) || 0;
      const rows = document.querySelectorAll('.bill-row');

      let totalMinutesPool = 0;
      rows.forEach(row => {
        const h = parseInt(row.querySelector('.bill-hr').value) || 0;
        const m = parseInt(row.querySelector('.bill-min').value) || 0;
        totalMinutesPool += (h * 60) + m;
      });

      const costPerMin = totalMinutesPool > 0 ? (totalCost / totalMinutesPool) : 0;
      let grandTotal = 0;

      rows.forEach(row => {
        const h = parseInt(row.querySelector('.bill-hr').value) || 0;
        const m = parseInt(row.querySelector('.bill-min').value) || 0;
        const myCost = Math.ceil(((h * 60) + m) * costPerMin);
        row.querySelector('.bill-price').innerText = myCost;
        grandTotal += myCost;
      });

      document.getElementById('bill-grand-total').innerText = grandTotal;
    }

    function copyBillSummary() {
      const eid = document.getElementById('bill-event-select').value;
      const evt = globalEvents.find(e => e.id === eid);
      const evtName = evt ? evt.name : "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏Å‡πä‡∏ß‡∏ô";

      let txt = `üí∏ ${evtName}\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${document.getElementById('bill-total-cost').value} ‡∏ö‡∏≤‡∏ó\n------------------\n`;
      document.querySelectorAll('.bill-row').forEach(row => {
        const name = row.dataset.name;
        const price = row.querySelector('.bill-price').innerText;
        const h = row.querySelector('.bill-hr').value;
        const m = row.querySelector('.bill-min').value;
        txt += `${name} (${m>0?`${h}‡∏ä‡∏°.${m}‡∏ô.`:`${h}‡∏ä‡∏°.`}) = ${price}.- \n`;
      });
      txt += `------------------\n‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏à‡πä‡∏∞ üòò`;

      navigator.clipboard.writeText(txt).then(() => showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡πÑ‡∏õ‡πÅ‡∏õ‡∏∞‡πÉ‡∏ô LINE ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', "success"));
    }

    function formatDate(dt) {
      const dateObj = typeof dt === 'number' ? new Date(dt * 1000) : new Date(dt);
      return dateObj.toLocaleDateString('th-TH', {weekday:'short', day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
    }

    main();
  </script>
</body>
</html>
