<!-- templates/index.html -->
<!DOCTYPE html>
<html data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>izesquad</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <script>var vConsole = new VConsole();</script>
</head>
<body class="bg-slate-100 min-h-screen pb-24">

  <!-- Topbar -->
  <div class="navbar bg-white shadow-sm px-4 sticky top-0 z-50">
    <div class="flex-1">
      <span class="text-xl font-black text-indigo-600 italic">izesquad <i class="fa-solid fa-bolt text-yellow-400"></i></span>
    </div>
    <div class="flex-none gap-2 items-center">
      <button id="btn-admin" class="btn btn-circle btn-ghost text-red-600 hidden" onclick="openAdmin()">
        <i class="fa-solid fa-gear text-xl"></i>
      </button>

      <div class="text-right">
        <div class="text-[10px] text-gray-500">MMR</div>
        <div class="font-bold text-indigo-600" id="my-mmr">...</div>
      </div>

      <div class="avatar">
        <div class="w-10 rounded-full ring ring-indigo-500 ring-offset-2">
          <img id="my-img" src="https://ui-avatars.com/api/?name=User" />
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="px-2 mt-3">
    <div role="tablist" class="tabs tabs-boxed bg-white shadow-sm font-bold">
      <a role="tab" id="tab-btn-live" class="tab tab-active" onclick="switchTab('live')">‡∏™‡∏ô‡∏≤‡∏°</a>
      <a role="tab" id="tab-btn-stats" class="tab" onclick="switchTab('stats')">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</a>
      <a role="tab" id="tab-btn-history" class="tab" onclick="switchTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
      <a role="tab" id="tab-btn-leader" class="tab" onclick="switchTab('leader')">Leaderboard</a>
      <a role="tab" id="tab-btn-events" class="tab" onclick="switchTab('events')">Events</a>
    </div>
  </div>

  <!-- LIVE -->
  <div id="tab-live" class="p-4 max-w-md mx-auto fade-in">
    <div id="session-alert" class="hidden alert alert-warning mb-4 shadow-sm">
      <i class="fa-solid fa-triangle-exclamation"></i><span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô (‡∏£‡∏≠ Mod ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°)</span>
    </div>

    <!-- Status card -->
    <div class="card bg-white shadow-md mb-4 border-l-4 border-indigo-500">
      <div class="card-body p-4">
        <div class="flex justify-between items-center mb-2">
          <span class="font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status-badge" class="badge">...</span></span>
          <div class="flex gap-2 items-center">
            <span id="my-rank-text" class="text-xs font-bold text-gray-400">...</span>
            <span id="my-rank-badge" class="badge badge-xs badge-ghost">...</span>
            <span id="my-rank-badge2" class="badge badge-xs badge-outline hidden">...</span>
          </div>
        </div>

        <button id="btn-checkin" onclick="toggleStatusConfirm()" class="btn btn-primary w-full">Loading...</button>

        <div class="grid grid-cols-2 gap-2 mt-2">
          <button id="btn-rest" onclick="toggleRest()" class="btn btn-outline btn-sm">‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢</button>
          <button id="btn-auto-rest" onclick="toggleAutoRest()" class="btn btn-outline btn-sm">Auto Rest: OFF</button>
        </div>

        <!-- Pair request box -->
        <div id="pair-box" class="mt-3 hidden">
          <div class="divider text-xs text-gray-400 my-2">‡∏Ç‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</div>

          <!-- Pair locked -->
          <div id="pair-locked" class="hidden bg-indigo-50 p-2 rounded border border-indigo-100">
            <div class="text-xs text-indigo-700">
              ü§ù ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏±‡∏ö <b id="pair-locked-name">...</b>
            </div>
            <button onclick="cancelPair()" class="btn btn-xs btn-ghost text-red-500 mt-1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏π‡πà</button>
          </div>

          <!-- Outgoing request -->
          <div id="pair-outgoing" class="hidden bg-orange-50 p-2 rounded border border-orange-100">
            <div class="text-xs text-orange-700">
              üì© ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡πâ <b id="pair-outgoing-name">...</b> ‡πÅ‡∏•‡πâ‡∏ß
            </div>
            <button onclick="cancelOutgoing()" class="btn btn-xs btn-ghost text-red-500 mt-1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
          </div>

          <!-- Request form -->
          <div id="pair-form" class="join w-full">
            <select id="partner-select" class="select select-bordered select-sm w-full join-item text-xs">
              <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>
            </select>
            <button onclick="sendPairRequest()" class="btn btn-sm btn-primary join-item">‡∏Ç‡∏≠</button>
          </div>

          <!-- Inbox -->
          <div class="mt-3">
            <div class="text-xs font-bold text-gray-500 mb-1">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤</div>
            <div id="pair-inbox" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Staff controls -->
    <div id="staff-controls" class="hidden mb-4 space-y-2">
      <div class="bg-white p-3 rounded-xl shadow-sm border">
        <div class="font-bold text-gray-600 mb-2 flex justify-between items-center">
          <span>AutoMatch ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</span>
          <span class="text-xs text-gray-400">‡∏ß‡πà‡∏≤‡∏á/‡∏à‡∏ö‡πÄ‡∏Å‡∏° = ‡∏à‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á</span>
        </div>
        <div id="auto-courts" class="grid grid-cols-3 gap-2"></div>
      </div>

      <button onclick="runMatchmakeNonAuto()" class="btn btn-neutral w-full shadow-lg">
        <i class="fa-solid fa-shuffle"></i> ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î Auto)
      </button>

      <button onclick="openManualMatch()" class="btn btn-outline w-full">
        <i class="fa-solid fa-hand-pointer"></i> ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏≠‡∏á (Manual)
      </button>
    </div>

    <!-- Courts -->
    <div id="courts-container" class="space-y-3 mb-6"></div>

    <!-- Queue -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between items-center">
        <span>‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô</span>
        <div class="flex gap-2 items-center">
          <span id="q-count" class="badge badge-neutral">0</span>
          <span id="q-playing" class="badge badge-outline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á 0</span>
        </div>
      </div>
      <table class="table table-sm">
        <tbody id="queue-list"></tbody>
      </table>
    </div>
  </div>

  <!-- STATS -->
  <div id="tab-stats" class="p-4 max-w-md mx-auto hidden">
    <div class="card bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-xl mb-4">
      <div class="card-body p-5 text-center">
        <h2 class="text-lg font-bold opacity-80">WIN RATE (Sets)</h2>
        <div class="text-5xl font-black my-2" id="st-wr">WR -</div>
        <div class="flex justify-center gap-4 text-sm opacity-90">
          <span>üèÜ Sets: <b id="st-sets">0</b></span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4">
      <div class="bg-white p-3 rounded-xl shadow-sm border">
        <div class="text-xs text-gray-400 mb-1">‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
        <div class="text-xl font-bold text-gray-700" id="st-pts-for">0</div>
      </div>
      <div class="bg-white p-3 rounded-xl shadow-sm border">
        <div class="text-xs text-gray-400 mb-1">‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏£‡∏ß‡∏°</div>
        <div class="text-xl font-bold text-gray-700" id="st-pts-against">0</div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-3 border">
      <div class="text-xs text-gray-400 mb-1">‡∏´‡∏•‡∏≠‡∏î Progress</div>
      <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
        <div id="st-progress-bar" class="bg-indigo-500 h-3" style="width:0%"></div>
      </div>
      <div class="text-xs text-gray-500 mt-1 flex justify-between">
        <span id="st-progress-range">-</span>
        <span id="st-progress-hint"></span>
      </div>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="tab-history" class="p-4 max-w-md mx-auto hidden">
    <div class="tabs tabs-boxed bg-white shadow-sm font-bold mb-3">
      <a class="tab tab-active" id="hist-tab-my" onclick="switchHistory('my')">‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
      <a class="tab" id="hist-tab-global" onclick="switchHistory('global')">Global</a>
    </div>

    <div id="history-my" class="space-y-3"></div>
    <div id="history-global" class="space-y-3 hidden"></div>
  </div>

  <!-- LEADERBOARD -->
  <div id="tab-leader" class="p-4 max-w-md mx-auto hidden">
    <div class="tabs tabs-boxed bg-white shadow-sm font-bold mb-3">
      <a class="tab tab-active" id="lb-tab-mmr" onclick="switchLB('mmr')">MMR</a>
      <a class="tab" id="lb-tab-points" onclick="switchLB('points')">‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°</a>
      <a class="tab" id="lb-tab-wr" onclick="switchLB('wr')">Winrate</a>
    </div>

    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <table class="table table-sm">
        <tbody id="lb-list"></tbody>
      </table>
    </div>
  </div>

  <!-- EVENTS (simple list) -->
  <div id="tab-events" class="p-4 max-w-md mx-auto hidden">
    <div class="bg-white p-4 rounded shadow mb-4 hidden" id="evt-create">
      <h3 class="font-bold text-sm mb-2">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Event</h3>
      <input id="evt-name" class="input input-bordered input-sm w-full mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πä‡∏ß‡∏ô">
      <input id="evt-time" type="datetime-local" class="input input-bordered input-sm w-full mb-2">
      <button onclick="submitNewEvent()" class="btn btn-primary btn-sm w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button>
    </div>

    <div id="events-list" class="space-y-3"></div>
  </div>

  <!-- MODALS -->
  <dialog id="modal_admin" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4 text-red-600">Admin Panel</h3>

      <div class="mb-4 p-4 bg-red-50 rounded-lg border border-red-100">
        <h4 class="font-bold text-sm mb-2">Session Control</h4>

        <div class="grid grid-cols-2 gap-2 mb-2">
          <label class="text-xs font-bold text-gray-600">‡πÅ‡∏ï‡πâ‡∏°</label>
          <select id="cfg-points" class="select select-bordered select-sm">
            <option value="21" selected>21</option>
            <option value="11">11</option>
          </select>

          <label class="text-xs font-bold text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ã‡πá‡∏ï</label>
          <select id="cfg-bo" class="select select-bordered select-sm">
            <option value="1" selected>BO1</option>
            <option value="2">BO2</option>
            <option value="3">BO3</option>
          </select>
        </div>

        <label class="label cursor-pointer justify-start gap-2">
          <input type="checkbox" id="cfg-notify" class="checkbox checkbox-sm checkbox-primary">
          <span class="label-text font-bold text-gray-600">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏™‡∏±‡πà‡∏ô)</span>
        </label>

        <button id="btn-sess-start" onclick="toggleSession('start')" class="btn btn-success text-white w-full mb-2">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô</button>
        <button id="btn-sess-end" onclick="toggleSession('end')" class="btn btn-error text-white w-full">üèÅ ‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô</button>
      </div>

      <div class="mb-4 p-4 bg-white rounded border">
        <h4 class="font-bold text-sm mb-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç MMR (Mod)</h4>
        <select id="mmr-user" class="select select-bordered select-sm w-full mb-2"></select>
        <input id="mmr-value" type="number" class="input input-bordered input-sm w-full mb-2" placeholder="MMR ‡πÉ‡∏´‡∏°‡πà">
        <button class="btn btn-primary btn-sm w-full" onclick="saveMMR()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>

      <div id="super-admin-section" class="mb-4 hidden">
        <h4 class="font-bold text-sm mb-2">Moderators (Super only)</h4>
        <div class="h-48 overflow-y-auto border rounded p-2 bg-white">
          <table class="table table-xs"><tbody id="admin-user-list"></tbody></table>
        </div>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn">‡∏õ‡∏¥‡∏î</button></form>
      </div>
    </div>
  </dialog>

  <dialog id="modal_manual_match" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">üñê ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏≠‡∏á</h3>
      <select id="man-court" class="select select-bordered select-sm w-full mb-2"></select>

      <div class="grid grid-cols-2 gap-2 mb-4">
        <div class="bg-red-50 p-2 rounded">
          <div class="font-bold text-red-500 text-xs mb-1">TEAM A</div>
          <select id="man-p1" class="select select-bordered select-xs w-full mb-1 player-select"></select>
          <select id="man-p2" class="select select-bordered select-xs w-full player-select"></select>
        </div>
        <div class="bg-blue-50 p-2 rounded">
          <div class="font-bold text-blue-500 text-xs mb-1">TEAM B</div>
          <select id="man-p3" class="select select-bordered select-xs w-full mb-1 player-select"></select>
          <select id="man-p4" class="select select-bordered select-xs w-full player-select"></select>
        </div>
      </div>

      <button onclick="submitManualMatch()" class="btn btn-primary w-full">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á</button>
      <form method="dialog" class="mt-2 text-center"><button class="btn btn-ghost btn-sm">‡∏õ‡∏¥‡∏î</button></form>
    </div>
  </dialog>

  <!-- Score modal -->
  <dialog id="modal_score" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-1">‡∏à‡∏ö‡πÄ‡∏Å‡∏° Court <span id="score-court">-</span></h3>
      <div class="text-xs text-gray-500 mb-2" id="match-timer-hint"></div>

      <div class="bg-gray-50 p-2 rounded border mb-3">
        <div class="text-xs font-bold text-gray-600">TEAM A</div>
        <div id="teamA-names" class="text-sm font-bold"></div>
        <div class="text-xs font-bold text-gray-600 mt-2">TEAM B</div>
        <div id="teamB-names" class="text-sm font-bold"></div>
      </div>

      <div id="set-inputs" class="space-y-2 mb-3"></div>

      <button class="btn btn-primary w-full" onclick="submitScore()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
      <button class="btn btn-outline w-full mt-2" onclick="cancelMatch()">Cancel match (‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</button>

      <form method="dialog" class="mt-2 text-center"><button class="btn btn-ghost btn-sm">‡∏õ‡∏¥‡∏î</button></form>
    </div>
  </dialog>

  <!-- Profile modal -->
  <dialog id="modal_profile" class="modal">
    <div class="modal-box">
      <div class="flex items-center gap-3">
        <div class="avatar">
          <div class="w-14 rounded-full">
            <img id="pf-img" src="">
          </div>
        </div>
        <div>
          <div class="font-black text-lg" id="pf-name">-</div>
          <div class="flex gap-2 items-center mt-1">
            <span id="pf-badge" class="badge badge-sm badge-ghost">-</span>
            <span id="pf-badge2" class="badge badge-sm badge-outline hidden">-</span>
            <span id="pf-wr" class="badge badge-sm badge-ghost">WR - üôÇ</span>
          </div>
          <div class="text-xs text-gray-500 mt-1" id="pf-rank-title">-</div>
          <div class="text-sm font-bold text-indigo-600 mt-1" id="pf-mmr">-</div>
        </div>
      </div>

      <div class="mt-3 bg-white border rounded p-3">
        <div class="text-xs text-gray-500 mb-1">Progress</div>
        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
          <div id="pf-prog-bar" class="bg-indigo-500 h-3" style="width:0%"></div>
        </div>
        <div class="text-xs text-gray-500 mt-1 flex justify-between">
          <span id="pf-prog-range">-</span>
          <span id="pf-prog-hint"></span>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-3">
        <div class="bg-white border rounded p-2">
          <div class="text-xs text-gray-400">Sets W/L</div>
          <div class="font-bold" id="pf-sets">0/0</div>
        </div>
        <div class="bg-white border rounded p-2">
          <div class="text-xs text-gray-400">Points +/-</div>
          <div class="font-bold" id="pf-pts">0 / 0</div>
        </div>
      </div>

      <div class="mt-3">
        <div class="font-bold text-gray-600 mb-1">10 Match ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div id="pf-matches" class="space-y-2"></div>
      </div>

      <div class="modal-action">
        <form method="dialog"><button class="btn">‡∏õ‡∏¥‡∏î</button></form>
      </div>
    </div>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="alert alert-info shadow-lg">
      <i class="fa-solid fa-bell"></i>
      <span id="toast-msg">...</span>
    </div>
  </div>

  <script>
    const LIFF_ID = "2009064792-6RT6YKWO";
    let user = null;
    let dashboard = null;
    let currentHistMode = 'my';
    let currentLBMode = 'mmr';
    let selectedCourt = null;
    let audioPrimed = false;
    let lastNotifiedMatch = {}; // {courtId: matchId}

    // --- UI helpers ---
    function switchTab(t) {
      document.querySelectorAll('.tab').forEach(e => e.classList.remove('tab-active'));
      ['live','stats','history','leader','events'].forEach(x => {
        const el = document.getElementById('tab-'+x);
        if (el) el.classList.add('hidden');
      });
      const btn = document.getElementById('tab-btn-'+t);
      const div = document.getElementById('tab-'+t);
      if (btn) btn.classList.add('tab-active');
      if (div) div.classList.remove('hidden');
    }

    function switchHistory(mode){
      currentHistMode = mode;
      document.getElementById('hist-tab-my').classList.toggle('tab-active', mode==='my');
      document.getElementById('hist-tab-global').classList.toggle('tab-active', mode==='global');
      document.getElementById('history-my').classList.toggle('hidden', mode!=='my');
      document.getElementById('history-global').classList.toggle('hidden', mode!=='global');
      renderHistory();
    }

    function switchLB(mode){
      currentLBMode = mode;
      document.getElementById('lb-tab-mmr').classList.toggle('tab-active', mode==='mmr');
      document.getElementById('lb-tab-points').classList.toggle('tab-active', mode==='points');
      document.getElementById('lb-tab-wr').classList.toggle('tab-active', mode==='wr');
      renderLeaderboard();
    }

    function showToast(msg){
      const t = document.getElementById('toast');
      document.getElementById('toast-msg').innerText = msg;
      t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'), 2500);
    }

    function primeAudio(){
      if (audioPrimed) return;
      audioPrimed = true;
      // create a small audio context (works after user gesture)
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.01);
      } catch(e){}
    }

    function beep(){
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'square';
        o.frequency.value = 880;
        g.gain.value = 0.08;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.12);
      } catch(e){}
    }

    function vibrate(){
      try { if (navigator.vibrate) navigator.vibrate([120,80,120]); } catch(e){}
    }

    document.body.addEventListener('touchstart', primeAudio, {once:true});
    document.body.addEventListener('click', primeAudio, {once:true});

    // --- MAIN ---
    async function main() {
      if (location.hostname.includes("localhost")) {
        await apiLogin("U1cf933e3a1559608c50c0456f6583dc9", "Admin Pond", "https://ui-avatars.com/api/?name=Admin");
      } else {
        try {
          await liff.init({liffId: LIFF_ID});
          if (!liff.isLoggedIn()) liff.login();
          const p = await liff.getProfile();
          await apiLogin(p.userId, p.displayName, p.pictureUrl);
        } catch (e) {
          alert("LIFF Error: " + e);
        }
      }
    }

    async function apiLogin(uid, name, pic) {
      const res = await fetch('/api/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:uid, displayName:name, pictureUrl:pic})
      });
      user = await res.json();
      renderUserHeader();
      renderUserStats();
      if (user.role === 'super' || user.role === 'mod') {
        document.getElementById('btn-admin').classList.remove('hidden');
        document.getElementById('staff-controls').classList.remove('hidden');
      }
      if (user.role === 'super') {
        document.getElementById('super-admin-section').classList.remove('hidden');
      }
      setInterval(refresh, 5000);
      await refresh();
      await refreshPairInbox();
      setInterval(refreshPairInbox, 3500);
    }

    function renderUserHeader(){
      document.getElementById('my-img').src = user.pictureUrl || "https://ui-avatars.com/api/?name=User";
      document.getElementById('my-mmr').innerText = user.mmr_display || '...';
      document.getElementById('my-rank-text').innerText = user.rank_title || '';
      // rank badges
      const b = user.rank_badge || {text:'-', cls:'badge-ghost'};
      const b2 = user.rank_badge2;
      const elB = document.getElementById('my-rank-badge');
      const elB2 = document.getElementById('my-rank-badge2');
      elB.innerText = b.text;
      elB.className = `badge badge-xs ${b.cls}`;
      if (b2) {
        elB2.classList.remove('hidden');
        elB2.innerText = b2.text;
        elB2.className = `badge badge-xs ${b2.cls}`;
      } else {
        elB2.classList.add('hidden');
      }
    }

    function renderUserStats(){
      const wr = user.stats?.wr;
      document.getElementById('st-wr').innerText = (wr==null ? 'WR -' : `WR ${wr}%`);
      const setsTotal = (user.stats?.sets_w||0) + (user.stats?.sets_l||0);
      document.getElementById('st-sets').innerText = `${user.stats?.sets_w||0}/${user.stats?.sets_l||0} (${setsTotal})`;
      document.getElementById('st-pts-for').innerText = user.stats?.pts_for || 0;
      document.getElementById('st-pts-against').innerText = user.stats?.pts_against || 0;

      const prog = user.progress || {pct:0, min:'-', max:'-', hint:''};
      document.getElementById('st-progress-bar').style.width = (prog.pct||0) + '%';
      if (prog.mode === 'calibrate') {
        document.getElementById('st-progress-range').innerText = `Calibrate: ${prog.value}/10`;
      } else {
        document.getElementById('st-progress-range').innerText = `${prog.min}‚Äì${prog.max}`;
      }
      document.getElementById('st-progress-hint').innerText = prog.hint || '';
    }

    // --- REFRESH DASHBOARD ---
    async function refresh() {
      const res = await fetch('/api/get_dashboard');
      if (!res.ok) return;
      dashboard = await res.json();

      const sessActive = dashboard.system?.is_session_active;
      const sessAlert = document.getElementById('session-alert');
      const btnCheckin = document.getElementById('btn-checkin');

      if (!sessActive) {
        sessAlert.classList.remove('hidden');
        btnCheckin.disabled = true;
        btnCheckin.innerText = '‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πä‡∏ß‡∏ô...';
        btnCheckin.classList.add('btn-disabled');
        document.getElementById('pair-box').classList.add('hidden');
      } else {
        sessAlert.classList.add('hidden');
        btnCheckin.disabled = false;
        btnCheckin.classList.remove('btn-disabled');
        updateCheckinBtn(user.status);
      }

      // queue
      document.getElementById('q-count').innerText = dashboard.queue_count || 0;
      document.getElementById('q-playing').innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á ${dashboard.playing_count||0}`;
      renderQueue();
      renderCourts();
      renderHistory();
      renderLeaderboard();
      renderEvents();

      // staff auto-courts toggles
      if (user.role === 'super' || user.role === 'mod') {
        renderAutoCourts();
        renderAdminLists();
      }

      // notifications (client-side) for matched players
      maybeNotifyMatch();
    }

    function updateCheckinBtn(status){
      const btn = document.getElementById('btn-checkin');
      const badge = document.getElementById('status-badge');
      if (status === 'active') {
        btn.innerText = "‚ùå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
        btn.className = "btn btn-outline btn-error w-full";
        badge.innerText = "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß";
        badge.className = "badge badge-success text-white";
        document.getElementById('pair-box').classList.remove('hidden');
      } else if (status === 'playing') {
        btn.innerText = "üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô";
        btn.disabled = true;
        btn.className = "btn btn-disabled w-full";
        badge.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô";
        badge.className = "badge badge-warning";
        document.getElementById('pair-box').classList.add('hidden');
      } else {
        btn.innerText = "‚úÖ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°";
        btn.className = "btn btn-primary w-full";
        badge.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤";
        badge.className = "badge badge-ghost";
        document.getElementById('pair-box').classList.add('hidden');
      }
      // rest button state
      const me = (dashboard?.all_players||[]).find(x=>x.id===user.id);
      const restBtn = document.getElementById('btn-rest');
      const arBtn = document.getElementById('btn-auto-rest');
      if (me) {
        restBtn.className = me.resting ? "btn btn-warning btn-sm" : "btn btn-outline btn-sm";
        restBtn.innerText = me.resting ? "‡∏û‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà" : "‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢";
        arBtn.innerText = `Auto Rest: ${me.auto_rest ? 'ON' : 'OFF'}`;
        arBtn.className = me.auto_rest ? "btn btn-success btn-sm text-white" : "btn btn-outline btn-sm";
      }
    }

    function badgeHTML(b, size='xs'){
      if (!b) return '';
      return `<span class="badge badge-${size} ${b.cls}">${b.text}</span>`;
    }

    function renderQueue(){
      const list = document.getElementById('queue-list');
      const q = dashboard.queue || [];
      const all = dashboard.all_players || [];
      list.innerHTML = q.length ? q.map((p, i)=>{
        const restTag = p.resting ? `<span class="badge badge-xs badge-warning ml-2">‡∏û‡∏±‡∏Å</span>` : '';
        const pairTag = p.pair_lock ? `<span class="badge badge-xs badge-secondary ml-2">PAIR</span>` : '';
        return `<tr class="border-b">
          <td class="cursor-pointer" onclick="openProfile('${p.id}')">
            ${i+1}. ${p.nickname}
            <span class="ml-2">${badgeHTML(p.rank_badge,'xs')}</span>
            ${p.rank_badge2 ? `<span class="ml-1">${badgeHTML(p.rank_badge2,'xs')}</span>`:''}
            ${restTag}${pairTag}
            <div class="text-[11px] text-gray-500">‡∏£‡∏≠ ${p.waiting_min||0} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
          </td>
          <td class="text-right">
            <span class="badge badge-ghost badge-xs">${p.rank_title||''}</span>
          </td>
        </tr>`;
      }).join('') : `<tr><td class="p-4 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß</td></tr>`;

      // partner select
      const sel = document.getElementById('partner-select');
      if (sel && document.activeElement !== sel) {
        const cur = sel.value;
        sel.innerHTML = '<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>';
        (dashboard.all_players||[])
          .filter(x => x.id !== user.id && x.status === 'active')  // request only active
          .forEach(x=>{
            const opt = document.createElement('option');
            opt.value = x.id;
            opt.innerText = x.nickname;
            sel.appendChild(opt);
          });
        if (cur) sel.value = cur;
      }
    }

    function renderCourts(){
      const cc = document.getElementById('courts-container');
      cc.innerHTML = '';

      const courts = dashboard.courts || {};
      const isStaff = (user.role==='super' || user.role==='mod');

      Object.keys(courts).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(cid=>{
        const m = courts[cid];
        if (!m) {
          cc.innerHTML += `<div class="p-4 border-2 border-dashed rounded text-center text-gray-400 text-sm">
            Court ${cid} ‡∏ß‡πà‡∏≤‡∏á
            ${isStaff && !dashboard.system.auto_match_courts?.[cid] ? `
              <button class="btn btn-xs btn-neutral mt-2" onclick="matchmakeCourt('${cid}')">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏•‡∏á‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ô‡∏µ‡πâ</button>
            `:''}
          </div>`;
          return;
        }

        const canEnd = isStaff || (m.team_a_ids||[]).includes(user.id) || (m.team_b_ids||[]).includes(user.id);
        const title = m.state === 'countdown' ? `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏•‡∏á (${m.starts_in_sec}s)` : `‡πÅ‡∏Ç‡πà‡∏á ${Math.floor((m.elapsed_sec||0)/60)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        const renderTeam = (teamData) => (teamData||[]).map(pl => {
          return `<div class="flex items-center gap-1 cursor-pointer" onclick="openProfile('${pl.id}')">
            <img src="${pl.pic}" class="w-6 h-6 rounded-full">
            <span class="truncate max-w-[90px] font-medium">${pl.name}</span>
            ${badgeHTML(pl.rank_badge,'xs')}
            ${pl.rank_badge2 ? `<span class="ml-1">${badgeHTML(pl.rank_badge2,'xs')}</span>`:''}
          </div>`;
        }).join('');

        cc.innerHTML += `
          <div class="card bg-white border border-indigo-100 shadow-sm p-3">
            <div class="flex justify-between items-center mb-2">
              <div class="text-indigo-700 font-bold">COURT ${cid}</div>
              <div class="badge badge-outline">${title}</div>
            </div>

            <div class="flex items-start justify-between text-sm">
              <div class="flex flex-col gap-2 w-[45%] items-end text-right">${renderTeam(m.team_a_data)}</div>
              <div class="font-bold text-red-500 self-center">VS</div>
              <div class="flex flex-col gap-2 w-[45%] items-start text-left">${renderTeam(m.team_b_data)}</div>
            </div>

            ${canEnd ? `
              <button class="btn btn-xs btn-error text-white w-full mt-3"
                onclick="openScoreModal('${cid}')">
                ‡∏à‡∏ö‡πÄ‡∏Å‡∏° / ‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏Å‡∏≠‡∏£‡πå
              </button>
            ` : ''}

            ${isStaff ? `
              <button class="btn btn-xs btn-outline w-full mt-2"
                onclick="cancelMatchFromCourt('${cid}')">
                Cancel match (‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
              </button>
            ` : ''}
          </div>`;
      });
    }

    // --- HISTORY RENDER ---
    function formatMatch(m){
      const cfg = dashboard.system?.session_config || {target_points:21, bo:1};
      const bo = cfg.bo || 1;

      const sets = m.sets || [];
      const sumA = (m.meta?.a_pts ?? sets.reduce((acc,s)=>acc+(s.a||0),0));
      const sumB = (m.meta?.b_pts ?? sets.reduce((acc,s)=>acc+(s.b||0),0));
      const aSets = (m.meta?.a_sets ?? sets.filter(s=> (s.a||0)>(s.b||0)).length);
      const bSets = (m.meta?.b_sets ?? sets.length - aSets);
      const durMin = Math.floor((m.duration_sec||0)/60);

      const setStr = sets.map((s,idx)=>`S${idx+1}: ${s.a}-${s.b}`).join(' ‚Ä¢ ');
      return {sumA,sumB,aSets,bSets,durMin,setStr};
    }

    function renderHistory(){
      if (!dashboard) return;
      const hist = dashboard.history || [];

      // MY
      const myDiv = document.getElementById('history-my');
      const my = hist.filter(m => (m.team_a_ids||[]).includes(user.id) || (m.team_b_ids||[]).includes(user.id));
      myDiv.innerHTML = my.length ? my.slice(0,20).map(m=>{
        const mineA = (m.team_a_ids||[]).includes(user.id);
        const myTeam = mineA ? 'A':'B';
        const isWin = m.winner_team === myTeam;

        const info = formatMatch(m);
        const wBadge = isWin ? `<span class="badge badge-success text-white">W</span>` : `<span class="badge badge-error text-white">L</span>`;
        const wrBadge = user.wr_badge ? `<span class="badge badge-sm ${user.wr_badge.cls} ml-2">${user.wr_badge.text}</span>` : '';

        return `
          <div class="bg-white rounded-xl shadow-sm p-3 border cursor-pointer" onclick="openMatchDetail('${m.id}')">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                ${wBadge}
                <div class="text-sm font-bold text-gray-700">Court ${m.court_id} ‚Ä¢ ${m.date}</div>
                ${wrBadge}
              </div>
              <div class="text-xs text-gray-500">${info.durMin} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              <div class="flex justify-between">
                <div><b>A</b> ${m.team_a?.join(' / ')}</div>
                <div>${info.sumA}</div>
              </div>
              <div class="flex justify-between">
                <div><b>B</b> ${m.team_b?.join(' / ')}</div>
                <div>${info.sumB}</div>
              </div>
              <div class="text-[11px] text-gray-400 mt-1">${info.setStr}</div>
            </div>
          </div>`;
      }).join('') : `<div class="text-center text-gray-400 p-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>`;

      // GLOBAL
      const gDiv = document.getElementById('history-global');
      gDiv.innerHTML = hist.length ? hist.slice(0,30).map(m=>{
        const info = formatMatch(m);
        const w = m.winner_team === 'A' ? `<span class="badge badge-success text-white">A WIN</span>` : `<span class="badge badge-info text-white">B WIN</span>`;
        return `
          <div class="bg-white rounded-xl shadow-sm p-3 border cursor-pointer" onclick="openMatchDetail('${m.id}')">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                ${w}
                <div class="text-sm font-bold text-gray-700">Court ${m.court_id} ‚Ä¢ ${m.date}</div>
              </div>
              <div class="text-xs text-gray-500">${info.durMin} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
            </div>
            <div class="text-xs text-gray-600 mt-2">
              <div class="flex justify-between"><div><b>A</b> ${m.team_a?.join(' / ')}</div><div>${info.sumA}</div></div>
              <div class="flex justify-between"><div><b>B</b> ${m.team_b?.join(' / ')}</div><div>${info.sumB}</div></div>
              <div class="text-[11px] text-gray-400 mt-1">${info.setStr}</div>
            </div>
          </div>`;
      }).join('') : `<div class="text-center text-gray-400 p-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
    }

    // quick detail: show profile of any player via modal (match detail uses profiles)
    function openMatchDetail(matchId){
      const m = (dashboard.history||[]).find(x=>x.id===matchId);
      if (!m) return;
      // simple: open score modal in view-only style? We'll just show toast
      showToast(`Match ${matchId} ‚Ä¢ Court ${m.court_id}`);
    }

    // --- LEADERBOARD ---
    function renderLeaderboard(){
      if (!dashboard) return;
      const list = document.getElementById('lb-list');
      const lb = dashboard.leaderboards?.[currentLBMode] || [];

      list.innerHTML = lb.slice(0,80).map((p, idx)=>{
        let right = '';
        if (currentLBMode === 'mmr') right = `<div class="font-mono font-bold text-indigo-600">${p.mmr_display}</div>`;
        if (currentLBMode === 'points') right = `<div class="font-mono font-bold text-indigo-600">${p.pts_for}</div>`;
        if (currentLBMode === 'wr') right = `<div class="font-mono font-bold text-indigo-600">${(p.wr==null?'WR -':`WR ${p.wr}%`)}</div>`;

        return `<tr class="border-b">
          <td class="w-10 text-gray-500 font-bold">${idx+1}</td>
          <td class="cursor-pointer" onclick="openProfile('${p.id}')">
            <div class="flex items-center gap-2">
              <div class="avatar"><div class="w-8 rounded-full"><img src="${p.pictureUrl||'https://ui-avatars.com/api/?name=U'}"></div></div>
              <div class="flex flex-col">
                <div class="flex items-center gap-2">
                  <span class="font-bold">${p.nickname}</span>
                  ${badgeHTML(p.rank_badge,'xs')}
                  ${p.rank_badge2 ? `<span>${badgeHTML(p.rank_badge2,'xs')}</span>`:''}
                </div>
                <span class="text-[10px] text-gray-400">${p.rank_title||''}</span>
              </div>
            </div>
          </td>
          <td class="text-right">${right}</td>
        </tr>`;
      }).join('');
    }

    // --- EVENTS (basic) ---
    function renderEvents(){
      const isStaff = (user.role==='super'||user.role==='mod');
      document.getElementById('evt-create').classList.toggle('hidden', !isStaff);

      const el = document.getElementById('events-list');
      const events = dashboard.events || [];
      const cur = dashboard.system?.current_event_id;

      el.innerHTML = events.slice(0,10).map(e=>{
        const isCur = (e.id === cur);
        const dt = new Date((e.datetime||0)*1000);
        const dtStr = dt.toLocaleString('th-TH', {day:'2-digit', month:'short', year:'2-digit', hour:'2-digit', minute:'2-digit'});
        const pcount = (e.participants||[]).length;
        return `
          <div class="bg-white rounded-xl shadow-sm p-3 border">
            <div class="flex justify-between items-center">
              <div class="font-bold text-gray-700">${e.name} ${isCur?'<span class="badge badge-success badge-xs ml-2">CURRENT</span>':''}</div>
              <div class="text-xs text-gray-500">${dtStr}</div>
            </div>
            <div class="text-xs text-gray-500 mt-1">‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡πä‡∏ß‡∏ô: <b>${pcount}</b></div>
          </div>`;
      }).join('') || `<div class="text-center text-gray-400 p-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Event</div>`;
    }

    async function submitNewEvent(){
      alert("‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ session ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° create event ‡∏ï‡πà‡∏≠ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î)");
    }

    // --- PROFILE ---
    async function openProfile(uid){
      const res = await fetch(`/api/player/profile?targetId=${encodeURIComponent(uid)}`);
      const p = await res.json();
      if (p.error) return alert(p.error);

      document.getElementById('pf-img').src = p.pictureUrl || 'https://ui-avatars.com/api/?name=U';
      document.getElementById('pf-name').innerText = p.nickname;
      document.getElementById('pf-rank-title').innerText = p.rank_title;
      document.getElementById('pf-mmr').innerText = p.mmr_display;

      const b = p.rank_badge || {text:'-', cls:'badge-ghost'};
      const b2 = p.rank_badge2;

      const elB = document.getElementById('pf-badge');
      elB.innerText = b.text;
      elB.className = `badge badge-sm ${b.cls}`;

      const elB2 = document.getElementById('pf-badge2');
      if (b2) {
        elB2.classList.remove('hidden');
        elB2.innerText = b2.text;
        elB2.className = `badge badge-sm ${b2.cls}`;
      } else {
        elB2.classList.add('hidden');
      }

      const wrb = p.wr_badge || {text:'WR - üôÇ', cls:'badge-ghost'};
      const elWR = document.getElementById('pf-wr');
      elWR.innerText = wrb.text;
      elWR.className = `badge badge-sm ${wrb.cls}`;

      const prog = p.progress || {pct:0, min:'-', max:'-', hint:''};
      document.getElementById('pf-prog-bar').style.width = (prog.pct||0) + '%';
      document.getElementById('pf-prog-range').innerText = (prog.mode==='calibrate') ? `UNRANK ${prog.value}/10` : `${prog.min}‚Äì${prog.max}`;
      document.getElementById('pf-prog-hint').innerText = prog.hint || '';

      document.getElementById('pf-sets').innerText = `${p.stats?.sets_w||0}/${p.stats?.sets_l||0}`;
      document.getElementById('pf-pts').innerText = `${p.stats?.pts_for||0} / ${p.stats?.pts_against||0}`;

      const matches = p.last_matches || [];
      document.getElementById('pf-matches').innerHTML = matches.length ? matches.map(m=>{
        const info = formatMatch(m);
        const mineA = (m.team_a_ids||[]).includes(uid);
        const myTeam = mineA ? 'A':'B';
        const isWin = (m.winner_team === myTeam);
        const wl = isWin ? `<span class="badge badge-success badge-xs text-white">W</span>` : `<span class="badge badge-error badge-xs text-white">L</span>`;

        // rank badges snapshot for each player (4 people)
        const renderSide = (ids, names, side) => {
          return (ids||[]).map((pid, i)=>{
            const snap = m.rank_snapshot?.[pid];
            const b = snap?.rank_badge;
            const b2 = snap?.rank_badge2;
            const nm = (names||[])[i] || 'Player';
            return `<div class="flex items-center gap-1">
              <span class="truncate max-w-[120px]">${nm}</span>
              ${b ? badgeHTML(b,'xs'):''}
              ${b2 ? `<span>${badgeHTML(b2,'xs')}</span>`:''}
            </div>`;
          }).join('');
        };

        return `
          <div class="bg-white border rounded p-2">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                ${wl}
                <div class="text-xs font-bold text-gray-700">Court ${m.court_id} ‚Ä¢ ${m.date}</div>
              </div>
              <div class="text-[11px] text-gray-500">${Math.floor((m.duration_sec||0)/60)} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
            </div>
            <div class="text-[11px] text-gray-600 mt-1">
              <div class="flex justify-between"><div><b>A</b></div><div>${info.sumA}</div></div>
              <div class="pl-2">${renderSide(m.team_a_ids, m.team_a, 'A')}</div>
              <div class="flex justify-between mt-1"><div><b>B</b></div><div>${info.sumB}</div></div>
              <div class="pl-2">${renderSide(m.team_b_ids, m.team_b, 'B')}</div>
              <div class="text-[10px] text-gray-400 mt-1">${info.setStr}</div>
            </div>
          </div>`;
      }).join('') : `<div class="text-center text-gray-400 p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏°‡∏ï‡∏ä‡πå</div>`;

      document.getElementById('modal_profile').showModal();
    }

    // --- SCORE MODAL ---
    function renderScoreInputs(bo){
      const container = document.getElementById('set-inputs');
      container.innerHTML = '';
      for (let i=1;i<=bo;i++){
        container.innerHTML += `
          <div class="bg-white border rounded p-2">
            <div class="text-xs font-bold text-gray-600 mb-1">Set ${i}</div>
            <div class="grid grid-cols-2 gap-2">
              <input id="setA-${i}" type="number" class="input input-bordered input-sm w-full" placeholder="A">
              <input id="setB-${i}" type="number" class="input input-bordered input-sm w-full" placeholder="B">
            </div>
            <div class="text-[11px] text-gray-400 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏î‡∏¥‡∏ß‡∏™‡πå‡∏ñ‡∏∂‡∏á 30 (‡πÄ‡∏ä‡πà‡∏ô 30-29)</div>
          </div>`;
      }
    }

    function openScoreModal(cid){
      selectedCourt = cid;
      const m = dashboard.courts?.[cid];
      if (!m) return;

      document.getElementById('score-court').innerText = cid;
      document.getElementById('teamA-names').innerText = (m.team_a||[]).join(" / ");
      document.getElementById('teamB-names').innerText = (m.team_b||[]).join(" / ");

      if (m.state === "countdown") {
        document.getElementById("match-timer-hint").innerText = `‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${m.starts_in_sec}s)`;
      } else {
        const min = Math.floor((m.elapsed_sec||0)/60);
        document.getElementById("match-timer-hint").innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ~ ${min} ‡∏ô‡∏≤‡∏ó‡∏µ`;
      }

      const cfg = dashboard.system?.session_config || { target_points: 21, bo: 1 };
      renderScoreInputs(cfg.bo || 1);

      document.getElementById('modal_score').showModal();
    }

    async function submitScore(){
      if (!selectedCourt) return;

      const cfg = dashboard.system?.session_config || {target_points:21, bo:1};
      const bo = cfg.bo || 1;

      const sets = [];
      for (let i=1;i<=bo;i++){
        const a = document.getElementById(`setA-${i}`).value;
        const b = document.getElementById(`setB-${i}`).value;
        if (a==='' || b==='') return alert(`‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Set ${i} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö`);
        sets.push({a: parseInt(a,10), b: parseInt(b,10)});
      }

      const res = await fetch('/api/submit_result', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId:selectedCourt, sets})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);

      document.getElementById('modal_score').close();
      showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß');
      // refresh user (mmr may change but unrank hides)
      await apiLogin(user.id, user.nickname, user.pictureUrl);
      await refresh();
    }

    async function cancelMatch(){
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Cancel match? (‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)')) return;
      const res = await fetch('/api/match/cancel', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId:selectedCourt})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      document.getElementById('modal_score').close();
      showToast('Cancel match ‡πÅ‡∏•‡πâ‡∏ß');
      await refresh();
    }

    async function cancelMatchFromCourt(cid){
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Cancel match ‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ô‡∏µ‡πâ?')) return;
      const res = await fetch('/api/match/cancel', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId:cid})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      showToast('Cancel match ‡πÅ‡∏•‡πâ‡∏ß');
      await refresh();
    }

    // --- MATCHMAKE CONTROLS ---
    async function runMatchmakeNonAuto(){
      const res = await fetch('/api/matchmake/run', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      showToast('‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß');
      await refresh();
    }

    async function matchmakeCourt(cid){
      const res = await fetch('/api/matchmake/court', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId:cid})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      if (!r.ok) return alert(r.reason || '‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      showToast(`‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏•‡∏á Court ${cid} ‡πÅ‡∏•‡πâ‡∏ß`);
      await refresh();
    }

    // --- AUTO COURTS TOGGLES ---
    function renderAutoCourts(){
      const wrap = document.getElementById('auto-courts');
      wrap.innerHTML = '';
      const total = dashboard.system?.total_courts || 2;
      for (let i=1;i<=total;i++){
        const cid = String(i);
        const on = !!dashboard.system.auto_match_courts?.[cid];
        wrap.innerHTML += `
          <button class="btn btn-sm ${on?'btn-success text-white':'btn-outline'}"
            onclick="toggleAutoCourt('${cid}', ${!on})">
            Court ${cid}: ${on?'ON':'OFF'}
          </button>`;
      }
    }

    async function toggleAutoCourt(cid, enabled){
      const res = await fetch('/api/admin/toggle_auto_match', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId:cid, enabled})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      await refresh();
    }

    // --- STATUS / REST / AUTOREST ---
    async function toggleStatusConfirm(){
      if (!dashboard?.system?.is_session_active) return alert('‡∏£‡∏≠ Mod ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πä‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
      if (user.status === 'active' || user.status === 'playing'){
        const ok = confirm('‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å? (‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å reset)');
        if (!ok) return;
      } else {
        const ok = confirm('‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°?');
        if (!ok) return;
      }
      const res = await fetch('/api/toggle_status', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      await apiLogin(user.id, user.nickname, user.pictureUrl);
      await refresh();
    }

    async function toggleRest(){
      const res = await fetch('/api/rest_toggle', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      await refresh();
    }

    async function toggleAutoRest(){
      const res = await fetch('/api/auto_rest_toggle', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      await refresh();
    }

    // --- PAIR UI ---
    async function refreshPairInbox(){
      if (!user) return;
      const res = await fetch('/api/pair/inbox', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      const r = await res.json();
      if (r.error) return;

      // update local user pair states
      user.outgoing_request_to = r.outgoing_request_to;
      user.pair_lock = r.pair_lock;

      const me = (dashboard?.all_players||[]).find(x=>x.id===user.id);
      const canUsePair = (user.status === 'active');
      document.getElementById('pair-box').classList.toggle('hidden', !canUsePair);

      const locked = document.getElementById('pair-locked');
      const outgoing = document.getElementById('pair-outgoing');
      const form = document.getElementById('pair-form');

      // paired
      if (user.pair_lock){
        const partner = (dashboard?.all_players||[]).find(x=>x.id===user.pair_lock);
        document.getElementById('pair-locked-name').innerText = partner ? partner.nickname : user.pair_lock;
        locked.classList.remove('hidden');
        outgoing.classList.add('hidden');
        form.classList.add('hidden');
      } else {
        locked.classList.add('hidden');
        // outgoing
        if (user.outgoing_request_to){
          const t = (dashboard?.all_players||[]).find(x=>x.id===user.outgoing_request_to);
          document.getElementById('pair-outgoing-name').innerText = t ? t.nickname : user.outgoing_request_to;
          outgoing.classList.remove('hidden');
          form.classList.add('hidden');
        } else {
          outgoing.classList.add('hidden');
          form.classList.remove('hidden');
        }
      }

      // inbox list
      const inbox = r.inbox || [];
      const box = document.getElementById('pair-inbox');
      if (!inbox.length){
        box.innerHTML = `<div class="text-xs text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>`;
      } else {
        box.innerHTML = inbox.map(req=>{
          const disabled = !!user.pair_lock; // already paired -> cannot accept
          const btn = disabled ? `<button class="btn btn-xs btn-disabled">‡∏£‡∏±‡∏ö</button>`
                               : `<button class="btn btn-xs btn-success text-white" onclick="acceptPair('${req.id}')">‡∏£‡∏±‡∏ö</button>`;
          return `
            <div class="flex justify-between items-center bg-white border rounded p-2">
              <div class="flex items-center gap-2 cursor-pointer" onclick="openProfile('${req.id}')">
                <img src="${req.pictureUrl||'https://ui-avatars.com/api/?name=U'}" class="w-8 h-8 rounded-full">
                <div>
                  <div class="text-sm font-bold">${req.nickname}
                    ${badgeHTML(req.rank_badge,'xs')}
                    ${req.rank_badge2 ? `<span class="ml-1">${badgeHTML(req.rank_badge2,'xs')}</span>`:''}
                  </div>
                  <div class="text-[11px] text-gray-500">${req.status}</div>
                </div>
              </div>
              ${btn}
            </div>`;
        }).join('');

        // notify on new incoming requests
        const key = 'pairInboxCount';
        const prev = parseInt(localStorage.getItem(key)||'0',10);
        if (inbox.length > prev){
          showToast('‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡∏°‡πà!');
          if (dashboard?.system?.session_config?.enable_notifications){
            vibrate(); beep();
          }
        }
        localStorage.setItem(key, String(inbox.length));
      }
    }

    async function sendPairRequest(){
      const targetId = document.getElementById('partner-select').value;
      if (!targetId) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
      const res = await fetch('/api/pair/request', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, targetId})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      showToast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
      await refreshPairInbox();
    }

    async function cancelOutgoing(){
      const res = await fetch('/api/pair/cancel_outgoing', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
      await refreshPairInbox();
    }

    async function acceptPair(fromId){
      if (!confirm('‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà?')) return;
      const res = await fetch('/api/pair/accept', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, fromId})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      showToast('‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      await refreshPairInbox();
      await refresh();
    }

    async function cancelPair(){
      if (!confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏π‡πà?')) return;
      const res = await fetch('/api/pair/cancel_pair', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
      await refreshPairInbox();
      await refresh();
    }

    // --- MATCH NOTIFICATIONS ---
    function maybeNotifyMatch(){
      const cfg = dashboard.system?.session_config || {};
      if (!cfg.enable_notifications) return;

      const courts = dashboard.courts || {};
      Object.keys(courts).forEach(cid=>{
        const m = courts[cid];
        if (!m) return;
        const inMatch = (m.team_a_ids||[]).includes(user.id) || (m.team_b_ids||[]).includes(user.id);
        if (!inMatch) return;

        const mid = m.match_id;
        if (!mid) return;

        const prev = lastNotifiedMatch[cid] || localStorage.getItem(`lastMatch_${cid}`) || null;
        if (prev === mid) return;

        // new match for me
        lastNotifiedMatch[cid] = mid;
        localStorage.setItem(`lastMatch_${cid}`, mid);

        const a = (m.team_a||[]).join(' / ');
        const b = (m.team_b||[]).join(' / ');
        showToast(`‡∏•‡∏á Court ${cid}: A(${a}) vs B(${b})`);
        vibrate();
        beep();
      });
    }

    // --- ADMIN ---
    function openAdmin(){
      document.getElementById('modal_admin').showModal();
    }

    function renderAdminLists(){
      // courts list for manual modal
      const total = dashboard.system?.total_courts || 2;
      const mc = document.getElementById('man-court');
      mc.innerHTML = '';
      for (let i=1;i<=total;i++){
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.innerText = `Court ${i}`;
        mc.appendChild(opt);
      }

      // mmr edit select
      const mmrSel = document.getElementById('mmr-user');
      mmrSel.innerHTML = '';
      (dashboard.all_players||[]).forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.innerText = `${p.nickname} (${p.mmr_display})`;
        mmrSel.appendChild(opt);
      });

      // super manage mods
      if (user.role === 'super'){
        document.getElementById('admin-user-list').innerHTML = (dashboard.all_players||[]).map(p=>{
          return `<tr>
            <td>${p.nickname}</td>
            <td class="text-right">
              <input type="checkbox" class="toggle toggle-xs toggle-success" ${p.is_mod?'checked':''}
                onchange="toggleMod('${p.id}', this.checked)">
            </td>
          </tr>`;
        }).join('');
      }
    }

    async function toggleSession(action){
      if (action==='end' && !confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô?')) return;

      const payload = {userId:user.id, action};
      if (action==='start'){
        payload.target_points = parseInt(document.getElementById('cfg-points').value,10);
        payload.bo = parseInt(document.getElementById('cfg-bo').value,10);
        payload.enable_notifications = document.getElementById('cfg-notify').checked;
      }

      const res = await fetch('/api/admin/toggle_session', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Session ‡πÅ‡∏•‡πâ‡∏ß');
      document.getElementById('modal_admin').close();
      await refresh();
    }

    async function toggleMod(tid, val){
      const res = await fetch('/api/admin/manage_mod', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({requesterId:user.id, targetUserId:tid, action: val?'promote':'demote'})
      });
      const r = await res.json();
      if (r.error) alert(r.error);
    }

    async function saveMMR(){
      const tid = document.getElementById('mmr-user').value;
      const v = document.getElementById('mmr-value').value;
      if (!tid || v==='') return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å MMR');
      const res = await fetch('/api/admin/set_mmr', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, targetUserId:tid, newMmr: v})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç MMR ‡πÅ‡∏•‡πâ‡∏ß');
      await refresh();
    }

    // --- MANUAL MATCH ---
    function openManualMatch(){
      // populate player selects with active only
      const actives = (dashboard.all_players||[]).filter(p => p.status==='active' && !p.resting);
      document.querySelectorAll('.player-select').forEach(s=>{
        s.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
        actives.forEach(p=>{
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.innerText = p.nickname;
          s.appendChild(opt);
        });
      });
      document.getElementById('modal_manual_match').showModal();
    }

    async function submitManualMatch(){
      const courtId = document.getElementById('man-court').value;
      const p1 = document.getElementById('man-p1').value;
      const p2 = document.getElementById('man-p2').value;
      const p3 = document.getElementById('man-p3').value;
      const p4 = document.getElementById('man-p4').value;
      if(!p1||!p2||!p3||!p4) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
      if(new Set([p1,p2,p3,p4]).size !== 4) return alert('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');

      const res = await fetch('/api/matchmake/manual', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({userId:user.id, courtId, playerIds:[p1,p2,p3,p4]})
      });
      const r = await res.json();
      if (r.error) return alert(r.error);
      document.getElementById('modal_manual_match').close();
      showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÅ‡∏•‡πâ‡∏ß');
      await refresh();
    }

    // --- init ---
    main();
  </script>
</body>
</html>
