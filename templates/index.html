<script>
    const LIFF_ID = "2009064792-6RT6YKWO";
    let user = null; let isSessionActive = false; let globalEvents = []; let globalAllPlayers = [];

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('tab-active'));
        ['live','stats','history','rank','events'].forEach(x => {
            const el = document.getElementById('tab-'+x);
            if(el) el.classList.add('hidden');
        });
        const targetBtn = document.getElementById('tab-btn-' + t);
        const targetDiv = document.getElementById('tab-' + t);
        if (targetBtn) targetBtn.classList.add('tab-active');
        if (targetDiv) targetDiv.classList.remove('hidden');
    }

    async function main() {
        if (location.hostname.includes("localhost")) {
            await apiLogin("U1cf933e3a1559608c50c0456f6583dc9", "Admin Pond", "https://ui-avatars.com/api/?name=A");
        } else {
            try {
                await liff.init({liffId: LIFF_ID});
                if(!liff.isLoggedIn()) liff.login();
                else {
                    const p = await liff.getProfile();
                    await apiLogin(p.userId, p.displayName, p.pictureUrl);
                }
            } catch(e) {
                alert("LIFF Error: " + e);
            }
        }
    }

    async function apiLogin(uid, name, pic) {
        try {
            const res = await fetch('/api/login', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({userId:uid, displayName:name, pictureUrl:pic})
            });
            if(!res.ok) throw new Error("Login failed");
            user = await res.json();
            renderUI();
            refresh();
            setInterval(refresh, 5000);
        } catch(e) {
            console.error("Login Error:", e);
        }
    }

    function renderUI() {
        if(!user) return;
        document.getElementById('my-img').src = user.pictureUrl;
        document.getElementById('my-mmr').innerText = user.mmr;
        document.getElementById('my-rank-text').innerText = user.rank_title;

        if(user.stats) {
            document.getElementById('st-wr').innerText = user.stats.win_rate + "%";
            document.getElementById('st-total').innerText = user.stats.total;
            document.getElementById('st-streak').innerText = user.stats.streak;
            document.getElementById('st-partner').innerText = user.stats.best_partner;
            document.getElementById('st-nemesis').innerText = user.stats.nemesis;
        }

        const hList = document.getElementById('history-list');
        if (hList && user.my_history) {
            hList.innerHTML = user.my_history.length > 0 ? user.my_history.map(m => {
                const myTeam = m.team_a_ids.includes(user.id) ? 'A' : 'B';
                const isWin = m.winner_team === myTeam;
                let change = isWin ? "+25" : "-20";
                if(m.mmr_snapshot && m.mmr_snapshot[user.id]) change = m.mmr_snapshot[user.id].change;
                return `<tr><td>${isWin ? '<span class="badge badge-success text-white">W</span>' : '<span class="badge badge-error text-white">L</span>'}</td><td class="text-xs"><div>${m.date.split(' ')[1]}</div></td><td class="text-right font-bold ${isWin?'text-green-600':'text-red-500'}">${change}</td></tr>`;
            }).join('') : `<tr><td colspan="3" class="text-center p-4 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>`;
        }

        const isStaff = (user.role === 'super' || user.role === 'mod');
        if(isStaff) {
            document.getElementById('btn-admin').classList.remove('hidden');
            document.querySelectorAll('.staff-only').forEach(e=>e.classList.remove('hidden'));
            document.getElementById('staff-controls').classList.remove('hidden');
            document.getElementById('btn-bill').classList.remove('hidden');
            document.getElementById('mod-court-control').classList.remove('hidden');
        }
        if(user.role === 'super') document.getElementById('super-admin-section').classList.remove('hidden');
    }

    async function refresh() {
        try {
            const res = await fetch('/api/get_dashboard');
            if(!res.ok) return;
            const d = await res.json();

            globalEvents = d.events || [];
            globalAllPlayers = d.all_players || [];
            isSessionActive = d.system.is_session_active;

            const sessAlert = document.getElementById('session-alert');
            const btnCheckin = document.getElementById('btn-checkin');
            const reqBox = document.getElementById('partner-req-box');

            if(!isSessionActive) {
                if(sessAlert) sessAlert.classList.remove('hidden');
                if(btnCheckin) { btnCheckin.disabled = true; btnCheckin.innerText = "‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πä‡∏ß‡∏ô..."; btnCheckin.classList.add('btn-disabled'); }
                if(reqBox) reqBox.classList.add('hidden');
            } else {
                if(sessAlert) sessAlert.classList.add('hidden');
                if(btnCheckin) btnCheckin.classList.remove('btn-disabled');
                updateCheckinBtn(user.status);
            }

            document.getElementById('court-count-display').innerText = Object.keys(d.courts).length;
            const cc = document.getElementById('courts-container'); cc.innerHTML = '';
            const isStaff = (user.role === 'super' || user.role === 'mod');

            for(const [cid, m] of Object.entries(d.courts)) {
                if(m) {
                    const min = Math.floor(m.elapsed/60);
                    const renderTeam = (teamData) => teamData.map(p => `<div class="flex items-center gap-1"><img src="${p.pic}" class="w-5 h-5 rounded-full"><span class="truncate max-w-[80px]">${p.name}</span></div>`).join('');
                    const canEnd = isStaff || m.team_a_ids.includes(user.id) || m.team_b_ids.includes(user.id);
                    cc.innerHTML += `<div class="card bg-white border border-indigo-100 shadow-sm p-3"><div class="flex justify-between text-indigo-700 font-bold mb-2"><span>COURT ${cid}</span><span class="badge badge-outline">${min} min</span></div><div class="flex items-start justify-between text-sm"><div class="flex flex-col gap-1 w-[45%] items-end text-right font-medium">${renderTeam(m.team_a_data)}</div><div class="font-bold text-red-500 self-center">VS</div><div class="flex flex-col gap-1 w-[45%] items-start text-left font-medium">${renderTeam(m.team_b_data)}</div></div>${canEnd ? `<button onclick="selectedCid=${cid};document.getElementById('modal_finish').showModal();document.getElementById('fin-cid').innerText=${cid}" class="btn btn-xs btn-error text-white w-full mt-2">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>` : ''}</div>`;
                } else {
                    cc.innerHTML += `<div class="p-4 border-2 border-dashed rounded text-center text-gray-400 text-sm">Court ${cid} ‡∏ß‡πà‡∏≤‡∏á</div>`;
                }
            }

            if(user.role === 'super' && d.all_players) {
                document.getElementById('admin-user-list').innerHTML = d.all_players.map(p =>
                    `<tr><td>${p.nickname}</td><td class="text-right"><input type="checkbox" class="toggle toggle-xs toggle-success" ${p.is_mod?'checked':''} onchange="toggleMod('${p.id}',this.checked)"></td></tr>`
                ).join('');
            }

            document.getElementById('q-count').innerText = d.queue_count;
            document.getElementById('queue-list').innerHTML = d.queue.map((p,i) => {
                let reqHtml = '';
                if(p.partner_req) {
                    const target = d.all_players.find(x => x.id === p.partner_req);
                    if(target) reqHtml = `<span class="badge badge-xs badge-outline ml-1 text-indigo-500 gap-1"><i class="fa-solid fa-link"></i> ‡∏Ñ‡∏π‡πà ${target.nickname}</span>`;
                }
                return `<tr class="border-b"><td>${i+1}. ${p.nickname} ${reqHtml}</td><td class="text-right"><span class="badge badge-ghost badge-xs">${p.rank_title}</span></td></tr>`;
            }).join('');

            if (d.leaderboard) {
                document.getElementById('lb-list').innerHTML = d.leaderboard.map((p,i) => {
                    const editBtn = isStaff ? `<button onclick="openEditMMR('${p.id}')" class="btn btn-xs btn-ghost text-gray-400"><i class="fa-solid fa-pen"></i></button>` : '';
                    return `<tr><td class="font-bold text-gray-500">${i+1}</td><td><div class="flex flex-col"><div class="flex items-center gap-2"><div class="avatar"><div class="w-6 rounded-full"><img src="${p.pictureUrl}"></div></div><span class="text-sm font-bold">${p.nickname}</span></div><span class="text-[10px] text-gray-400 ml-8">${p.rank_title}</span></div></td><td class="text-right"><div class="font-mono font-bold text-indigo-600">${p.mmr}</div>${editBtn}</td></tr>`;
                }).join('');
            }

            const pSelect = document.getElementById('partner-select');
            if(pSelect && document.activeElement !== pSelect) {
                const currentVal = pSelect.value;
                pSelect.innerHTML = '<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>';
                d.all_players.forEach(p => {
                    if(p.id !== user.id && p.status === 'active') {
                        const opt = document.createElement('option');
                        opt.value = p.id; opt.innerText = p.nickname;
                        pSelect.appendChild(opt);
                    }
                });
                if(currentVal) pSelect.value = currentVal;
            }

            document.querySelectorAll('.player-select').forEach(s => {
                if(document.activeElement !== s && s.children.length <= 1) {
                    s.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
                    d.all_players.filter(p=>p.status==='active').forEach(p => {
                        const opt = document.createElement('option');
                        opt.value=p.id; opt.innerText=p.nickname; s.appendChild(opt);
                    });
                }
            });

            // ‚úÖ‚úÖ NEW: RENDER EVENTS (‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")
            const eventsEl = document.getElementById('events-list');
            if (eventsEl) {
                if (!globalEvents || globalEvents.length === 0) {
                    eventsEl.innerHTML = `<div class="text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Events</div>`;
                } else {
                    eventsEl.innerHTML = globalEvents.map(e => {
                        const joinedCount = (e.joined_users || []).length;
                        const joinedMe = (e.players || []).includes(user.id);

                        return `
                            <div class="card bg-white shadow-sm border p-3">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-bold text-gray-800">${e.name}</div>
                                        <div class="text-xs text-gray-500">${formatDate(e.datetime)}</div>
                                        <div class="text-xs text-gray-500 mt-1">üë• ${joinedCount} ‡∏Ñ‡∏ô</div>
                                    </div>
                                    ${isStaff ? `<button class="btn btn-xs btn-ghost text-red-500" onclick="deleteEvent('${e.id}')">‡∏•‡∏ö</button>` : ``}
                                </div>

                                <div class="flex flex-wrap gap-2 mt-2">
                                    ${(e.joined_users || []).map(u => `
                                        <span class="badge badge-outline">
                                            <img src="${u.pictureUrl || ''}" class="w-4 h-4 rounded-full mr-1">${u.nickname}
                                        </span>
                                    `).join('')}
                                </div>

                                <button class="btn btn-sm w-full mt-3 ${joinedMe ? 'btn-outline btn-error' : 'btn-primary'}"
                                        onclick="toggleEventJoin('${e.id}')">
                                    ${joinedMe ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°'}
                                </button>
                            </div>
                        `;
                    }).join('');
                }
            }

        } catch(e) {
            console.error("Refresh Error:", e);
        }
    }

    function updateCheckinBtn(status) {
        const btn = document.getElementById('btn-checkin');
        const badge = document.getElementById('status-badge');
        const reqBox = document.getElementById('partner-req-box');
        const reqForm = document.getElementById('req-form');
        const reqActive = document.getElementById('req-active');

        if(!btn) return;
        btn.disabled = false;

        if (status === 'active') {
            btn.innerText = "‚ùå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
            btn.className = "btn btn-outline btn-error w-full";
            badge.innerText = "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß";
            badge.className = "badge badge-success text-white";

            if(reqBox) {
                reqBox.classList.remove('hidden');
                if(user.partner_req) {
                    reqForm.classList.add('hidden'); reqActive.classList.remove('hidden');
                    const target = globalAllPlayers.find(p => p.id === user.partner_req);
                    document.getElementById('req-target-name').innerText = target ? target.nickname : '...';
                } else {
                    reqForm.classList.remove('hidden'); reqActive.classList.add('hidden');
                }
            }
        } else if (status === 'playing') {
            btn.innerText = "üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô";
            btn.disabled = true;
            btn.className = "btn btn-disabled w-full";
            badge.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô";
            badge.className = "badge badge-warning";
            if(reqBox) reqBox.classList.add('hidden');
        } else {
            btn.innerText = "‚úÖ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°";
            btn.className = "btn btn-primary w-full";
            badge.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤";
            badge.className = "badge badge-ghost";
            if(reqBox) reqBox.classList.add('hidden');
        }
    }

    async function requestPartner() {
        const targetId = document.getElementById('partner-select').value;
        if(!targetId) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        const res = await fetch('/api/request_partner', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id, targetId:targetId})});
        const r = await res.json();
        if(r.error) alert(r.error);
        else { await apiLogin(user.id, user.nickname, user.pictureUrl); }
    }

    async function cancelRequest() {
        if(!confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠?')) return;
        await fetch('/api/cancel_request', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id})});
        await apiLogin(user.id, user.nickname, user.pictureUrl);
    }

    async function resetSystem() {
        if(!confirm('‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
        if(!confirm('‚õîÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢!')) return;
        try {
            await fetch('/api/admin/reset_system', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: user.id})});
            alert('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
            location.reload();
        } catch(e) { alert('Error: ' + e); }
    }

    async function toggleSession(action) {
        if(action==='end' && !confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô?')) return;
        await fetch('/api/admin/toggle_session', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:action, userId:user.id})});
        location.reload();
    }

    async function changeCourtCount(delta) {
        const current = parseInt(document.getElementById('court-count-display').innerText);
        await fetch('/api/admin/update_courts', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({count:current+delta})});
        refresh();
    }

    async function toggleMod(tid, val) {
        await fetch('/api/admin/manage_mod', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({requesterId:user.id, targetUserId:tid, action:val?'promote':'demote'})});
    }

    async function submitRes(w) {
        const r = await (await fetch('/api/submit_result', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({courtId:selectedCid, winner:w, userId:user.id})})).json();
        if(r.error) alert(r.error);
        document.getElementById('modal_finish').close();
        refresh();
    }

    async function toggleStatus() {
        await fetch('/api/toggle_status', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id})});
        apiLogin(user.id, user.nickname, user.pictureUrl);
    }

    async function matchmake() {
        const r = await (await fetch('/api/matchmake',{method:'POST'})).json();
        if(r.status!=='matched') alert(r.status==='full'?'‡πÄ‡∏ï‡πá‡∏°':'‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠');
        else refresh();
    }

    // ‚úÖ‚úÖ NEW: submitNewEvent ‡πÄ‡∏ä‡πá‡∏Ñ error ‡∏ä‡∏±‡∏î‡πÜ
    async function submitNewEvent() {
        const n = document.getElementById('evt-name').value.trim();
        const t = document.getElementById('evt-time').value;
        if(!n || !t) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö");

        const timestamp = Math.floor(new Date(t).getTime() / 1000);

        const res = await fetch('/api/event/create', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({name:n, datetime:timestamp})
        });

        const data = await res.json().catch(()=>({}));
        if (!res.ok || data.error) {
            console.error("Create event failed:", res.status, data);
            return alert(data.error || `‡∏™‡∏£‡πâ‡∏≤‡∏á Event ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${res.status})`);
        }

        document.getElementById('evt-name').value='';
        document.getElementById('evt-time').value='';
        await refresh();
        switchTab('events');
    }

    async function deleteEvent(eid) {
        if(confirm('‡∏•‡∏ö‡∏ô‡∏∞?')) {
            await fetch('/api/event/delete', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId:eid})});
            refresh();
        }
    }

    async function toggleEventJoin(eid) {
        await fetch('/api/event/join_toggle', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId:eid, userId:user.id})});
        refresh();
    }

    // ‚úÖ NEW: Open Edit MMR by ID Lookup
    let editTargetId = null;
    function openEditMMR(uid) {
        const player = globalAllPlayers.find(p => p.id === uid);
        if (!player) return;
        editTargetId = uid;
        document.getElementById('edit-target-name').innerText = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á: ${player.nickname}`;
        document.getElementById('edit-new-mmr').value = player.mmr || 1000;
        document.getElementById('modal_edit_mmr').showModal();
    }

    async function saveMMR() {
        const v = document.getElementById('edit-new-mmr').value;
        if(!v) return;
        await fetch('/api/admin/set_mmr', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({targetUserId:editTargetId, newMmr:v})});
        document.getElementById('modal_edit_mmr').close();
        refresh();
    }

    function formatDate(dt) {
        const dateObj = typeof dt === 'number' ? new Date(dt * 1000) : new Date(dt);
        return dateObj.toLocaleDateString('th-TH', {weekday:'short', day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
    }

    // ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á billing/manual match ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ
    // (‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö flow ‡∏≠‡∏∑‡πà‡∏ô)

    main();
</script>
