<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Arena</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>var vConsole = new VConsole();</script>
</head>
<body class="bg-gray-100 min-h-screen pb-24">

    <div class="navbar bg-white shadow-sm px-4 sticky top-0 z-50">
        <div class="flex-1">
            <span class="text-xl font-bold text-blue-600">üè∏ GANG BAD</span>
        </div>
        <div class="flex-none gap-2">
            <div class="text-right mr-2">
                <div id="user-role-badge"></div>
                <div class="badge badge-neutral badge-sm font-bold" id="user-rank-title">...</div>
            </div>
            <div onclick="editProfileModal()" class="avatar cursor-pointer">
                <div class="w-10 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                    <img id="user-img" src="https://ui-avatars.com/api/?name=U" />
                </div>
            </div>
        </div>
    </div>

    <div class="flex justify-center mt-2 px-2 overflow-x-auto">
        <div role="tablist" class="tabs tabs-boxed w-full font-bold text-xs sm:text-sm">
            <a role="tab" class="tab tab-active" onclick="switchTab('live', this)">‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏Ç‡πà‡∏á</a>
            <a role="tab" class="tab" onclick="switchTab('upcoming', this)">Upcoming</a>
            <a role="tab" class="tab" onclick="switchTab('billing', this)">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</a>
            <a role="tab" class="tab" onclick="switchTab('history', this)">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
            <a role="tab" class="tab" onclick="switchTab('leaderboard', this)">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</a>
            <a role="tab" class="tab hidden super-only text-purple-600" onclick="switchTab('super', this)">Mod</a>
        </div>
    </div>

    <div id="tab-live" class="p-4 max-w-md mx-auto">
        <div class="card bg-white shadow-md mb-4 border-l-4 border-primary">
            <div class="card-body p-4 text-center">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">‡∏à‡∏∏‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                    <span id="status-text" class="text-xs badge badge-ghost">...</span>
                </div>
                <button id="btn-action" onclick="toggleStatus()" class="btn btn-primary w-full">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°</button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-bold">Live Court üî¥</h2>
            <div id="court-ctrl" class="hidden join staff-only">
                <button onclick="changeCourts(-1)" class="btn btn-xs join-item">-</button>
                <button class="btn btn-xs join-item bg-gray-200">Court</button>
                <button onclick="changeCourts(1)" class="btn btn-xs join-item">+</button>
            </div>
        </div>
        
        <div id="courts-container" class="space-y-4 mb-6"></div>

        <div id="match-btn" class="hidden staff-only mb-6">
            <button onclick="triggerMatchmake()" class="btn btn-accent w-full font-bold shadow text-white">‚ö° ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (Staff)</button>
        </div>

        <h2 class="text-lg font-bold mb-2">‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô (<span id="queue-count">0</span>)</h2>
        <div class="bg-white rounded-box shadow overflow-hidden">
            <table class="table table-xs">
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Rank</th><th>‡∏£‡∏≠</th></tr></thead>
                <tbody id="queue-list"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-upcoming" class="p-4 max-w-md mx-auto hidden">
        <div class="hidden staff-only card bg-base-200 mb-4 p-4">
            <h3 class="font-bold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πä‡∏ß‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
            <input id="evt-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πä‡∏ß‡∏ô" class="input input-sm w-full mb-2">
            <input type="datetime-local" id="evt-time" class="input input-sm w-full mb-2">
            <button onclick="createEvent()" class="btn btn-sm btn-primary w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á Event</button>
        </div>
        <div id="events-container" class="space-y-3"></div>
    </div>

    <div id="tab-billing" class="p-4 max-w-md mx-auto hidden">
        
        <div class="card bg-white shadow-xl p-4 mb-6">
            <h2 class="card-title text-green-600 mb-4">üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Å‡πä‡∏ß‡∏ô</h2>
            <div class="mb-2">
                <label class="label font-bold">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="bill-total" class="input input-bordered w-full" placeholder="0.00">
            </div>
            
            <div class="divider text-xs">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢ (‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô)</div>
            <div class="flex gap-2 mb-4">
                <input type="number" id="def-hr" value="2" class="input input-bordered w-1/2" placeholder="‡∏ä‡∏°">
                <input type="number" id="def-min" value="0" class="input input-bordered w-1/2" placeholder="‡∏ô">
            </div>

            <button onclick="prepBill()" class="btn btn-primary btn-sm w-full mb-4">‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            
            <div id="bill-inputs" class="space-y-2 mb-4 max-h-60 overflow-y-auto hidden"></div>
            
            <button onclick="calcBill()" class="btn btn-success text-white w-full mb-2">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î</button>
            
            <div id="bill-res" class="hidden bg-green-50 p-3 rounded border border-green-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-gray-500">‡∏ï‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏•‡∏∞ <b id="rate-display"></b> ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <table class="table table-xs w-full mb-2">
                    <tbody id="bill-body"></tbody>
                </table>
                <button onclick="saveBillHistory()" class="btn btn-sm btn-outline btn-success w-full staff-only hidden" id="btn-save-bill">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
        </div>

        <h3 class="font-bold text-gray-500 mb-2">üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (History)</h3>
        <div id="billing-history-container" class="space-y-2"></div>
    </div>

    <div id="tab-history" class="p-4 max-w-md mx-auto hidden">
        <div role="tablist" class="tabs tabs-boxed mb-4">
            <a role="tab" class="tab tab-active" onclick="switchHist('all', this)">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÅ‡∏°‡∏ï‡∏ä‡πå</a>
            <a role="tab" class="tab" onclick="switchHist('my', this)">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏â‡∏±‡∏ô</a>
        </div>
        <div id="hist-list" class="space-y-2"></div>
    </div>

    <div id="tab-leaderboard" class="p-4 max-w-md mx-auto hidden">
        <h2 class="text-center font-bold text-xl mb-4 text-yellow-600">üèÜ Leaderboard</h2>
        <div class="overflow-x-auto bg-white rounded-box shadow">
            <table class="table w-full">
                <thead><tr><th>#</th><th>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th><th class="text-right">MMR</th></tr></thead>
                <tbody id="lb-list"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-super" class="p-4 max-w-md mx-auto hidden">
        <div class="card bg-white shadow-xl p-4">
            <h2 class="card-title text-purple-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Mod</h2>
            <select id="all-players-select" class="select select-bordered w-full mb-2"></select>
            <button onclick="toggleMod()" class="btn btn-neutral w-full mb-4">‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á / ‡∏õ‡∏•‡∏î Mod</button>
            
            <div class="divider"></div>
            <h3 class="font-bold text-red-500">‡πÅ‡∏Å‡πâ Rank (Staff)</h3>
            <select id="rank-select" class="select select-bordered w-full mb-2"></select>
            <div class="join w-full">
                <input type="number" id="new-rank" class="input input-bordered join-item w-full" placeholder="New MMR">
                <button onclick="setRank()" class="btn btn-error join-item text-white">Save</button>
            </div>
        </div>
    </div>

    <dialog id="modal_finish" class="modal">
        <div class="modal-box text-center">
            <h3 class="font-bold text-lg">‡∏à‡∏ö‡πÄ‡∏Å‡∏° Court <span id="md-cid"></span></h3>
            <p class="py-4">‡∏ó‡∏µ‡∏°‡πÑ‡∏´‡∏ô‡∏ä‡∏ô‡∏∞?</p>
            <div class="flex justify-center gap-4">
                <button onclick="subRes('A')" class="btn btn-primary w-24">Team A</button>
                <button onclick="subRes('B')" class="btn btn-error text-white w-24">Team B</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <dialog id="modal_profile" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
            <div class="form-control w-full max-w-xs mx-auto mt-4">
                <label class="label"><span class="label-text">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)</span></label>
                <input type="text" id="my-nickname" class="input input-bordered w-full" />
            </div>
            <div class="modal-action">
                <button onclick="saveProfile()" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <form method="dialog"><button class="btn">‡∏õ‡∏¥‡∏î</button></form>
            </div>
        </div>
    </dialog>

    <script>
        const LIFF_ID = "2009064792-6RT6YKWO"; 
        let user = null; 
        let selCid = null;
        let globalData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏á History

        function switchTab(n, b) {
            document.querySelectorAll('#tablist > .tab').forEach(t=>t.classList.remove('tab-active')); 
            if(b) b.classList.add('tab-active'); // Handle optional button
            ['live','upcoming','billing','history','leaderboard','super'].forEach(t=>document.getElementById('tab-'+t).classList.add('hidden'));
            document.getElementById('tab-'+n).classList.remove('hidden');
        }

        async function main() {
            try {
                await liff.init({liffId:LIFF_ID}); 
                if(!liff.isLoggedIn()){liff.login();return;}
                const p = await liff.getProfile();
                
                const res = await fetch('/api/login', {
                    method:'POST', headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({userId:p.userId, displayName:p.displayName, pictureUrl:p.pictureUrl})
                });
                user = await res.json();
                
                renderUser();
                
                // Permission Handling
                if(user.role === 'super' || user.role === 'mod') {
                    document.querySelectorAll('.staff-only').forEach(e=>e.classList.remove('hidden'));
                }
                if(user.role === 'super') {
                    document.querySelectorAll('.super-only').forEach(e=>e.classList.remove('hidden'));
                    loadAllPlayers(); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Super Admin dropdown
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Mod ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Super ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ Rank (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á Mod)
                    if(user.role === 'mod') loadAllPlayers();
                }

                refresh(); 
                setInterval(refresh, 3000);
            } catch(e){ console.error(e); alert("Error: "+e.message)}
        }

        function renderUser(){
            document.getElementById('user-rank-title').innerText = user.rank_title;
            document.getElementById('user-img').src = user.pictureUrl;
            document.getElementById('my-nickname').value = user.nickname; // ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏Å‡πâ
            
            const b = document.getElementById('btn-action'); 
            const t = document.getElementById('status-text');
            if(user.status=='active'){
                b.innerText="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å (Check-out)"; b.classList.replace('btn-primary','btn-outline'); 
                t.innerText="üü¢ ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß"; t.className="badge badge-success text-white";
            } else if(user.status=='playing'){
                b.innerText="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô"; b.disabled=true; 
                t.innerText="üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏ß‡∏î"; t.className="badge badge-error text-white";
            } else{
                b.innerText="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°"; b.classList.replace('btn-outline','btn-primary'); b.disabled=false; 
                t.innerText="‚ö´ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤"; t.className="badge badge-ghost";
            }
        }

        async function refresh(){
            const d = await(await fetch('/api/get_dashboard')).json();
            globalData = d; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ
            
            // 1. Live Court (Layout 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
            const cc=document.getElementById('courts-container'); cc.innerHTML='';
            for(const[id,m] of Object.entries(d.courts)){
                if(m){
                    const min=Math.floor(m.elapsed/60); 
                    const sec=m.elapsed%60;
                    const canEnd = (user.role!=='user' || [...m.team_a,...m.team_b].map(p=>p.id).includes(user.id));
                    
                    cc.innerHTML += `
                    <div class="card bg-white shadow-lg border border-blue-100 overflow-hidden">
                        <div class="bg-blue-50 px-4 py-2 flex justify-between items-center">
                            <span class="font-bold text-blue-800">COURT ${id}</span>
                            <span class="badge badge-primary badge-outline font-mono">${min}:${sec<10?'0'+sec:sec}</span>
                        </div>
                        <div class="p-4">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="avatar-group -space-x-3">
                                    ${m.team_a.map(p=>`<div class="avatar border"><div class="w-8"><img src="${p.pictureUrl}"></div></div>`).join('')}
                                </div>
                                <div class="font-bold text-gray-700 truncate">${m.team_a.map(p=>p.nickname).join(', ')}</div>
                            </div>
                            <div class="divider my-0 text-xs text-gray-400">VS</div>
                            <div class="flex items-center gap-3 mt-2">
                                <div class="avatar-group -space-x-3">
                                    ${m.team_b.map(p=>`<div class="avatar border"><div class="w-8"><img src="${p.pictureUrl}"></div></div>`).join('')}
                                </div>
                                <div class="font-bold text-gray-700 truncate">${m.team_b.map(p=>p.nickname).join(', ')}</div>
                            </div>
                            ${canEnd ? `<button onclick="selCid=${id};document.getElementById('modal_finish').showModal();document.getElementById('md-cid').innerText=${id}" class="btn btn-sm btn-error w-full mt-3 text-white">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>` : ''}
                        </div>
                    </div>`;
                } else {
                    cc.innerHTML+=`<div class="card bg-base-100 border-2 border-dashed border-gray-300 p-6 text-center text-gray-400">Court ${id} ‡∏ß‡πà‡∏≤‡∏á</div>`;
                }
            }

            // 2. Queue
            document.getElementById('queue-count').innerText=d.queue_count;
            document.getElementById('queue-list').innerHTML=d.queue.map(p=>`
                <tr>
                    <td><div class="flex items-center gap-2"><img src="${p.pictureUrl}" class="w-6 h-6 rounded-full"><span class="font-bold text-xs">${p.nickname}</span></div></td>
                    <td><span class="badge badge-ghost badge-xs">${p.rank_title}</span></td>
                    <td class="text-xs text-gray-500">${Math.floor((Date.now()/1000-p.last_active)/60)}m</td>
                </tr>`).join('');

            // 3. Events
            document.getElementById('events-container').innerHTML=d.events.map(e=>`
                <div class="card bg-white shadow-sm border-l-4 border-yellow-400 p-4">
                    <h3 class="font-bold text-lg">${e.name}</h3>
                    <div class="text-sm text-gray-500 mb-2">üìÖ ${e.datetime.replace('T',' ')}</div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs badge badge-neutral">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ${e.player_count} ‡∏Ñ‡∏ô</span>
                        <button onclick="joinEvt('${e.id}')" class="btn btn-sm btn-outline">Join / Cancel</button>
                    </div>
                </div>`).join('');

            // 4. Leaderboard
            document.getElementById('lb-list').innerHTML = d.leaderboard.map((p, i) => `
                <tr class="${p.id === user.id ? 'bg-blue-50' : ''}">
                    <td class="font-bold">${i+1}</td>
                    <td>
                        <div class="flex items-center gap-3">
                            <div class="avatar"><div class="w-8 rounded-full"><img src="${p.pictureUrl}" /></div></div>
                            <div>
                                <div class="font-bold text-sm">${p.nickname}</div>
                                <div class="text-[10px] text-gray-500 badge badge-ghost badge-xs">${p.rank_title}</div>
                            </div>
                        </div>
                    </td>
                    <td class="text-right font-mono font-bold text-blue-600">${p.mmr}</td>
                </tr>
            `).join('');

            // 5. Billing History
            renderBillingHistory(d.billing_history);
            
            // 6. Match History (Render based on current filter)
            renderMatchHistory();
        }

        // --- PROFILE EDIT ---
        function editProfileModal() { document.getElementById('modal_profile').showModal(); }
        async function saveProfile() {
            const nn = document.getElementById('my-nickname').value;
            await fetch('/api/update_profile', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id, nickname:nn})});
            alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            location.reload(); // Reload ‡πÄ‡∏û‡∏∑‡πà‡∏≠ update ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        }

        // --- HISTORY LOGIC ---
        let histFilter = 'all';
        function switchHist(type, btn) {
            histFilter = type;
            btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('tab-active'));
            btn.classList.add('tab-active');
            renderMatchHistory();
        }

        function renderMatchHistory() {
            if(!globalData) return;
            const container = document.getElementById('hist-list');
            const data = globalData.match_history;
            
            const filtered = histFilter === 'my' 
                ? data.filter(m => user.nickname && (m.team_a.includes(user.nickname) || m.team_b.includes(user.nickname)))
                : data;

            if(filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 mt-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á</div>';
                return;
            }

            container.innerHTML = filtered.map(m => `
                <div class="card bg-white shadow-sm p-3 border border-gray-100">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>üìÖ ${m.date} ${m.time}</span>
                        <span>Court ${m.court}</span>
                    </div>
                    <div class="flex items-center text-sm">
                        <div class="w-5/12 text-right ${m.winner==='Team A'?'font-bold text-green-600':''}">${m.team_a.join(', ')}</div>
                        <div class="w-2/12 text-center text-gray-300 text-xs">VS</div>
                        <div class="w-5/12 text-left ${m.winner==='Team B'?'font-bold text-green-600':''}">${m.team_b.join(', ')}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderBillingHistory(hist) {
            const c = document.getElementById('billing-history-container');
            if(hist.length === 0) { c.innerHTML = '<div class="text-center text-xs text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏•</div>'; return; }
            c.innerHTML = hist.map(b => `
                <div class="collapse collapse-arrow bg-base-100 border border-base-300">
                    <input type="radio" name="bill-hist" /> 
                    <div class="collapse-title text-sm font-medium flex justify-between">
                        <span>üìÖ ${b.date}</span>
                        <span class="text-green-600">‡∏£‡∏ß‡∏° ${b.total} ‡∏ö.</span>
                    </div>
                    <div class="collapse-content text-xs"> 
                        <table class="table table-xs w-full">
                            ${b.players.map(p => `<tr><td>${p.name}</td><td class="text-right">${p.cost}</td></tr>`).join('')}
                        </table>
                    </div>
                </div>
            `).join('');
        }

        // --- ACTIONS ---
        async function toggleStatus(){ await fetch('/api/toggle_status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id})}); refresh(); }
        async function createEvent(){ await fetch('/api/admin/create_event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,name:document.getElementById('evt-name').value,datetime:document.getElementById('evt-time').value})}); alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß'); refresh();}
        async function joinEvt(eid){ const r=await fetch('/api/event/join',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id,eventId:eid})}); alert((await r.json()).status); refresh();}
        async function triggerMatchmake(){ const r=await(await fetch('/api/matchmake',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id})})).json(); if(r.status!='matched')alert(r.message); else refresh();}
        async function changeCourts(d){ await fetch('/api/admin/set_courts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,count:document.querySelectorAll('#courts-container>div').length+d})}); refresh();}
        async function subRes(w){ await fetch('/api/submit_result',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({courtId:selCid,winner:w,requesterId:user.id})}); document.getElementById('modal_finish').close(); refresh();}

        // --- BILLING LOGIC ---
        let currentBillData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏ß‡πâ‡∏£‡∏≠ save
        async function prepBill(){
            const d=await(await fetch('/api/get_dashboard')).json();
            const all=[]; Object.values(d.courts).forEach(m=>{if(m)[...m.team_a,...m.team_b].forEach(p=>all.push(p))}); d.queue.forEach(p=>all.push(p));
            // ‡πÄ‡∏≠‡∏≤ unique players
            const u=[...new Map(all.map(p=>[p.id,p])).values()].sort((a,b)=>a.nickname.localeCompare(b.nickname));
            
            const hr=document.getElementById('def-hr').value; const mn=document.getElementById('def-min').value;
            const container = document.getElementById('bill-inputs');
            container.classList.remove('hidden');
            container.innerHTML=u.map(p=>`
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded border">
                    <span class="text-xs font-bold w-1/3 truncate">${p.nickname}</span>
                    <div class="flex gap-1">
                        <input type="number" data-uid="${p.id}" data-type="hr" value="${hr}" class="input input-xs w-10 text-center">
                        <span class="text-xs self-center">:</span>
                        <input type="number" data-uid="${p.id}" data-type="min" value="${mn}" class="input input-xs w-10 text-center">
                    </div>
                </div>`).join('');
        }
        async function calcBill(){
            const ps=[]; document.querySelectorAll('#bill-inputs>div').forEach(d=>{
                const i=d.querySelectorAll('input'); ps.push({id:i[0].dataset.uid, name:d.querySelector('span').innerText, minutes:parseInt(i[0].value)*60+parseInt(i[1].value)})
            });
            const total = document.getElementById('bill-total').value;
            if(!total) return alert("‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô");

            const r=await(await fetch('/api/admin/calculate_bill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,totalExpense:total,players:ps})})).json();
            if(r.error)return alert(r.error);
            
            document.getElementById('bill-res').classList.remove('hidden');
            document.getElementById('rate-display').innerText = r.rate;
            document.getElementById('bill-body').innerHTML=r.bill_list.map(b=>`<tr><td>${b.name}</td><td class="text-right text-xs text-gray-500">${b.time}</td><td class="text-right font-bold text-green-700">${b.cost}</td></tr>`).join('');
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Save (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Staff)
            currentBillData = r.bill_list; 
            if(user.role !== 'user') document.getElementById('btn-save-bill').classList.remove('hidden');
        }
        
        async function saveBillHistory() {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?")) return;
            const total = document.getElementById('bill-total').value;
            await fetch('/api/admin/save_bill', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({adminId:user.id, total:total, billData:currentBillData})
            });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); refresh();
        }

        // --- SUPER / STAFF HELPERS ---
        async function loadAllPlayers(){
            const ps=await(await fetch('/api/get_all_players')).json(); 
            const h=ps.map(p=>`<option value="${p.id}">${p.nickname} (${p.rank_title})</option>`).join('');
            document.getElementById('all-players-select').innerHTML=h;
            document.getElementById('rank-select').innerHTML=h;
        }
        async function toggleMod(){
            const tid=document.getElementById('all-players-select').value;
            const r=await(await fetch('/api/super/toggle_mod',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,targetId:tid})})).json();
            if(r.error) alert(r.error); else { alert(r.msg); refresh(); }
        }
        async function setRank(){
            const tid=document.getElementById('rank-select').value; const mmr=document.getElementById('new-rank').value;
            await fetch('/api/admin/set_rank',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminId:user.id,targetId:tid,mmr})});
            alert('Saved'); loadAllPlayers();
        }

        main();
    </script>
</body>
</html>