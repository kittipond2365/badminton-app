<!DOCTYPE html>
<html data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>izesquad</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    .fade-in { animation: fadeIn .18s ease-in; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(2px);} to {opacity:1; transform: translateY(0);} }

    .pill { padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
    .pill-wr-low { background: rgba(239,68,68,.12); color: rgb(185,28,28); border: 1px solid rgba(239,68,68,.25); }
    .pill-wr-mid { background: rgba(107,114,128,.12); color: rgb(55,65,81); border: 1px solid rgba(107,114,128,.25); }
    .pill-wr-high { background: rgba(34,197,94,.12); color: rgb(21,128,61); border: 1px solid rgba(34,197,94,.25); }

    .mini-title { font-size: 11px; font-weight: 700; color: rgb(156,163,175); }
    .mini-sub { font-size: 11px; font-weight: 600; color: rgb(107,114,128); }

    .card-soft { border: 1px solid rgb(224,231,255); }
    .delta-plus { color: rgb(22,163,74); font-weight: 800; }
    .delta-minus { color: rgb(220,38,38); font-weight: 800; }
    .delta-zero { color: rgb(107,114,128); font-weight: 800; }
  </style>
</head>

<body class="bg-slate-100 min-h-screen pb-24">

  <!-- TOP BAR -->
  <div class="navbar bg-white shadow-sm px-4 sticky top-0 z-50">
    <div class="flex-1">
      <span class="text-xl font-black text-indigo-600 italic">izesquad <i class="fa-solid fa-bolt text-yellow-400"></i></span>
    </div>

    <div class="flex-none gap-2">
      <button id="btn-admin" onclick="safeShowModal('modal_admin')"
              class="btn btn-circle btn-ghost text-red-600 hidden">
        <i class="fa-solid fa-gear text-xl"></i>
      </button>

      <button id="btn-bill" onclick="openBillingModal()"
              class="btn btn-circle btn-ghost text-green-600 hidden">
        <i class="fa-solid fa-file-invoice-dollar text-xl"></i>
      </button>

      <div class="text-right">
        <div class="text-[10px] text-gray-500">MMR</div>
        <div class="font-bold text-indigo-600" id="my-mmr">...</div>
      </div>

      <div class="avatar">
        <div class="w-10 rounded-full ring ring-indigo-500 ring-offset-2">
          <img id="my-img" src="https://ui-avatars.com/api/?name=User" />
        </div>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="px-2 mt-3">
    <div role="tablist" class="tabs tabs-boxed bg-white shadow-sm font-bold">
      <a role="tab" id="tab-btn-live" class="tab tab-active" onclick="switchTab('live')">‡∏™‡∏ô‡∏≤‡∏°</a>
      <a role="tab" id="tab-btn-stats" class="tab" onclick="switchTab('stats')">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</a>
      <a role="tab" id="tab-btn-history" class="tab" onclick="switchTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
      <a role="tab" id="tab-btn-rank" class="tab" onclick="switchTab('rank')">Leaderboard</a>
      <a role="tab" id="tab-btn-events" class="tab" onclick="switchTab('events')">Events</a>
    </div>
  </div>

  <!-- LIVE TAB -->
  <div id="tab-live" class="p-4 max-w-md mx-auto fade-in">
    <div id="session-alert" class="hidden alert alert-warning mb-4 shadow-sm">
      <i class="fa-solid fa-triangle-exclamation"></i>
      <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô (‡∏£‡∏≠ Mod ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°)</span>
    </div>

    <!-- PROFILE CARD -->
    <div class="card bg-white shadow-md mb-4 border-l-4 border-indigo-500 card-soft">
      <div class="card-body p-4">
        <div class="flex justify-between items-start mb-2">
          <div>
            <div class="font-bold text-gray-700" id="me-name">...</div>
            <div class="mini-title" id="me-title">...</div>
          </div>
          <div class="text-right">
            <div class="mini-title">WR</div>
            <div id="me-wr-pill" class="pill pill-wr-mid">0%</div>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="btn-checkin" onclick="toggleStatus()" class="btn btn-primary flex-1">Loading...</button>
          <button id="btn-rest" onclick="toggleRest()" class="btn btn-outline flex-1">‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢</button>
        </div>

        <label class="label cursor-pointer justify-start gap-2 mt-2">
          <input type="checkbox" id="toggle-auto-rest" class="checkbox checkbox-sm checkbox-primary" onchange="toggleAutoRest()">
          <span class="label-text font-bold text-gray-500 text-xs">‡∏û‡∏±‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Cooldown)</span>
        </label>

        <div class="mini-sub mt-1">
          Cooldown ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <b id="cooldown-suggest">0</b> ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏ó + ‡∏Ñ‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)
        </div>
      </div>
    </div>

    <!-- PAIR REQUEST -->
    <div class="card bg-white shadow-sm mb-4 card-soft">
      <div class="card-body p-4">
        <div class="flex justify-between items-center mb-2">
          <div class="font-bold text-gray-600">‡∏Ç‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</div>
          <button class="btn btn-xs btn-ghost text-indigo-600" onclick="refresh()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>

        <div id="pair-outgoing-box" class="hidden bg-indigo-50 p-3 rounded border border-indigo-100 mb-2">
          <div class="text-xs text-indigo-700">
            ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏´‡∏≤: <b id="pair-outgoing-name">...</b>
          </div>
          <button class="btn btn-xs btn-ghost text-red-500 mt-2" onclick="cancelOutgoing()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
        </div>

        <div id="pair-paired-box" class="hidden bg-green-50 p-3 rounded border border-green-100 mb-2">
          <div class="text-xs text-green-700">
            ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏±‡∏ö: <b id="pair-paired-name">...</b>
          </div>
          <button class="btn btn-xs btn-ghost text-red-500 mt-2" onclick="cancelPair()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà</button>
        </div>

        <div id="pair-request-form" class="join w-full">
          <select id="partner-select" class="select select-bordered select-sm w-full join-item text-xs">
            <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>
          </select>
          <button onclick="sendPairRequest()" class="btn btn-sm btn-primary join-item">‡∏Ç‡∏≠</button>
        </div>

        <div class="divider text-xs text-gray-400 my-2">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏≤‡∏Ñ‡∏∏‡∏ì</div>
        <div id="pair-incoming-list" class="space-y-2"></div>
      </div>
    </div>

    <!-- STAFF CONTROLS -->
    <div id="staff-controls" class="hidden mb-4">
      <button onclick="requestMatchmake()" class="btn btn-neutral w-full shadow-lg">
        <i class="fa-solid fa-shuffle"></i> ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î AutoMatch)
      </button>
    </div>

    <!-- COURTS -->
    <div id="courts-container" class="space-y-3 mb-6"></div>

    <!-- QUEUE -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden card-soft">
      <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between">
        <span>‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô</span>
        <span id="q-count" class="badge badge-neutral">0</span>
      </div>
      <table class="table table-sm">
        <tbody id="queue-list"></tbody>
      </table>
    </div>

    <!-- RESTING LIST (‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠ 7) -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden card-soft mt-3">
      <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between">
        <span>‡∏Ñ‡∏ô‡∏û‡∏±‡∏Å</span>
        <span id="r-count" class="badge badge-ghost">0</span>
      </div>
      <table class="table table-sm">
        <tbody id="resting-list"></tbody>
      </table>
    </div>
  </div>

  <!-- STATS TAB -->
  <div id="tab-stats" class="p-4 max-w-md mx-auto hidden">
    <div class="card bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-xl mb-4">
      <div class="card-body p-5 text-center">
        <h2 class="text-lg font-bold opacity-80">WIN RATE (Set-based)</h2>
        <div class="text-5xl font-black my-2" id="st-wr">0%</div>
        <div class="flex justify-center gap-4 text-sm opacity-90">
          <span>‚úÖ Sets: <b id="st-win">0</b></span>
          <span>‚ùå Sets: <b id="st-lose">0</b></span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4">
      <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200">
        <div class="text-xs text-gray-400 mb-1">‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
        <div class="text-xl font-bold text-gray-700" id="st-pf">0</div>
      </div>
      <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200">
        <div class="text-xs text-gray-400 mb-1">‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏£‡∏ß‡∏°</div>
        <div class="text-xl font-bold text-gray-700" id="st-pa">0</div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-3 border border-gray-200">
      <div class="text-xs text-gray-400 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
      <div class="text-sm text-gray-600">
        ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ã‡∏ï‚Äù (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô) ‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô tie-breaker
      </div>
    </div>
  </div>

  <!-- HISTORY TAB -->
  <div id="tab-history" class="p-4 max-w-md mx-auto hidden">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-bold text-gray-500">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á</h3>
      <div class="join">
        <button id="btn-hist-mine" class="btn btn-xs join-item btn-primary" onclick="setHistoryMode('mine')">‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        <button id="btn-hist-global" class="btn btn-xs join-item" onclick="setHistoryMode('global')">Global</button>
      </div>
    </div>
    <div id="history-cards" class="space-y-3"></div>
  </div>

  <!-- LEADERBOARD TAB -->
  <div id="tab-rank" class="p-4 max-w-md mx-auto hidden">
    <div class="join w-full mb-3">
      <button id="lb-mmr" class="btn btn-sm join-item btn-primary flex-1" onclick="setLBMode('mmr')">MMR</button>
      <button id="lb-points" class="btn btn-sm join-item flex-1" onclick="setLBMode('points')">‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°</button>
      <button id="lb-wr" class="btn btn-sm join-item flex-1" onclick="setLBMode('winrate')">Winrate</button>
    </div>

    <div class="overflow-x-auto bg-white rounded-xl shadow-sm card-soft">
      <table class="table table-sm">
        <thead>
          <tr class="bg-gray-100">
            <th>#</th>
            <th>Player</th>
            <th class="text-right" id="lb-right-head">MMR</th>
          </tr>
        </thead>
        <tbody id="lb-list"></tbody>
      </table>
    </div>
  </div>

  <!-- EVENTS TAB -->
  <div id="tab-events" class="p-4 max-w-md mx-auto hidden">
    <div class="staff-only hidden mb-4 p-4 bg-white rounded shadow card-soft">
      <h3 class="font-bold text-sm mb-2">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Event (Custom)</h3>
      <div class="text-xs text-gray-500 mb-2">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÅ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏° (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö session)</div>
      <input id="evt-name" class="input input-bordered input-sm w-full mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Event">
      <button onclick="createEvent()" class="btn btn-primary btn-sm w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
    </div>

    <div id="events-list" class="space-y-3"></div>
  </div>

  <!-- MODAL: FINISH MATCH -->
  <dialog id="modal_finish" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-2">‡∏à‡∏ö‡πÄ‡∏Å‡∏° Court <span id="fin-cid"></span></h3>
      <div class="text-xs text-gray-500 mb-3" id="fin-rule-text"></div>

      <div class="grid grid-cols-2 gap-3">
        <div class="bg-indigo-50 p-3 rounded border border-indigo-100">
          <div class="font-bold text-indigo-700 text-xs mb-2">TEAM A</div>
          <div id="fin-team-a" class="space-y-2 text-sm"></div>
        </div>
        <div class="bg-rose-50 p-3 rounded border border-rose-100">
          <div class="font-bold text-rose-700 text-xs mb-2">TEAM B</div>
          <div id="fin-team-b" class="space-y-2 text-sm"></div>
        </div>
      </div>

      <div class="divider my-3 text-xs text-gray-400">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
      <div id="fin-sets" class="space-y-2"></div>

      <div class="modal-action">
        <button class="btn btn-ghost" onclick="safeCloseModal('modal_finish')">‡∏õ‡∏¥‡∏î</button>
        <button class="btn btn-primary" onclick="submitResult()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
      </div>

      <div class="text-xs text-gray-500 mt-2">
        ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏î‡∏¥‡∏ß‡∏™‡πå‡∏ñ‡∏∂‡∏á 30 ‡πÅ‡∏ï‡πâ‡∏° (30-29)
      </div>
    </div>
  </dialog>

  <!-- MODAL: PROFILE -->
  <dialog id="modal_profile" class="modal">
    <div class="modal-box">
      <div class="flex items-center gap-3">
        <div class="avatar">
          <div class="w-12 rounded-full">
            <img id="pf-img" src="https://ui-avatars.com/api/?name=User">
          </div>
        </div>
        <div class="min-w-0">
          <div class="font-black text-lg truncate" id="pf-name">...</div>
          <div class="mini-title" id="pf-title">...</div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2 mt-4">
        <div class="bg-white border rounded p-2 text-center">
          <div class="mini-title">Set WR</div>
          <div class="font-black" id="pf-wr">0%</div>
        </div>
        <div class="bg-white border rounded p-2 text-center">
          <div class="mini-title">Sets</div>
          <div class="font-black" id="pf-sets">0-0</div>
        </div>
        <div class="bg-white border rounded p-2 text-center">
          <div class="mini-title">Points</div>
          <div class="font-black" id="pf-pts">0-0</div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2 mt-2">
        <div class="bg-white border rounded p-2 text-center">
          <div class="mini-title">Match WR</div>
          <div class="font-black" id="pf-mwr">0%</div>
        </div>
        <div class="bg-white border rounded p-2 text-center">
          <div class="mini-title">Matches</div>
          <div class="font-black" id="pf-mrec">0-0</div>
        </div>
        <div class="bg-white border rounded p-2 text-center">
          <div class="mini-title">MMR</div>
          <div class="font-black" id="pf-mmr">‚Äî</div>
        </div>
      </div>

      <div class="divider my-3 text-xs text-gray-400">10 ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (+/- MMR)</div>
      <div id="pf-last10" class="space-y-2"></div>

      <div class="modal-action">
        <button class="btn" onclick="safeCloseModal('modal_profile')">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL: ADMIN -->
  <dialog id="modal_admin" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-3 text-red-600">Admin Panel</h3>

      <div class="mb-4 p-4 bg-red-50 rounded-lg border border-red-100">
        <h4 class="font-bold text-sm mb-2">Session Control</h4>

        <div class="grid grid-cols-2 gap-2 mb-2">
          <select id="sess-pts" class="select select-bordered select-sm w-full">
            <option value="21" selected>21 ‡πÅ‡∏ï‡πâ‡∏°</option>
            <option value="11">11 ‡πÅ‡∏ï‡πâ‡∏°</option>
          </select>
          <select id="sess-bo" class="select select-bordered select-sm w-full">
            <option value="1" selected>BO1</option>
            <option value="2">BO2</option>
            <option value="3">BO3</option>
          </select>
        </div>

        <label class="label cursor-pointer justify-start gap-2 mb-2">
          <input type="checkbox" id="sess-notify" class="checkbox checkbox-sm checkbox-primary">
          <span class="label-text font-bold text-gray-600 text-xs">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (In-app) ‡∏ï‡∏≠‡∏ô match ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</span>
        </label>

        <input id="sess-name" class="input input-bordered input-sm w-full mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πä‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å = ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)">

        <button id="btn-sess-start" onclick="startSession()" class="btn btn-success text-white w-full mb-2">
          üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡πä‡∏ß‡∏ô
        </button>
        <button id="btn-sess-end" onclick="endSession()" class="btn btn-error text-white w-full">
          üèÅ ‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô
        </button>
      </div>

      <div class="mb-4 p-4 bg-white rounded-lg border border-gray-200">
        <h4 class="font-bold text-sm mb-2">Courts</h4>
        <div class="flex justify-between items-center mb-3">
          <div class="join">
            <button onclick="changeCourtCount(-1)" class="btn btn-xs join-item">-</button>
            <button class="btn btn-xs join-item bg-white cursor-default" id="court-count-display">2</button>
            <button onclick="changeCourtCount(1)" class="btn btn-xs join-item">+</button>
          </div>
          <button onclick="openManualMatch()" class="btn btn-xs btn-neutral">
            <i class="fa-solid fa-hand-pointer"></i> ‡∏à‡∏±‡∏î‡∏Ñ‡∏π‡πà‡πÄ‡∏≠‡∏á
          </button>
        </div>

        <div class="divider text-xs text-gray-400 my-2">AutoMatch ‡∏ï‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏ó</div>
        <div id="automatch-list" class="space-y-2"></div>
      </div>

      <div class="mb-4 p-4 bg-white rounded-lg border border-gray-200">
        <h4 class="font-bold text-sm mb-2">Edit MMR (Staff Only)</h4>
        <select id="mmr-target" class="select select-bordered select-sm w-full mb-2"></select>
        <input id="mmr-value" type="number" class="input input-bordered input-sm w-full mb-2" placeholder="MMR ‡πÉ‡∏´‡∏°‡πà">
        <button class="btn btn-sm btn-primary w-full" onclick="setMMR()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>

      <div id="super-admin-section" class="mb-4 hidden">
        <h4 class="font-bold text-sm mb-2">Moderators</h4>
        <div class="h-48 overflow-y-auto border rounded p-2 bg-white">
          <table class="table table-xs"><tbody id="admin-user-list"></tbody></table>
        </div>
      </div>

      <div class="modal-action">
        <button class="btn" onclick="safeCloseModal('modal_admin')">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL: MANUAL MATCH -->
  <dialog id="modal_manual_match" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">üñê ‡∏à‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</h3>

      <select id="man-court" class="select select-bordered select-sm w-full mb-2"></select>

      <div class="grid grid-cols-2 gap-2 mb-4">
        <div class="bg-indigo-50 p-2 rounded border border-indigo-100">
          <div class="font-bold text-indigo-600 text-xs mb-1">TEAM A</div>
          <select id="man-p1" class="select select-bordered select-xs w-full mb-1 player-select"></select>
          <select id="man-p2" class="select select-bordered select-xs w-full player-select"></select>
        </div>

        <div class="bg-rose-50 p-2 rounded border border-rose-100">
          <div class="font-bold text-rose-600 text-xs mb-1">TEAM B</div>
          <select id="man-p3" class="select select-bordered select-xs w-full mb-1 player-select"></select>
          <select id="man-p4" class="select select-bordered select-xs w-full player-select"></select>
        </div>
      </div>

      <button onclick="submitManualMatch()" class="btn btn-primary w-full">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°</button>
      <div class="mt-2 text-center">
        <button class="btn btn-ghost btn-sm" onclick="safeCloseModal('modal_manual_match')">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL: BILLING -->
  <dialog id="modal_billing" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
      <h3 class="font-bold text-lg mb-2 text-green-600">üí∞ Billing</h3>

      <div class="grid grid-cols-1 gap-3 mb-4 bg-gray-50 p-3 rounded-lg border">
        <select id="bill-event-select" class="select select-bordered select-sm w-full" onchange="loadBillPlayers()">
          <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Event/Session --</option>
        </select>

        <div class="grid grid-cols-2 gap-2">
          <input id="bill-total-cost" type="number" class="input input-bordered input-sm w-full" placeholder="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°" oninput="calculateBill()">
          <input id="bill-default-hr" type="number" class="input input-bordered input-sm w-full" value="2" oninput="applyDefaultTime()">
        </div>

        <label class="label cursor-pointer justify-start gap-2">
          <input type="checkbox" id="bill-show-all" class="checkbox checkbox-sm checkbox-primary" onchange="loadBillPlayers()">
          <span class="label-text font-bold text-gray-500">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</span>
        </label>
      </div>

      <div class="overflow-x-auto max-h-64 mb-4 border rounded">
        <table class="table table-xs table-pin-rows">
          <thead>
            <tr class="bg-gray-200">
              <th>‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="w-16">‡∏ä‡∏°.</th>
              <th class="w-16">‡∏ô‡∏≤‡∏ó‡∏µ</th>
              <th class="text-right">‡∏ö‡∏≤‡∏ó</th>
            </tr>
          </thead>
          <tbody id="bill-player-list"></tbody>
        </table>
      </div>

      <div class="flex justify-between items-center bg-green-100 p-3 rounded mb-4">
        <span class="font-bold text-green-800">‡∏£‡∏ß‡∏°:</span>
        <span id="bill-grand-total" class="font-black text-xl text-green-800">0</span>
      </div>

      <div class="modal-action">
        <button class="btn btn-ghost" onclick="safeCloseModal('modal_billing')">‡∏õ‡∏¥‡∏î</button>
        <button class="btn btn-success text-white" onclick="copyBillSummary()">Copy</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL: MATCH CALLED NOTIFY -->
  <dialog id="modal_notify" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">üì£ ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏•‡∏á‡∏™‡∏ô‡∏≤‡∏°!</h3>
      <div class="text-sm text-gray-600 mt-1" id="notify-text">...</div>
      <div class="modal-action">
        <button class="btn btn-primary" onclick="safeCloseModal('modal_notify')">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
      </div>
    </div>
  </dialog>

  <script>
    const LIFF_ID = "2009064792-6RT6YKWO";

    let user = null;
    let dashboard = null;

    let refreshTimer = null;
    let selectedCid = null;
    let historyMode = "mine";
    let lbMode = "mmr";
    let lastNotifiedMatchId = null;

    // -----------------------------
    // Modal helpers (‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠ 2: iOS/LIFF ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡πÑ‡∏°‡πà support showModal ‡∏î‡∏µ)
    // -----------------------------
    function safeShowModal(id){
      const dlg = document.getElementById(id);
      if(!dlg) return;
      try{
        if(typeof dlg.showModal === "function"){
          dlg.showModal();
        }else{
          dlg.setAttribute("open", "");
          dlg.classList.add("modal-open");
        }
      }catch(e){
        // fallback
        dlg.setAttribute("open", "");
        dlg.classList.add("modal-open");
      }
    }
    function safeCloseModal(id){
      const dlg = document.getElementById(id);
      if(!dlg) return;
      try{
        if(typeof dlg.close === "function"){
          dlg.close();
        }else{
          dlg.removeAttribute("open");
          dlg.classList.remove("modal-open");
        }
      }catch(e){
        dlg.removeAttribute("open");
        dlg.classList.remove("modal-open");
      }
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function getTitleFromPlayer(p){
      if(p.unrank) return `Unrank (${p.calib_games ?? 0}/10)`;
      return p.rank_title || "";
    }

    function wrPillClass(wr){
      if(wr < 40) return "pill pill-wr-low";
      if(wr < 60) return "pill pill-wr-mid";
      return "pill pill-wr-high";
    }

    function deltaClass(v){
      if(v == null) return "delta-zero";
      if(v > 0) return "delta-plus";
      if(v < 0) return "delta-minus";
      return "delta-zero";
    }

    function formatDelta(v){
      if(v == null) return "";
      const n = parseInt(v, 10);
      if(n > 0) return `+${n}`;
      return `${n}`;
    }

    function beep(times=2){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        let t = ctx.currentTime;
        for(let i=0;i<times;i++){
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine";
          o.frequency.value = 880;
          g.gain.value = 0.08;
          o.connect(g); g.connect(ctx.destination);
          o.start(t);
          o.stop(t + 0.12);
          t += 0.18;
        }
      }catch(e){}
    }

    function buzz(){
      try{
        if(navigator.vibrate) navigator.vibrate([120,80,120]);
      }catch(e){}
    }

    function switchTab(t) {
      document.querySelectorAll('.tab').forEach(e => e.classList.remove('tab-active'));
      ['live','stats','history','rank','events'].forEach(x => {
        const el = document.getElementById('tab-'+x);
        if(el) el.classList.add('hidden');
      });
      const targetBtn = document.getElementById('tab-btn-' + t);
      const targetDiv = document.getElementById('tab-' + t);
      if (targetBtn) targetBtn.classList.add('tab-active');
      if (targetDiv) targetDiv.classList.remove('hidden');
    }

    // -----------------------------
    // Login
    // -----------------------------
    async function main() {
      if (location.hostname.includes("localhost")) {
        await apiLogin("U1cf933e3a1559608c50c0456f6583dc9", "Admin Pond", "https://ui-avatars.com/api/?name=Admin");
      } else {
        try {
          await liff.init({ liffId: LIFF_ID });
          if(!liff.isLoggedIn()) liff.login();
          else {
            const p = await liff.getProfile();
            await apiLogin(p.userId, p.displayName, p.pictureUrl);
          }
        } catch(e) {
          alert("LIFF Error: " + e);
        }
      }
    }

    async function apiLogin(uid, name, pic) {
      const res = await fetch('/api/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: uid, displayName: name, pictureUrl: pic })
      });
      user = await res.json();
      renderMe();
      await refresh();

      if(!refreshTimer){
        refreshTimer = setInterval(refresh, 4000);
      }
    }

    // -----------------------------
    // Render: me
    // -----------------------------
    function renderMe(){
      if(!user) return;

      document.getElementById('my-img').src = user.pictureUrl || "https://ui-avatars.com/api/?name=User";
      document.getElementById('me-name').innerText = user.nickname || "User";
      document.getElementById('me-title').innerText = user.rank_title || "";

      if(user.unrank){
        document.getElementById('my-mmr').innerText = `Unrank (${user.calib_games ?? 0}/10)`;
      }else{
        document.getElementById('my-mmr').innerText = user.mmr ?? "‚Äî";
      }

      const wr = user.stats?.win_rate ?? 0;
      const pill = document.getElementById('me-wr-pill');
      pill.className = wrPillClass(wr);
      pill.innerText = `${wr}%`;

      document.getElementById('st-wr').innerText = `${wr}%`;
      document.getElementById('st-win').innerText = user.stats?.set_wins ?? 0;
      document.getElementById('st-lose').innerText = user.stats?.set_losses ?? 0;
      document.getElementById('st-pf').innerText = user.stats?.points_for ?? 0;
      document.getElementById('st-pa').innerText = user.stats?.points_against ?? 0;

      const isStaff = (user.role === "super" || user.role === "mod");
      if(isStaff){
        document.getElementById('btn-admin').classList.remove('hidden');
        document.getElementById('btn-bill').classList.remove('hidden');
        document.querySelectorAll('.staff-only').forEach(e=>e.classList.remove('hidden'));
        document.getElementById('staff-controls').classList.remove('hidden');
      }
      if(user.role === "super"){
        document.getElementById('super-admin-section').classList.remove('hidden');
      }
    }

    // -----------------------------
    // Refresh dashboard
    // -----------------------------
    async function refresh(){
      try{
        const res = await fetch('/api/get_dashboard');
        dashboard = await res.json();

        const sys = dashboard.system || {};
        const sessActive = !!sys.is_session_active;

        const sessAlert = document.getElementById('session-alert');
        if(!sessActive) sessAlert.classList.remove('hidden'); else sessAlert.classList.add('hidden');

        document.getElementById('cooldown-suggest').innerText = sys.suggested_cooldown_min ?? 0;
        document.getElementById('court-count-display').innerText = sys.total_courts ?? 2;

        // sync me from all_players
        const me = (dashboard.all_players || []).find(x => x.id === user.id);
        if(me){
          user.status = me.status;
          user.resting = me.resting;
          user.auto_rest = me.auto_rest;
          user.pair_outgoing = me.pair_outgoing;
          user.pair_incoming = me.pair_incoming;
          user.paired_with = me.paired_with;
          user.current_match_id = me.current_match_id;
          user.current_court = me.current_court;
          user.unrank = me.unrank;
          user.calib_games = me.calib_games;
          user.rank_title = me.rank_title;
          user.mmr = me.mmr;

          if(user.unrank) document.getElementById('my-mmr').innerText = `Unrank (${user.calib_games ?? 0}/10)`;
          else document.getElementById('my-mmr').innerText = user.mmr ?? "‚Äî";

          document.getElementById('me-title').innerText = user.rank_title || "";
          document.getElementById('toggle-auto-rest').checked = !!user.auto_rest;
        }

        renderCheckinButtons(sessActive);
        renderPairUI();
        renderCourts();
        renderQueue();
        renderResting();
        renderHistoryCards();
        renderLeaderboards();
        renderEvents();
        renderAdminLists();
        maybeNotifyCalledMatch(sys);

      }catch(e){
        console.error("refresh error", e);
      }
    }

    function renderCheckinButtons(sessActive){
      const btn = document.getElementById('btn-checkin');
      const btnRest = document.getElementById('btn-rest');

      if(!sessActive){
        btn.disabled = true;
        btn.className = "btn btn-disabled flex-1";
        btn.innerText = "‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡πä‡∏ß‡∏ô...";
        btnRest.disabled = true;
        return;
      }

      btn.disabled = false;
      btnRest.disabled = false;

      if(user.status === "active"){
        btn.className = "btn btn-outline btn-error flex-1";
        btn.innerText = "‚ùå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
        btnRest.className = user.resting ? "btn btn-warning flex-1" : "btn btn-outline flex-1";
        btnRest.innerText = user.resting ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å" : "‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢";
      }else if(user.status === "called" || user.status === "playing"){
        btn.className = "btn btn-disabled flex-1";
        btn.disabled = true;
        btn.innerText = "üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô/‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å";
        btnRest.className = "btn btn-disabled flex-1";
        btnRest.disabled = true;
      }else{
        btn.className = "btn btn-primary flex-1";
        btn.innerText = "‚úÖ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°";
        btnRest.className = "btn btn-outline flex-1";
        btnRest.innerText = "‡∏û‡∏±‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢";
      }
    }

    // -----------------------------
    // Pair UI
    // -----------------------------
    function renderPairUI(){
      const all = dashboard.all_players || [];

      const pairedBox = document.getElementById('pair-paired-box');
      const pairedName = document.getElementById('pair-paired-name');

      if(user.paired_with){
        pairedBox.classList.remove('hidden');
        const partner = all.find(x => x.id === user.paired_with);
        pairedName.innerText = partner ? partner.nickname : "‚Ä¶";
      }else{
        pairedBox.classList.add('hidden');
      }

      const outBox = document.getElementById('pair-outgoing-box');
      const outName = document.getElementById('pair-outgoing-name');
      if(user.pair_outgoing && !user.paired_with){
        outBox.classList.remove('hidden');
        const tgt = all.find(x => x.id === user.pair_outgoing);
        outName.innerText = tgt ? tgt.nickname : "‚Ä¶";
      }else{
        outBox.classList.add('hidden');
      }

      const form = document.getElementById('pair-request-form');
      if(user.status === "active" && !user.paired_with){
        form.classList.remove('hidden');
      }else{
        form.classList.add('hidden');
      }

      const sel = document.getElementById('partner-select');
      const currentVal = sel.value;
      sel.innerHTML = '<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô --</option>';
      all.filter(p => p.id !== user.id).forEach(p => {
        if(p.status === "active"){
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.innerText = p.nickname;
          sel.appendChild(opt);
        }
      });
      if(currentVal) sel.value = currentVal;

      const incWrap = document.getElementById('pair-incoming-list');
      const inc = user.pair_incoming || [];
      if(inc.length === 0){
        incWrap.innerHTML = `<div class="text-center text-gray-400 text-xs py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>`;
        return;
      }

      incWrap.innerHTML = inc.map(rid => {
        const p = all.find(x => x.id === rid);
        const name = p ? p.nickname : rid;
        return `
          <div class="flex justify-between items-center bg-gray-50 p-2 rounded border">
            <div class="text-xs font-bold text-gray-700 truncate">${escapeHtml(name)}</div>
            <div class="flex gap-1">
              <button class="btn btn-xs btn-success text-white" onclick="acceptPair('${rid}')">‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö</button>
              <button class="btn btn-xs btn-ghost text-red-500" onclick="declinePair('${rid}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // -----------------------------
    // Courts UI
    // -----------------------------
    function renderPlayerChip(p){
      const title = getTitleFromPlayer(p);
      const mmrTxt = p.unrank ? `Unrank (${p.calib_games ?? 0}/10)` : (p.mmr ?? "‚Äî");
      return `
        <button class="flex items-center gap-2 p-1 rounded hover:bg-gray-50 w-full text-left"
                onclick="openProfile('${p.id}')">
          <img src="${p.pictureUrl}" class="w-7 h-7 rounded-full"/>
          <div class="min-w-0">
            <div class="text-xs font-bold truncate max-w-[120px]">${escapeHtml(p.nickname)}</div>
            <div class="text-[11px] font-semibold text-gray-400 truncate">${escapeHtml(title)}</div>
          </div>
          <div class="ml-auto text-[11px] font-mono text-gray-500">${escapeHtml(mmrTxt)}</div>
        </button>
      `;
    }

    function renderCourts(){
      const cc = document.getElementById('courts-container');
      cc.innerHTML = "";

      const courts = dashboard.courts || {};
      const isStaff = (user.role === "super" || user.role === "mod");

      const manCourt = document.getElementById('man-court');
      manCourt.innerHTML = "";
      Object.keys(courts).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(cid=>{
        const opt = document.createElement('option');
        opt.value = cid;
        opt.innerText = `Court ${cid}`;
        manCourt.appendChild(opt);
      });

      Object.entries(courts).sort((a,b)=>parseInt(a[0])-parseInt(b[0])).forEach(([cid, m]) => {
        if(!m){
          cc.innerHTML += `
            <div class="p-4 border-2 border-dashed rounded text-center text-gray-400 text-sm">
              Court ${cid} ‡∏ß‡πà‡∏≤‡∏á
            </div>
          `;
          return;
        }

        const status = m.status;
        let rightBadge = "";
        if(status === "called"){
          rightBadge = `<span class="badge badge-warning">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô ${m.countdown_sec}s</span>`;
        }else{
          const min = Math.floor(m.elapsed_sec / 60);
          rightBadge = `<span class="badge badge-outline">${min} min</span>`;
        }

        const canEnd = isStaff || m.team_a_ids.includes(user.id) || m.team_b_ids.includes(user.id);

        cc.innerHTML += `
          <div class="card bg-white border shadow-sm p-3 card-soft">
            <div class="flex justify-between items-center mb-2">
              <div class="font-bold text-indigo-700">COURT ${cid}</div>
              <div class="flex gap-2 items-center">
                ${rightBadge}
              </div>
            </div>

            <div class="grid grid-cols-3 gap-2 items-start">
              <div class="space-y-1">
                <div class="mini-title">TEAM A</div>
                ${m.team_a.map(renderPlayerChip).join('')}
              </div>

              <div class="text-center pt-6">
                <div class="font-black text-red-500">VS</div>
              </div>

              <div class="space-y-1">
                <div class="mini-title">TEAM B</div>
                ${m.team_b.map(renderPlayerChip).join('')}
              </div>
            </div>

            <div class="mt-2 flex gap-2">
              ${canEnd ? `<button class="btn btn-sm btn-error text-white flex-1"
                      onclick="openFinishModal('${cid}')">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>` : ``}
              ${isStaff ? `<button class="btn btn-sm btn-outline flex-1"
                      onclick="cancelMatch('${cid}')">Cancel</button>` : ``}
            </div>
          </div>
        `;
      });
    }

    // -----------------------------
    // Queue + Resting UI (‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠ 7)
    // -----------------------------
    function renderQueue(){
      const q = dashboard.queue || [];
      document.getElementById('q-count').innerText = dashboard.queue_count ?? q.length;

      const all = dashboard.all_players || [];
      document.getElementById('queue-list').innerHTML = q.map((p, i) => {
        const title = getTitleFromPlayer(p);
        let pairTxt = "";
        if(p.paired_with){
          const partner = all.find(x => x.id === p.paired_with);
          if(partner) pairTxt = `<span class="badge badge-xs badge-outline ml-2 text-indigo-500">‡∏Ñ‡∏π‡πà: ${escapeHtml(partner.nickname)}</span>`;
        }
        return `
          <tr class="border-b">
            <td>
              <div class="flex items-center gap-2">
                <span class="font-bold text-gray-500">${i+1}.</span>
                <img src="${p.pictureUrl}" class="w-6 h-6 rounded-full"/>
                <button class="text-left" onclick="openProfile('${p.id}')">
                  <div class="text-sm font-bold">${escapeHtml(p.nickname)} ${pairTxt}</div>
                  <div class="text-[11px] font-semibold text-gray-400">${escapeHtml(title)}</div>
                </button>
              </div>
            </td>
            <td class="text-right">
              <span class="badge badge-ghost badge-sm">${p.wait_min ?? 0} min</span>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderResting(){
      const r = dashboard.resting || [];
      document.getElementById('r-count').innerText = dashboard.resting_count ?? r.length;

      document.getElementById('resting-list').innerHTML = r.length ? r.map((p, i) => {
        const title = getTitleFromPlayer(p);
        return `
          <tr class="border-b">
            <td>
              <div class="flex items-center gap-2">
                <span class="font-bold text-gray-400">${i+1}.</span>
                <img src="${p.pictureUrl}" class="w-6 h-6 rounded-full"/>
                <button class="text-left" onclick="openProfile('${p.id}')">
                  <div class="text-sm font-bold text-gray-600">${escapeHtml(p.nickname)}</div>
                  <div class="text-[11px] font-semibold text-gray-400">${escapeHtml(title)}</div>
                </button>
              </div>
            </td>
            <td class="text-right">
              <span class="badge badge-warning badge-sm">${p.wait_min ?? 0} min</span>
            </td>
          </tr>
        `;
      }).join('') : `<tr><td class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏û‡∏±‡∏Å</td></tr>`;
    }

    // -----------------------------
    // History UI (+/- MMR) ‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠ 3
    // -----------------------------
    function setHistoryMode(mode){
      historyMode = mode;
      document.getElementById('btn-hist-mine').classList.toggle('btn-primary', mode==='mine');
      document.getElementById('btn-hist-global').classList.toggle('btn-primary', mode==='global');
      renderHistoryCards();
    }

    function renderHistoryCards(){
      const wrap = document.getElementById('history-cards');
      if(!wrap || !dashboard) return;

      let list = dashboard.match_history || [];
      if(historyMode === "mine"){
        list = list.filter(m => {
          const a = (m.team_a||[]).map(x=>x.id);
          const b = (m.team_b||[]).map(x=>x.id);
          return a.includes(user.id) || b.includes(user.id);
        });
      }

      if(list.length === 0){
        wrap.innerHTML = `<div class="text-center text-gray-400 py-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
        return;
      }

      wrap.innerHTML = list.map(m => {
        const winner = m.winner_team;
        const aIds = (m.team_a||[]).map(x=>x.id);
        const bIds = (m.team_b||[]).map(x=>x.id);

        const youInA = aIds.includes(user.id);
        const youInB = bIds.includes(user.id);

        const mineTag = (historyMode==="mine")
          ? ((youInA && winner==="A") || (youInB && winner==="B")
              ? `<span class="badge badge-success text-white">YOU WIN</span>`
              : `<span class="badge badge-error text-white">YOU LOSE</span>`)
          : "";

        const leftWinTag  = (historyMode==="global" && winner==="A") ? `<span class="badge badge-success text-white">WIN</span>` : "";
        const rightWinTag = (historyMode==="global" && winner==="B") ? `<span class="badge badge-success text-white">WIN</span>` : "";

        const duration = (m.duration_min != null) ? `${m.duration_min} min` : "";
        const scoreLine = m.score_summary ? `<div class="px-4 pb-3 text-xs text-gray-600">${escapeHtml(m.score_summary)}</div>` : "";

        const snap = (m.mmr_snapshot || {});

        const teamBox = (team) => team.map(p => {
          const d = snap[p.id]?.delta ?? null;
          const dText = formatDelta(d);
          const dCls = deltaClass(d);
          return `
            <div class="flex items-center gap-2">
              <img src="${p.pictureUrl}" class="w-7 h-7 rounded-full"/>
              <div class="min-w-0">
                <div class="text-xs font-bold truncate max-w-[130px]">${escapeHtml(p.nickname)}</div>
                <div class="text-[11px] font-semibold text-gray-400 truncate">${escapeHtml(p.rank_title)}</div>
              </div>
              <div class="ml-auto text-[11px] ${dCls} font-mono">${dText}</div>
            </div>
          `;
        }).join('');

        return `
          <div class="card bg-white shadow-sm border card-soft">
            <div class="px-4 py-2 flex justify-between items-center text-[11px] text-gray-500 border-b">
              <div>${escapeHtml(m.date || '')}</div>
              <div class="flex items-center gap-2">
                ${duration ? `<span class="badge badge-ghost badge-sm">${duration}</span>` : ''}
                ${mineTag}
              </div>
            </div>

            <div class="p-3 grid grid-cols-3 gap-2 items-start">
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="mini-title">TEAM A</span>
                  ${leftWinTag}
                </div>
                ${teamBox(m.team_a || [])}
              </div>

              <div class="text-center pt-6">
                <div class="font-black text-red-500">VS</div>
              </div>

              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="mini-title">TEAM B</span>
                  ${rightWinTag}
                </div>
                ${teamBox(m.team_b || [])}
              </div>
            </div>

            ${scoreLine}
          </div>
        `;
      }).join('');
    }

    // -----------------------------
    // Leaderboard UI
    // -----------------------------
    function setLBMode(mode){
      lbMode = mode;
      document.getElementById('lb-mmr').classList.toggle('btn-primary', mode==='mmr');
      document.getElementById('lb-points').classList.toggle('btn-primary', mode==='points');
      document.getElementById('lb-wr').classList.toggle('btn-primary', mode==='winrate');

      const head = document.getElementById('lb-right-head');
      head.innerText = (mode==='mmr') ? "MMR" : (mode==='points' ? "‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏°" : "Winrate");
      renderLeaderboards();
    }

    function renderLeaderboards(){
      if(!dashboard) return;
      const lb = dashboard.leaderboard || {};
      const list = lb[lbMode] || [];
      const tbody = document.getElementById('lb-list');

      tbody.innerHTML = list.map((p, i) => {
        const title = getTitleFromPlayer(p);

        let right = "";
        if(lbMode === "mmr"){
          right = p.unrank ? "‚Äî" : (p.mmr ?? "‚Äî");
        }else if(lbMode === "points"){
          right = p.points_for ?? 0;
        }else{
          right = `${p.win_rate ?? 0}%`;
        }

        return `
          <tr>
            <td class="font-bold text-gray-500">${i+1}</td>
            <td>
              <div class="flex items-center gap-2">
                <div class="avatar"><div class="w-7 rounded-full"><img src="${p.pictureUrl}"></div></div>
                <button class="text-left" onclick="openProfile('${p.id}')">
                  <div class="text-sm font-bold">${escapeHtml(p.nickname)}</div>
                  <div class="text-[11px] font-semibold text-gray-400">${escapeHtml(title)}</div>
                </button>
              </div>
            </td>
            <td class="text-right font-mono font-bold text-indigo-600">${escapeHtml(right)}</td>
          </tr>
        `;
      }).join('');
    }

    // -----------------------------
    // Events render (latest first + delete) ‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠ 4 + 5
    // -----------------------------
    function formatDate(ts){
      if(!ts) return "-";
      const dt = new Date(ts * 1000);
      return dt.toLocaleString('th-TH', { year:'2-digit', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    function renderEvents(){
      const wrap = document.getElementById('events-list');
      const events = (dashboard.events || []);
      const isStaff = (user.role === "super" || user.role === "mod");

      wrap.innerHTML = events.map(e => {
        const status = e.status === "active"
          ? `<span class="badge badge-success text-white">ACTIVE</span>`
          : `<span class="badge badge-ghost">CLOSED</span>`;
        const rosterCount = (e.players || []).length;

        const delBtn = isStaff
          ? `<button class="btn btn-xs btn-ghost text-red-500" onclick="deleteEvent('${e.id}')">‡∏•‡∏ö</button>`
          : "";

        return `
          <div class="card bg-white shadow-sm border card-soft">
            <div class="p-3 flex justify-between items-start">
              <div>
                <div class="font-bold text-gray-700">${escapeHtml(e.name || "Event")}</div>
                <div class="text-xs text-gray-500">Created: ${formatDate(e.created_at)} | Players: ${rosterCount}</div>
              </div>
              <div class="flex items-center gap-2">
                ${status}
                ${delBtn}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // -----------------------------
    // Admin render (mod toggle stable) ‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠ 6
    // -----------------------------
    function renderAdminLists(){
      if(!dashboard) return;
      const isStaff = (user.role === "super" || user.role === "mod");
      if(!isStaff) return;

      const all = dashboard.all_players || [];
      const sys = dashboard.system || {};
      const am = sys.automatch || {};

      const amWrap = document.getElementById('automatch-list');
      amWrap.innerHTML = Object.keys(dashboard.courts||{}).sort((a,b)=>parseInt(a)-parseInt(b)).map(cid=>{
        const checked = !!am[cid];
        return `
          <label class="flex justify-between items-center bg-gray-50 p-2 rounded border">
            <div class="text-sm font-bold text-gray-700">Court ${cid}</div>
            <input type="checkbox" class="toggle toggle-sm toggle-primary" ${checked?'checked':''}
                   onchange="toggleAutoMatch('${cid}', this.checked)">
          </label>
        `;
      }).join('');

      const sel = document.getElementById('mmr-target');
      const cur = sel.value;
      sel.innerHTML = "";
      all.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.innerText = p.nickname;
        sel.appendChild(opt);
      });
      if(cur) sel.value = cur;

      if(user.role === "super"){
        document.getElementById('admin-user-list').innerHTML =
          all.map(p => `
            <tr>
              <td>${escapeHtml(p.nickname)}</td>
              <td class="text-right">
                <input type="checkbox" class="toggle toggle-xs toggle-success"
                  ${p.is_mod ? 'checked' : ''}
                  onchange="toggleMod('${p.id}', this.checked)">
              </td>
            </tr>
          `).join('');
      }
    }

    // -----------------------------
    // Finish modal
    // -----------------------------
    function openFinishModal(cid){
      selectedCid = cid;
      const m = (dashboard.courts||{})[cid];
      if(!m) return;

      document.getElementById('fin-cid').innerText = cid;
      document.getElementById('fin-team-a').innerHTML = (m.team_a||[]).map(p=>`
        <div class="flex items-center gap-2">
          <img src="${p.pictureUrl}" class="w-6 h-6 rounded-full"/>
          <div class="text-sm font-bold">${escapeHtml(p.nickname)}</div>
        </div>
      `).join('');
      document.getElementById('fin-team-b').innerHTML = (m.team_b||[]).map(p=>`
        <div class="flex items-center gap-2">
          <img src="${p.pictureUrl}" class="w-6 h-6 rounded-full"/>
          <div class="text-sm font-bold">${escapeHtml(p.nickname)}</div>
        </div>
      `).join('');

      const sys = dashboard.system || {};
      const pts = sys.match_points ?? 21;
      const bo = sys.match_bo ?? 1;

      document.getElementById('fin-rule-text').innerText = `‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ${pts} ‡πÅ‡∏ï‡πâ‡∏° | BO${bo} | ‡∏î‡∏¥‡∏ß‡∏™‡πå‡∏ñ‡∏∂‡∏á 30`;

      const wrap = document.getElementById('fin-sets');
      wrap.innerHTML = "";
      for(let i=1;i<=bo;i++){
        wrap.innerHTML += `
          <div class="flex items-center gap-2">
            <div class="badge badge-ghost">Set ${i}</div>
            <input id="set${i}a" type="number" class="input input-bordered input-sm w-20" placeholder="A">
            <span class="text-gray-400 font-bold">-</span>
            <input id="set${i}b" type="number" class="input input-bordered input-sm w-20" placeholder="B">
            <span class="text-xs text-gray-400 ml-auto">‡πÄ‡∏ä‡πà‡∏ô 21-19 / 30-29</span>
          </div>
        `;
      }

      safeShowModal('modal_finish');
    }

    async function submitResult(){
      const sys = dashboard.system || {};
      const bo = sys.match_bo ?? 1;

      const sets = [];
      for(let i=1;i<=bo;i++){
        const a = document.getElementById(`set${i}a`).value;
        const b = document.getElementById(`set${i}b`).value;
        sets.push({a: a, b: b});
      }

      const res = await fetch('/api/submit_result', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ courtId: selectedCid, userId: user.id, sets: sets })
      });
      const r = await res.json();
      if(r.error) return alert(r.error);

      safeCloseModal('modal_finish');
      await refresh();
    }

    // -----------------------------
    // Profile modal (‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠ 2 + 3)
    // -----------------------------
    async function openProfile(uid){
      const res = await fetch(`/api/player/profile/${uid}`);
      const p = await res.json();
      if(p.error) return alert(p.error);

      document.getElementById('pf-img').src = p.pictureUrl || "https://ui-avatars.com/api/?name=User";
      document.getElementById('pf-name').innerText = p.nickname || "User";
      document.getElementById('pf-title').innerText = p.rank_title || "";

      document.getElementById('pf-wr').innerText = `${p.stats?.set_win_rate ?? 0}%`;
      document.getElementById('pf-sets').innerText = `${p.stats?.set_wins ?? 0}-${p.stats?.set_losses ?? 0}`;
      document.getElementById('pf-pts').innerText = `${p.stats?.points_for ?? 0}-${p.stats?.points_against ?? 0}`;

      document.getElementById('pf-mwr').innerText = `${p.stats?.match_win_rate ?? 0}%`;
      document.getElementById('pf-mrec').innerText = `${p.stats?.match_wins ?? 0}-${p.stats?.match_losses ?? 0}`;
      document.getElementById('pf-mmr').innerText = p.unrank ? `Unrank (${p.calib_games ?? 0}/10)` : (p.mmr ?? "‚Äî");

      const wrap = document.getElementById('pf-last10');
      const last = p.last_10 || [];
      if(last.length === 0){
        wrap.innerHTML = `<div class="text-center text-gray-400 text-sm py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
      }else{
        wrap.innerHTML = last.map(m=>{
          const d = m.mmr_delta;
          const dText = formatDelta(d);
          const dCls = deltaClass(d);
          return `
            <div class="p-2 rounded border bg-gray-50">
              <div class="flex justify-between items-center">
                <div class="text-xs text-gray-600">${escapeHtml(m.date||'')} ‚Ä¢ Court ${escapeHtml(m.court_id||'')}</div>
                <div class="flex items-center gap-2">
                  <span class="badge ${m.result==='W'?'badge-success text-white':'badge-error text-white'}">${m.result}</span>
                  <span class="text-xs font-mono ${dCls}">${dText}</span>
                </div>
              </div>
              <div class="text-xs text-gray-500">${escapeHtml(m.score_summary||'')} ‚Ä¢ ${m.duration_min ?? '-'} min</div>
            </div>
          `;
        }).join('');
      }

      safeShowModal('modal_profile');
    }

    // -----------------------------
    // In-app notify when called
    // -----------------------------
    function maybeNotifyCalledMatch(sys){
      if(!sys.notify_enabled) return;
      if(!user.current_match_id) return;
      if(lastNotifiedMatchId === user.current_match_id) return;

      const courts = dashboard.courts || {};
      let found = null;
      for(const [cid, m] of Object.entries(courts)){
        if(m && m.id === user.current_match_id){
          found = m; break;
        }
      }
      if(!found) return;

      lastNotifiedMatchId = user.current_match_id;

      const namesA = (found.team_a||[]).map(x=>x.nickname).join(", ");
      const namesB = (found.team_b||[]).map(x=>x.nickname).join(", ");
      document.getElementById('notify-text').innerText = `Court ${found.court_id} | A: ${namesA}  VS  B: ${namesB} (‡∏•‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ)`;

      beep(3); buzz();
      safeShowModal('modal_notify');
    }

    // -----------------------------
    // Actions
    // -----------------------------
    async function toggleStatus(){
      if(user.status === "active"){
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å?\n* ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å reset")) return;
      }else if(user.status === "offline"){
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°?")) return;
      }

      const res = await fetch('/api/toggle_status', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function toggleRest(){
      const res = await fetch('/api/toggle_rest', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function toggleAutoRest(){
      const res = await fetch('/api/toggle_auto_rest', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function sendPairRequest(){
      const tid = document.getElementById('partner-select').value;
      if(!tid) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

      const res = await fetch('/api/pair/request', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, targetId: tid })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function cancelOutgoing(){
      const res = await fetch('/api/pair/cancel_outgoing', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function acceptPair(rid){
      const res = await fetch('/api/pair/accept', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, requesterId: rid })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function declinePair(rid){
      const res = await fetch('/api/pair/decline', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, requesterId: rid })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function cancelPair(){
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà?")) return;
      const res = await fetch('/api/pair/cancel_pair', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function requestMatchmake(){
      const res = await fetch('/api/matchmake', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id })
      });
      const r = await res.json();
      if(r.error) return alert(r.error);
      if(r.status === "waiting") return alert("‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ / ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà");
      if(r.status === "full") return alert("‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏£‡πå‡∏ó‡πÄ‡∏ï‡πá‡∏°");
      await refresh();
    }

    async function cancelMatch(cid){
      if(!confirm(`Cancel match Court ${cid}? (‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î MMR / ‡πÑ‡∏°‡πà‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)`)) return;
      const res = await fetch('/api/match/cancel', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, courtId: cid })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    // -----------------------------
    // Admin actions
    // -----------------------------
    async function startSession(){
      const pts = parseInt(document.getElementById('sess-pts').value, 10);
      const bo = parseInt(document.getElementById('sess-bo').value, 10);
      const notify = document.getElementById('sess-notify').checked;
      const name = document.getElementById('sess-name').value;

      const res = await fetch('/api/admin/toggle_session', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          action:"start",
          userId: user.id,
          match_points: pts,
          match_bo: bo,
          notify_enabled: notify,
          event_name: name
        })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      location.reload();
    }

    async function endSession(){
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏Å‡πä‡∏ß‡∏ô?")) return;
      const res = await fetch('/api/admin/toggle_session', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:"end", userId: user.id })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      location.reload();
    }

    async function changeCourtCount(delta){
      const cur = parseInt(document.getElementById('court-count-display').innerText, 10);
      const next = Math.max(1, Math.min(10, cur + delta));
      const res = await fetch('/api/admin/update_courts', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, count: next })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function toggleAutoMatch(cid, enabled){
      const res = await fetch('/api/court/automatch_toggle', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, courtId: cid, enabled: enabled })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    async function toggleMod(tid, val){
      const res = await fetch('/api/admin/manage_mod', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ requesterId: user.id, targetUserId: tid, action: val ? "promote" : "demote" })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh(); // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠ 6: refresh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö
    }

    async function setMMR(){
      const target = document.getElementById('mmr-target').value;
      const v = document.getElementById('mmr-value').value;
      if(!target || !v) return;

      const res = await fetch('/api/admin/set_mmr', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, targetUserId: target, newMmr: v })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    // -----------------------------
    // Events actions (‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠ 5)
    // -----------------------------
    async function createEvent(){
      const name = document.getElementById('evt-name').value.trim();
      if(!name) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ event ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
      const res = await fetch('/api/admin/create_event', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, name })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      document.getElementById('evt-name').value = "";
      await refresh();
      switchTab('events');
    }

    async function deleteEvent(eid){
      if(!confirm("‡∏•‡∏ö event ‡∏ô‡∏µ‡πâ?")) return;
      const res = await fetch('/api/admin/delete_event', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, eventId: eid })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      await refresh();
    }

    // -----------------------------
    // Manual match
    // -----------------------------
    function openManualMatch(){
      const active = (dashboard.all_players||[]).filter(p=>p.status==="active" && !p.resting && !p.current_match_id);
      document.querySelectorAll('.player-select').forEach(sel=>{
        sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
        active.forEach(p=>{
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.innerText = p.nickname;
          sel.appendChild(opt);
        });
      });

      safeShowModal('modal_manual_match');
    }

    async function submitManualMatch(){
      const courtId = document.getElementById('man-court').value;
      const p1 = document.getElementById('man-p1').value;
      const p2 = document.getElementById('man-p2').value;
      const p3 = document.getElementById('man-p3').value;
      const p4 = document.getElementById('man-p4').value;

      if(!p1||!p2||!p3||!p4) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
      if(new Set([p1,p2,p3,p4]).size !== 4) return alert("‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

      const res = await fetch('/api/matchmake/manual', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId: user.id, courtId: courtId, playerIds: [p1,p2,p3,p4] })
      });
      const r = await res.json();
      if(r.error) alert(r.error);
      safeCloseModal('modal_manual_match');
      await refresh();
    }

    // -----------------------------
    // Billing
    // -----------------------------
    async function openBillingModal(){
      await refresh();
      const events = dashboard.events || [];
      const select = document.getElementById('bill-event-select');
      select.innerHTML = '<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Event/Session --</option>';
      events.forEach(e=>{
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.innerText = `${e.name} (${formatDate(e.created_at)})`;
        select.appendChild(opt);
      });
      safeShowModal('modal_billing');
    }

    function loadBillPlayers(){
      const eid = document.getElementById('bill-event-select').value;
      const showAll = document.getElementById('bill-show-all').checked;
      const events = dashboard.events || [];
      const evt = events.find(x=>x.id===eid);
      const all = dashboard.all_players || [];

      const tbody = document.getElementById('bill-player-list');
      tbody.innerHTML = "";

      let candidates = [];
      if(showAll){
        candidates = all;
      }else if(evt){
        const roster = evt.players || [];
        candidates = all.filter(p => roster.includes(p.id));
      }

      const defHr = document.getElementById('bill-default-hr').value || 2;

      if(candidates.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏•‡∏≠‡∏á‡∏Å‡∏î "‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô")</td></tr>`;
      }else{
        candidates.forEach(u=>{
          tbody.innerHTML += `
            <tr class="bill-row" data-name="${escapeHtml(u.nickname)}">
              <td>
                <div class="flex items-center gap-2">
                  <img src="${u.pictureUrl}" class="w-6 h-6 rounded-full">
                  <div class="text-xs font-bold">${escapeHtml(u.nickname)}</div>
                  <button onclick="this.closest('tr').remove();calculateBill()" class="btn btn-xs btn-ghost text-red-400 rounded-full px-1">x</button>
                </div>
              </td>
              <td><input type="number" class="input input-bordered input-xs w-full bill-hr" value="${defHr}" min="0" oninput="calculateBill()"></td>
              <td><input type="number" class="input input-bordered input-xs w-full bill-min" value="0" min="0" step="5" oninput="calculateBill()"></td>
              <td class="text-right font-bold bill-price">0</td>
            </tr>
          `;
        });
      }
      calculateBill();
    }

    function applyDefaultTime(){
      const def = document.getElementById('bill-default-hr').value;
      document.querySelectorAll('.bill-hr').forEach(el => el.value = def);
      document.querySelectorAll('.bill-min').forEach(el => el.value = 0);
      calculateBill();
    }

    function calculateBill(){
      const totalCost = parseFloat(document.getElementById('bill-total-cost').value) || 0;
      const rows = document.querySelectorAll('.bill-row');

      let totalMinutesPool = 0;
      rows.forEach(row=>{
        const h = parseInt(row.querySelector('.bill-hr').value)||0;
        const m = parseInt(row.querySelector('.bill-min').value)||0;
        totalMinutesPool += (h*60)+m;
      });

      const costPerMin = totalMinutesPool > 0 ? (totalCost / totalMinutesPool) : 0;
      let grandTotal = 0;

      rows.forEach(row=>{
        const h = parseInt(row.querySelector('.bill-hr').value)||0;
        const m = parseInt(row.querySelector('.bill-min').value)||0;
        const myCost = Math.ceil(((h*60)+m) * costPerMin);
        row.querySelector('.bill-price').innerText = myCost;
        grandTotal += myCost;
      });

      document.getElementById('bill-grand-total').innerText = grandTotal;
    }

    function copyBillSummary(){
      const eid = document.getElementById('bill-event-select').value;
      const events = dashboard.events || [];
      const evt = events.find(x=>x.id===eid);
      const evtName = evt ? evt.name : "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏Å‡πä‡∏ß‡∏ô";

      let txt = `üí∏ ${evtName}\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${document.getElementById('bill-total-cost').value} ‡∏ö‡∏≤‡∏ó\n------------------\n`;
      document.querySelectorAll('.bill-row').forEach(row=>{
        const name = row.dataset.name;
        const price = row.querySelector('.bill-price').innerText;
        const h = row.querySelector('.bill-hr').value;
        const m = row.querySelector('.bill-min').value;
        txt += `${name} (${m>0?`${h}‡∏ä‡∏°.${m}‡∏ô.`:`${h}‡∏ä‡∏°.`}) = ${price}.- \n`;
      });
      txt += `------------------\n‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏à‡πä‡∏∞ üòò`;

      navigator.clipboard.writeText(txt).then(()=> alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß!"));
    }

    // start
    main();
  </script>
</body>
</html>
