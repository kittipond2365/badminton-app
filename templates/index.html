<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>izesquad</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>var vConsole = new VConsole();</script>
</head>
<body class="bg-slate-100 min-h-screen pb-24">

    <div class="navbar bg-white shadow-sm px-4 sticky top-0 z-50">
        <div class="flex-1">
            <span class="text-xl font-black text-indigo-600 italic">izesquad <i class="fa-solid fa-bolt text-yellow-400"></i></span>
        </div>
        <div class="flex-none gap-2">
            <button id="btn-bill" onclick="openBillingModal()" class="btn btn-circle btn-ghost text-green-600 hidden">
                <i class="fa-solid fa-file-invoice-dollar text-xl"></i>
            </button>

            <div class="text-right">
                <div class="text-[10px] text-gray-500">MMR</div>
                <div class="font-bold text-indigo-600" id="my-mmr">...</div>
            </div>
            <div class="avatar">
                <div class="w-10 rounded-full ring ring-indigo-500 ring-offset-2">
                    <img id="my-img" src="https://ui-avatars.com/api/?name=User" />
                </div>
            </div>
        </div>
    </div>

    <div class="px-2 mt-3">
        <div role="tablist" class="tabs tabs-boxed bg-white shadow-sm font-bold">
            <a role="tab" class="tab tab-active" onclick="switchTab('live', this)">‡∏™‡∏ô‡∏≤‡∏°</a>
            <a role="tab" class="tab" onclick="switchTab('stats', this)">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</a>
            <a role="tab" class="tab" onclick="switchTab('rank', this)">Rank</a>
            <a role="tab" class="tab" onclick="switchTab('events', this)">Events</a>
        </div>
    </div>

    <div id="tab-live" class="p-4 max-w-md mx-auto fade-in">
        <div class="card bg-white shadow-md mb-4 border-l-4 border-indigo-500">
            <div class="card-body p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status-badge" class="badge">...</span></span>
                    <span id="my-rank-text" class="text-xs font-bold text-gray-400">...</span>
                </div>
                <button id="btn-checkin" onclick="toggleStatus()" class="btn btn-indigo w-full">Loading...</button>
            </div>
        </div>
        <div id="courts-container" class="space-y-3 mb-6"></div>
        <div id="staff-controls" class="hidden mb-6">
            <button onclick="matchmake()" class="btn btn-neutral w-full shadow-lg"><i class="fa-solid fa-shuffle"></i> ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="bg-gray-50 px-4 py-2 border-b font-bold text-gray-600 flex justify-between">
                <span>‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏•‡πà‡∏ô</span><span id="q-count" class="badge badge-neutral">0</span>
            </div>
            <table class="table table-sm"><tbody id="queue-list"></tbody></table>
        </div>
    </div>

    <div id="tab-stats" class="p-4 max-w-md mx-auto hidden">
        <div class="card bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-xl mb-4">
            <div class="card-body p-5 text-center">
                <h2 class="text-lg font-bold opacity-80">WIN RATE</h2>
                <div class="text-5xl font-black my-2" id="st-wr">0%</div>
                <div class="flex justify-center gap-4 text-sm opacity-90">
                    <span>üèÜ Total Matches: <b id="st-total">0</b></span>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-white p-3 rounded-xl shadow-sm border border-orange-100">
                <div class="text-xs text-gray-400 mb-1">üî• Win Streak</div>
                <div class="text-xl font-bold text-gray-700" id="st-streak">0</div>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border border-green-100">
                <div class="text-xs text-gray-400 mb-1">ü§ù Best Partner</div>
                <div class="text-sm font-bold text-green-600 truncate" id="st-partner">-</div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-3 border-l-4 border-red-400">
            <div class="text-xs text-gray-400 mb-1">üòà Nemesis (‡πÅ‡∏û‡πâ‡∏ó‡∏≤‡∏á)</div>
            <div class="text-lg font-bold text-red-600" id="st-nemesis">-</div>
        </div>
    </div>

    <div id="tab-rank" class="p-4 max-w-md mx-auto hidden">
        <div class="overflow-x-auto bg-white rounded-xl shadow-sm">
            <table class="table">
                <thead><tr class="bg-gray-100"><th>#</th><th>Player</th><th class="text-right">MMR</th></tr></thead>
                <tbody id="lb-list"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-events" class="p-4 max-w-md mx-auto hidden">
        <div class="staff-only hidden mb-4 p-4 bg-white rounded shadow">
            <h3 class="font-bold text-sm mb-2">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Event ‡πÉ‡∏´‡∏°‡πà</h3>
            <input id="evt-name" class="input input-bordered input-sm w-full mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πä‡∏ß‡∏ô">
            <input id="evt-time" type="datetime-local" class="input input-bordered input-sm w-full mb-2">
            <button onclick="submitNewEvent()" class="btn btn-primary btn-sm w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button>
        </div>
        <h3 class="font-bold text-gray-500 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πä‡∏ß‡∏ô‡πÅ‡∏ö‡∏î</h3>
        <div id="events-list" class="space-y-4"></div>
    </div>

    <dialog id="modal_billing" class="modal">
        <div class="modal-box w-11/12 max-w-2xl">
            <h3 class="font-bold text-lg mb-4"><i class="fa-solid fa-calculator text-green-600"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Å‡πä‡∏ß‡∏ô</h3>
            
            <div class="grid grid-cols-1 gap-3 mb-4 bg-gray-50 p-3 rounded-lg border">
                <div>
                    <label class="label-text font-bold">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Event</label>
                    <select id="bill-event-select" class="select select-bordered select-sm w-full" onchange="loadBillPlayers()">
                        <option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="label-text font-bold">2. ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
                        <input id="bill-total-cost" type="number" class="input input-bordered input-sm w-full" placeholder="2500" oninput="calculateBill()">
                    </div>
                    <div>
                        <label class="label-text font-bold">3. ‡πÄ‡∏ß‡∏•‡∏≤ Default (‡∏ä‡∏°.)</label>
                        <input id="bill-default-hr" type="number" class="input input-bordered input-sm w-full" value="2" oninput="applyDefaultTime()">
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto max-h-64 mb-4 border rounded">
                <table class="table table-xs table-pin-rows">
                    <thead>
                        <tr class="bg-gray-200">
                            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th class="w-16">‡∏ä‡∏°.</th>
                            <th class="w-16">‡∏ô‡∏≤‡∏ó‡∏µ</th>
                            <th class="text-right">‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                        </tr>
                    </thead>
                    <tbody id="bill-player-list">
                        </tbody>
                </table>
            </div>

            <div class="flex justify-between items-center bg-green-100 p-3 rounded mb-4">
                <span class="font-bold text-green-800">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ:</span>
                <span id="bill-grand-total" class="font-black text-xl text-green-800">0</span>
            </div>

            <div class="modal-action">
                <button class="btn btn-ghost" onclick="document.getElementById('modal_billing').close()">‡∏õ‡∏¥‡∏î</button>
                <button class="btn btn-success text-white" onclick="copyBillSummary()"><i class="fa-regular fa-copy"></i> Copy ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <dialog id="modal_finish" class="modal">
        <div class="modal-box text-center">
            <h3 class="font-bold text-lg">‡∏à‡∏ö‡πÄ‡∏Å‡∏° Court <span id="fin-cid"></span></h3>
            <div class="flex gap-2 justify-center mt-4">
                <button onclick="submitRes('A')" class="btn btn-primary flex-1">Team A ‡∏ä‡∏ô‡∏∞</button>
                <button onclick="submitRes('B')" class="btn btn-error text-white flex-1">Team B ‡∏ä‡∏ô‡∏∞</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <dialog id="modal_edit_mmr" class="modal">
        <div class="modal-box">
            <h3 class="font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç MMR</h3>
            <p class="text-sm text-gray-500 mb-2" id="edit-target-name"></p>
            <input type="number" id="edit-new-mmr" class="input input-bordered w-full" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà">
            <div class="modal-action">
                <button class="btn btn-ghost" onclick="document.getElementById('modal_edit_mmr').close()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-primary" onclick="saveMMR()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </dialog>

    <script>
        const LIFF_ID = "2009064792-6RT6YKWO";
        let user = null, selectedCid = null, editTargetId = null;
        let globalEvents = []; // ‡πÄ‡∏Å‡πá‡∏ö Event ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô

        function switchTab(t, btn) {
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('tab-active'));
            if(btn) btn.classList.add('tab-active');
            ['live','stats','rank','events'].forEach(x => document.getElementById('tab-'+x).classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
        }

        async function main() {
            if (location.hostname.includes("localhost")) {
                await apiLogin("U1cf933e3a1559608c50c0456f6583dc9", "Admin Pond", "https://ui-avatars.com/api/?name=A");
            } else {
                try {
                    await liff.init({liffId: LIFF_ID});
                    if(!liff.isLoggedIn()) { liff.login(); return; }
                    const p = await liff.getProfile();
                    await apiLogin(p.userId, p.displayName, p.pictureUrl);
                } catch(e) { alert(e); }
            }
        }

        async function apiLogin(uid, name, pic) {
            const res = await fetch('/api/login', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({userId:uid, displayName:name, pictureUrl:pic})
            });
            user = await res.json();
            renderUI();
            refresh();
            setInterval(refresh, 5000);
        }

        function renderUI() {
            document.getElementById('my-img').src = user.pictureUrl;
            document.getElementById('my-mmr').innerText = user.mmr;
            document.getElementById('my-rank-text').innerText = user.rank_title;
            
            const s = user.stats;
            document.getElementById('st-wr').innerText = s.win_rate + "%";
            document.getElementById('st-total').innerText = s.total;
            document.getElementById('st-streak').innerText = s.streak;
            document.getElementById('st-partner').innerText = s.best_partner;
            document.getElementById('st-nemesis').innerText = s.nemesis;

            if(user.role === 'super' || user.role === 'mod') {
                document.querySelectorAll('.staff-only').forEach(e=>e.classList.remove('hidden'));
                document.getElementById('staff-controls').classList.remove('hidden');
                document.getElementById('btn-bill').classList.remove('hidden'); // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏° Bill
            }

            const btn = document.getElementById('btn-checkin');
            const badge = document.getElementById('status-badge');
            if (user.status === 'active') {
                btn.innerText = "‚ùå ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å"; btn.className = "btn btn-outline btn-error w-full";
                badge.innerText = "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß"; badge.className = "badge badge-success text-white";
            } else if (user.status === 'playing') {
                btn.innerText = "üè∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô"; btn.disabled = true; btn.className = "btn btn-disabled w-full";
                badge.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô"; badge.className = "badge badge-warning";
            } else {
                btn.innerText = "‚úÖ ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°"; btn.className = "btn btn-primary w-full"; btn.disabled = false;
                badge.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤"; badge.className = "badge badge-ghost";
            }
        }

        async function refresh() {
            const d = await(await fetch('/api/get_dashboard')).json();
            globalEvents = d.events; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô

            // Live Courts
            const cc = document.getElementById('courts-container'); cc.innerHTML = '';
            const isStaff = (user.role === 'super' || user.role === 'mod');
            for(const [cid, m] of Object.entries(d.courts)) {
                if(m) {
                    const min = Math.floor(m.elapsed/60);
                    cc.innerHTML += `
                    <div class="card bg-white border border-indigo-100 shadow-sm p-3">
                        <div class="flex justify-between text-indigo-700 font-bold mb-2">
                            <span>COURT ${cid}</span><span class="badge badge-outline">${min} min</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="w-[45%] text-right truncate font-medium">${m.team_a.join('<br>')}</div>
                            <div class="font-bold text-red-500">VS</div>
                            <div class="w-[45%] text-left truncate font-medium">${m.team_b.join('<br>')}</div>
                        </div>
                        ${isStaff ? `<button onclick="selectedCid=${cid};document.getElementById('modal_finish').showModal();document.getElementById('fin-cid').innerText=${cid}" class="btn btn-xs btn-error text-white w-full mt-2">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>` : ''}
                    </div>`;
                } else {
                    cc.innerHTML += `<div class="p-4 border-2 border-dashed rounded text-center text-gray-400 text-sm">Court ${cid} ‡∏ß‡πà‡∏≤‡∏á</div>`;
                }
            }

            // Queue & Rank
            document.getElementById('q-count').innerText = d.queue_count;
            document.getElementById('queue-list').innerHTML = d.queue.map((p,i) => `<tr class="border-b"><td>${i+1}. ${p.nickname}</td><td class="text-right"><span class="badge badge-ghost badge-xs">${p.rank_title}</span></td></tr>`).join('');
            document.getElementById('lb-list').innerHTML = d.leaderboard.map((p,i) => `<tr><td class="font-bold text-gray-500">${i+1}</td><td><div class="flex flex-col"><div class="flex items-center gap-2"><div class="avatar"><div class="w-6 rounded-full"><img src="${p.pictureUrl}"></div></div><span class="text-sm font-bold">${p.nickname}</span></div><span class="text-[10px] text-gray-400 ml-8">${p.rank_title}</span></div></td><td class="text-right"><div class="font-mono font-bold text-indigo-600">${p.mmr}</div>${isStaff ? `<button onclick="openEditMMR('${p.id}', '${p.nickname}', ${p.mmr})" class="btn btn-xs btn-ghost text-gray-400"><i class="fa-solid fa-pen"></i></button>` : ''}</td></tr>`).join('');
            
            // Events
            document.getElementById('events-list').innerHTML = d.events.map(e => {
                const amIJoined = e.players.includes(user.id); // e.players is list of IDs
                return `
                <div class="card bg-white border border-gray-200 shadow-sm p-4">
                    <div class="flex justify-between items-start">
                        <div><h4 class="font-bold text-lg text-indigo-900">${e.name}</h4><div class="text-sm text-gray-500 mb-2"><i class="fa-regular fa-clock"></i> ${formatDate(e.datetime)}</div></div>
                        ${isStaff ? `<button onclick="deleteEvent('${e.id}')" class="btn btn-xs btn-circle btn-ghost text-red-400">üóë</button>` : ''}
                    </div>
                    <div class="flex -space-x-2 overflow-hidden py-2 mb-2">
                        ${e.joined_users.length > 0 ? e.joined_users.map(u => `<img class="inline-block h-8 w-8 rounded-full ring-2 ring-white" src="${u.pictureUrl}" />`).join('') : '<span class="text-xs text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠</span>'}
                        ${e.joined_users.length > 0 ? `<span class="text-xs text-gray-500 self-center ml-3">‡∏£‡∏ß‡∏° ${e.joined_users.length} ‡∏Ñ‡∏ô</span>` : ''}
                    </div>
                    <button onclick="toggleEventJoin('${e.id}')" class="btn btn-sm w-full ${amIJoined ? 'btn-error btn-outline' : 'btn-success text-white'}">${amIJoined ? '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'üôã‚Äç‚ôÇÔ∏è ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢!'}</button>
                </div>
            `}).join('');
        }

        // --- BILLING LOGIC (NEW) ---
        function openBillingModal() {
            const select = document.getElementById('bill-event-select');
            select.innerHTML = '<option disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>';
            globalEvents.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.innerText = `${e.name} (${formatDate(e.datetime)})`;
                select.appendChild(opt);
            });
            document.getElementById('modal_billing').showModal();
        }

        function loadBillPlayers() {
            const eid = document.getElementById('bill-event-select').value;
            const evt = globalEvents.find(e => e.id === eid);
            const tbody = document.getElementById('bill-player-list');
            const defHr = document.getElementById('bill-default-hr').value || 2;
            tbody.innerHTML = '';
            
            if(evt && evt.joined_users) {
                evt.joined_users.forEach(u => {
                    tbody.innerHTML += `
                    <tr class="bill-row" data-id="${u.id}" data-name="${u.nickname}">
                        <td><div class="flex items-center gap-2"><img src="${u.pictureUrl}" class="w-6 h-6 rounded-full text-[10px]">${u.nickname}</div></td>
                        <td><input type="number" class="input input-bordered input-xs w-full bill-hr" value="${defHr}" min="0" oninput="calculateBill()"></td>
                        <td><input type="number" class="input input-bordered input-xs w-full bill-min" value="0" min="0" step="5" oninput="calculateBill()"></td>
                        <td class="text-right font-bold bill-price">0</td>
                    </tr>`;
                });
            }
            calculateBill();
        }

        function applyDefaultTime() {
            const def = document.getElementById('bill-default-hr').value;
            document.querySelectorAll('.bill-hr').forEach(el => el.value = def);
            document.querySelectorAll('.bill-min').forEach(el => el.value = 0);
            calculateBill();
        }

        function calculateBill() {
            const totalCost = parseFloat(document.getElementById('bill-total-cost').value) || 0;
            const rows = document.querySelectorAll('.bill-row');
            let totalMinutesPool = 0;

            // 1. Calculate Total Minutes of Everyone
            rows.forEach(row => {
                const h = parseInt(row.querySelector('.bill-hr').value) || 0;
                const m = parseInt(row.querySelector('.bill-min').value) || 0;
                totalMinutesPool += (h * 60) + m;
            });

            // 2. Calculate Cost Per Minute
            const costPerMin = totalMinutesPool > 0 ? (totalCost / totalMinutesPool) : 0;
            let grandTotal = 0;

            // 3. Update Each Row
            rows.forEach(row => {
                const h = parseInt(row.querySelector('.bill-hr').value) || 0;
                const m = parseInt(row.querySelector('.bill-min').value) || 0;
                const myMins = (h * 60) + m;
                const myCost = Math.ceil(myMins * costPerMin); // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏Ç‡∏∂‡πâ‡∏ô
                row.querySelector('.bill-price').innerText = myCost;
                grandTotal += myCost;
            });

            document.getElementById('bill-grand-total').innerText = grandTotal;
        }

        function copyBillSummary() {
            const eid = document.getElementById('bill-event-select').value;
            const evt = globalEvents.find(e => e.id === eid);
            if(!evt) return;

            const totalCost = document.getElementById('bill-total-cost').value;
            let txt = `üí∏ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏Å‡πä‡∏ß‡∏ô: ${evt.name}\nüìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDate(evt.datetime)}\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${totalCost} ‡∏ö‡∏≤‡∏ó\n------------------\n`;
            
            document.querySelectorAll('.bill-row').forEach(row => {
                const name = row.dataset.name;
                const price = row.querySelector('.bill-price').innerText;
                const h = row.querySelector('.bill-hr').value;
                const m = row.querySelector('.bill-min').value;
                const timeTxt = m > 0 ? `${h}‡∏ä‡∏°.${m}‡∏ô.` : `${h}‡∏ä‡∏°.`;
                
                txt += `${name} (${timeTxt}) = ${price}.- \n`;
            });
            txt += `------------------\n‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏à‡πä‡∏∞ üòò`;

            navigator.clipboard.writeText(txt).then(() => alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡πÑ‡∏õ‡πÅ‡∏õ‡∏∞‡πÉ‡∏ô LINE ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'));
            
            // Optional: Save to backend
            // fetch('/api/billing/save', ...)
        }

        // --- STANDARD ACTIONS ---
        async function toggleStatus() { await fetch('/api/toggle_status', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id})}); apiLogin(user.id, user.nickname, user.pictureUrl); }
        async function matchmake() { const r=await(await fetch('/api/matchmake',{method:'POST'})).json(); if(r.status!=='matched') alert(r.status==='full'?'‡πÄ‡∏ï‡πá‡∏°':'‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); else refresh(); }
        async function submitRes(w) { await fetch('/api/submit_result', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({courtId:selectedCid, winner:w})}); document.getElementById('modal_finish').close(); refresh(); }
        async function submitNewEvent() {
            const n=document.getElementById('evt-name').value, t=document.getElementById('evt-time').value;
            if(!n||!t) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            await fetch('/api/event/create', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n, datetime:t})});
            document.getElementById('evt-name').value=''; document.getElementById('evt-time').value=''; refresh();
        }
        async function deleteEvent(eid) { if(confirm('‡∏•‡∏ö‡∏ô‡∏∞?')) await fetch('/api/event/delete', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId:eid})}); refresh(); }
        async function toggleEventJoin(eid) { await fetch('/api/event/join_toggle', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId:eid, userId:user.id})}); refresh(); }
        function openEditMMR(uid, n, m) { editTargetId=uid; document.getElementById('edit-target-name').innerText=`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á: ${n}`; document.getElementById('edit-new-mmr').value=m; document.getElementById('modal_edit_mmr').showModal(); }
        async function saveMMR() { const v=document.getElementById('edit-new-mmr').value; if(!v) return; await fetch('/api/admin/set_mmr', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({targetUserId:editTargetId, newMmr:v})}); document.getElementById('modal_edit_mmr').close(); refresh(); }
        function formatDate(dt) { return new Date(dt).toLocaleDateString('th-TH', {weekday:'short', day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}); }
        
        main();
    </script>
</body>
</html>